---
title: "ScallopData"
author: "Dylan Titmuss"
date: "12/9/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Load packages
```{r setup}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggmap)
library(sf)
library(numform)
library(sp)
library(viridis)
```

## Load scallop data
```{r}
setwd("~/Desktop/Repos/ScallopRSA2021")

may <- read.csv("./data/MayScallopData_12-9-21.csv") %>%
  mutate(Site = str_extract(ScallopID, "^.{3}(?=_)"))

# check number of scallops per site
table(may$Site)
```

## Plot size parameters
```{r}
ggplot(may, aes(x = Site, y = ShellHt_mm)) +
  geom_boxplot() +
  labs(y = "Shell Height (mm)", title = "Scallop Shell Heights by Site") +
  theme_bw()

ggplot(may, aes(x = Site, y = ShellWt_g)) +
  geom_boxplot() +
  labs(y = "Shell Weight (g)", title = "Scallop Shell Weights by Site") +
  theme_bw()

ggplot(may, aes(x = Site, y = ShellWt_g / ShellHt_mm)) +
  geom_boxplot() +
  labs(y = "Ratio of Shell Weight to Shell Height (g/mm)", title = "\"Linear Density\" of Scallop Shells") +
  theme_bw()
```

## Register Google API key
```{r, include = FALSE}
register_google(key = "AIzaSyBvvS_nvTml09h56OWd0Oniktayi0L8WDU")
```

## Load satellite map
```{r}
GB_map <- get_map(c(-68.5247, 40.8155), maptype = "satellite", zoom = 7, source = "google")

map <- ggmap(GB_map) +
  coord_sf(crs = st_crs(4326)) +
  xlim(c(-71, -65.5)) +
  scale_y_continuous(breaks = c(40, 41, 42), limits = c(39.5, 42.5)) +
  theme(axis.title = element_blank())

map
```

## Load station data & convert coordinates
```{r}
stations <- read.csv("./data/CruiseTrack_October.csv")
str(stations)

chd <- substr(stations$Lat, 3, 4)[1]

# convert latitude from DM to DD
Lat_split <- str_split_fixed(stations$Lat, chd, 2) %>%
  as.data.frame()
Lat_split$V2 <- str_remove_all(Lat_split$V2, pattern = "'") %>%
  as.numeric()
Lat_split$V2 <- Lat_split$V2/60
Lat_split$V1 <- as.numeric(Lat_split$V1)

stations$Lat <- Lat_split$V1 + Lat_split$V2

# convert longitude from DM to DD
Long_split <- str_split_fixed(stations$Long, chd, 2) %>%
  as.data.frame()
Long_split$V2 <- str_remove_all(Long_split$V2, pattern = "'") %>%
  as.numeric()
Long_split$V2 <- Long_split$V2/60
Long_split$V1 <- as.numeric(Long_split$V1)

stations$Long <- -(Long_split$V1 + Long_split$V2)
```

## Add scallop data to stations df
```{r}
maySites <- may %>%
  rename(Station = Site)
  group_by(Station) %>%
  summarize(ShellHt_mm = mean(ShellHt_mm, na.rm = TRUE), ShellWt_g = mean(ShellWt_g, na.rm = TRUE)) %>%
  mutate(LinDensity = ShellWt_g / ShellHt_mm)
  
stations <- stations %>%
  mutate(Station = as.character(f_pad_zero(Station))) # add leading zeros to station numbers

stations <- right_join(stations, maySites, by = "Station")
```

## Add station points to map
```{r}
stations_SPDF <- SpatialPointsDataFrame(coords = stations[ , c("Long","Lat")],
                                        data = stations[ ,c("Long", "Lat", "Station", "Tow", "ShellHt_mm",
                                                            "ShellWt_g", "LinDensity")],
                                        proj4string = CRS("+init=epsg:4326"))

stations_sf <- st_as_sf(stations_SPDF)
stations_sf <- st_transform(stations_sf, crs = 4326)

heights <- map +
  geom_sf(data = stations_sf, aes(size = ShellHt_mm, fill = Tow, shape = Tow), inherit.aes = FALSE) +
  geom_sf_text(data = stations_sf, aes(label = Station, colour = Tow), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_size_continuous(range = c(2, 7), name = "Mean Shell Height (mm)") +
  scale_fill_manual(values = c("white", "black"), guide = "none") +
  scale_shape_manual(values = c(21, 22), guide = "none") +
  scale_colour_manual(values = c("white", "black"), guide = "none") +
  labs(title = "Variation in Scallop Shell Size Across Georges Bank") +
  coord_sf(crs = st_crs(4326)) +
  theme(plot.title = element_text(size = 17, face = "bold", hjust = 0.5),
        axis.text = element_text(size = 13),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12))

heights

densities <- map +
  geom_sf(data = stations_sf, aes(size = LinDensity, fill = Tow, shape = Tow), inherit.aes = FALSE) +
  geom_sf_text(data = stations_sf, aes(label = Station, colour = Tow), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_size_continuous(range = c(2.5, 7.5), name = "Mean Ratio of Shell Weight\nto Shell Height (g/mm)", guide = guide_legend(override.aes = list(shape = 22, fill = "white"))) +
  scale_fill_manual(values = c("white", "black"), guide = "none") +
  scale_shape_manual(values = c(22, 21), guide = "none") +
  scale_colour_manual(values = c("white", "black"), guide = "none") +
  labs(title = "Variation in Scallop Shell \"Linear Density\" Across Georges Bank") +
  coord_sf(crs = st_crs(4326)) +
  theme(plot.title = element_text(size = 17, face = "bold", hjust = 0.5),
        axis.text = element_text(size = 13),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text = element_text(size = 12))

densities
```
