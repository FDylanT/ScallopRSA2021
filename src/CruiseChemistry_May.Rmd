---
title: "MayCruiseChemistry"
author: "Dylan Titmuss"
date: "1/19/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script visualizes the chemistry data from the May RSA cruise.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")

library(tidyverse)
library(sf)
library(numform)
library(sp)
library(viridis)
library(gstat)
library(seacarb)
```

## Load data
```{r}
setwd("~/Desktop/Repos/ScallopRSA2021")

may <- read.csv("./data/MayCruiseData.csv") %>%
  rename(Lat = Latitude_degrees_start,
         Long = Longitude_degrees_start,
         Depth = Depth_m_CTD,
         Temp = Temperature) %>%
  select(Station, Cast, Lat, Long, Depth, Temp, Pressure, SeaPressure, Salinity, 
         DIC, TA) %>%
  mutate(Station = as.character(f_pad_zero(Station))) # add leading zeros to station numbers
```

## Fill in missing temps
```{r}
may <- may %>%
  mutate(Temp = ifelse(Station == "006", mean(c(Temp[Station == "005"],
                                                Temp[Station == "007"])), Temp),
         Temp = ifelse(Station == "012", 0.271 * Temp[Station == "011"] +
                                         0.305 * Temp[Station == "013"] +
                                         0.203 * Temp[Station == "014"] +
                                         0.221 * Temp[Station == "091"], Temp),
         Temp = ifelse(Station == "016", 0.333 * Temp[Station == "015"] +
                                         0.666 * Temp[Station == "017"], Temp),
         Temp = ifelse(Station == "022", 0.333 * Temp[Station == "023"] +
                                         0.666 * Temp[Station == "019"], Temp),
         Temp = ifelse(Station == "030", mean(c(Temp[Station == "029"],
                                                Temp[Station == "031"])), Temp),
         Temp = ifelse(Station == "081", 0.179 * Temp[Station == "077"] +
                                         0.220 * Temp[Station == "080"] +
                                         0.238 * Temp[Station == "082"] +
                                         0.204 * Temp[Station == "083"] +
                                         0.159 * Temp[Station == "084"], Temp),
         Temp = ifelse(Station == "111", 0.304 * Temp[Station == "107"] +
                                         0.348 * Temp[Station == "108"] +
                                         0.348 * Temp[Station == "112"], Temp),
         Temp = ifelse(Station == "114", 0.205 * Temp[Station == "107"] +
                                         0.178 * Temp[Station == "108"] +
                                         0.230 * Temp[Station == "112"] +
                                         0.387 * Temp[Station == "113"], Temp))

may <- may %>%
  mutate(Temp = ifelse(Station == "006", mean(c(Temp[Station == "005"],
                                                Temp[Station == "007"])), Temp),
         Temp = ifelse(Station == "012", 0.271 * Temp[Station == "011"] +
                                         0.305 * Temp[Station == "013"] +
                                         0.203 * Temp[Station == "014"] +
                                         0.221 * Temp[Station == "091"], Temp),
         Temp = ifelse(Station == "016", 0.333 * Temp[Station == "015"] +
                                         0.666 * Temp[Station == "017"], Temp),
         Temp = ifelse(Station == "022", 0.333 * Temp[Station == "023"] +
                                         0.666 * Temp[Station == "019"], Temp),
         Temp = ifelse(Station == "030", mean(c(Temp[Station == "029"],
                                                Temp[Station == "031"])), Temp),
         Temp = ifelse(Station == "081", 0.179 * Temp[Station == "077"] +
                                         0.220 * Temp[Station == "080"] +
                                         0.238 * Temp[Station == "082"] +
                                         0.204 * Temp[Station == "083"] +
                                         0.159 * Temp[Station == "084"], Temp),
         Temp = ifelse(Station == "111", 0.304 * Temp[Station == "107"] +
                                         0.348 * Temp[Station == "108"] +
                                         0.348 * Temp[Station == "112"], Temp),
         Temp = ifelse(Station == "114", 0.205 * Temp[Station == "107"] +
                                         0.178 * Temp[Station == "108"] +
                                         0.230 * Temp[Station == "112"] +
                                         0.387 * Temp[Station == "113"], Temp))
```

## Calculate carbon system parameters & density
```{r}
for(i in which(is.na(may$SeaPressure))) {
    may$SeaPressure[i] <- may$Depth[i] # substitude depth for sites without sea pressure
    may$Pressure[i] <- may$SeaPressure[i] + 10.1325 # calculate surface pressure from depth
}

mayCarb <- carb(flag = 15,                               # 15 = ALK & DIC given
                var1 = may$TA / 10^6,                    # in mol/kg
                var2 = may$DIC / 10^6,                   # in mol/kg
                S = may$Salinity,
                T = may$Temp,                            # in deg C
                Patm = may$Pressure * 0.098692326671601, # in atm
                P = may$SeaPressure / 10,                # in bar
                k1k2 = "l",                              # l = Lueker et al. (2000)
                                                         # kf: unspecified b/c low temps
                ks = "d",                                # d = Dickson (1990)
                b = "l10")                               # l10 = Lee et al. (2010)

# calculate density
may$Density <- gsw_rho(may$Salinity, may$Temp, may$SeaPressure)
```

## Combine may & carb data
```{r}
may <- cbind(may,
             pH = mayCarb$pH,
             fCO2 = mayCarb$fCO2,
             OmegaAragonite = mayCarb$OmegaAragonite,
             OmegaCalcite = mayCarb$OmegaCalcite)
```

## Prop-prop plots
```{r}
# Temp vs. Sal, coloured cast
#plot <-
ggplot(may, aes(x = Salinity, y = Temp, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

#ggplot_build(plot)$layout$panel_scales_x[[1]]$range$range # [32.29491 34.39670]
#ggplot_build(plot)$layout$panel_scales_y[[1]]$range$range # [6.717487 10.080005]

# Temp vs. Sal, bottom, coloured depth
may %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Salinity, y = Temp, col = Depth)) +
  geom_point() +
  scale_colour_viridis(option = "mako", direction = -1) +
  scale_x_continuous(limits = c(32.29, 34.40)) +
  scale_y_continuous(limits = c(6.71, 10.09)) +
  guides(colour = guide_colourbar(reverse = TRUE)) +
  theme_bw()

# Temp vs. Sal, coloured DIC
ggplot(may, aes(x = Salinity, y = Temp, col = DIC, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(option = "rocket") +
  theme_bw()

# Temp vs. Sal, coloured TA
ggplot(may, aes(x = Salinity, y = Temp, col = TA, shape = Cast)) +
  geom_point() +
  scale_colour_viridis() +
  theme_bw()

# DIC vs. Sal, coloured cast
ggplot(may, aes(x = Salinity, y = DIC, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

#plot(DIC ~ Salinity, data = may)
#identify(may$DIC ~ may$Salinity)

### check 112A DIC

# TA vs. Sal, coloured cast
ggplot(may, aes(x = Salinity, y = TA, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

#plot(may$TA ~ may$Salinity)
#abline(lm(may$TA ~ may$Salinity))
#identify(may$TA ~ may$Salinity)

### check 053B TA; maybe check 052B TA

# DIC vs. TA, coloured cast
ggplot(may, aes(x = DIC, y = TA, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

#plot(may$TA ~ may$DIC)
#identify(may$TA ~ may$DIC)

### definitely check 112 DIC
```

## Convert coordinates
```{r}
may <- may %>%
  arrange(Station)

chd <- substr(may$Lat, 3, 3)[1]

# convert latitude from DM to DD
Lat_split_may <- str_split_fixed(may$Lat, chd, 2) %>%
  as.data.frame()
Lat_split_may$V2 <- str_remove_all(Lat_split_may$V2, pattern = "'") %>%
  as.numeric()
Lat_split_may$V2 <- Lat_split_may$V2/60
Lat_split_may$V1 <- as.numeric(Lat_split_may$V1)

may$Lat <- Lat_split_may$V1 + Lat_split_may$V2

# convert longitude from DM to DD
Long_split_may <- str_split_fixed(may$Long, chd, 2) %>%
  as.data.frame()
Long_split_may$V2 <- str_remove_all(Long_split_may$V2, pattern = "'") %>%
  as.numeric()
Long_split_may$V2 <- Long_split_may$V2/60
Long_split_may$V1 <- as.numeric(Long_split_may$V1)

may$Long <- -(Long_split_may$V1 + Long_split_may$V2)
```

## Update coords to fit within polygon
```{r}
may <- may %>%
  mutate(Long = ifelse(Station == "006", Long + 0.06, Long),
         Lat = ifelse(Station == "026", Lat + 0.02, Lat),
         Long = ifelse(Station == "089", Long - 0.04, Long))
```

## Add chem to shapefile
```{r}
station_SPDF_m <- SpatialPointsDataFrame(coords = may[ , c("Long", "Lat")],
                                        data = may[ , c("Long", "Lat",
                                                        "Station", "Cast",
                                                        "Depth",
                                                        "Temp", "Salinity",
                                                        "DIC", "TA",
                                                        "pH", "fCO2",
                                                        "OmegaAragonite",
                                                        "OmegaCalcite")],
                                        proj4string = CRS("+init=epsg:4326"))

station_sf_m <- st_as_sf(station_SPDF_m) %>%
  st_transform(crs = 4326)

bottom_sf_m <- station_sf_m %>%
  filter(Cast == "Bottom")

surface_sf_m <- station_sf_m %>%
  filter(Cast == "Surface")
```

## Check mapping
```{r}
#ggplot(bottom_sf_m, aes(x = Long, y = Lat)) +
#  geom_point(aes(colour = Salinity)) +
#  geom_text(aes(label = Station), hjust = 0.05, vjust = 0.05, size = 3) +
#  scale_colour_viridis() +
#  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
#               fill = "darkgrey", colour = NA) +
#  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
#  scale_y_continuous(breaks = c(40, 41, 42))
```

## Load GB shapefiles
```{r}
GB <- st_read("./data/2020SAMZones/GB_Estimation_Areas_2019_UTM19_PDT_SFModified.shp")

# subset shapefile to SAMs
NLS_North <- subset(GB, NewSAMS == "NLS-North")
CL1_South <- subset(GB, NewSAMS == "CL1-South")
CL1_Sliver <- subset(GB, NewSAMS == "CL1-Sliver")
CL2_AccessSoutheast <- subset(GB, NewSAMS == "CL2-Access-Southeast")
SF <- subset(GB, NewSAMS == "SF")
CL2_North <- subset(GB, NewSAMS == "CL2-North")
CL1_Access <- subset(GB, NewSAMS == "CL1-Access")
NF <- subset(GB, NewSAMS == "NF")
CL2_Ext <- subset(GB, NewSAMS == "CL2-Ext")
GSC <- subset(GB, NewSAMS == "GSC")
NLS_SouthDeep <- subset(GB, NewSAMS == "NLS-South-Deep")
NLS_West <- subset(GB, NewSAMS == "NLS-West")
NLS_SouthShallow <- subset(GB, NewSAMS == "NLS-South-Shallow")
CL2_AccessSouthwest <- subset(GB, NewSAMS == "CL2-Access-Southwest")
SF_East <- subset(GB, NewSAMS == "SF-East")

# fortify regions for use with ggplot
NLS_North2 <- fortify(NLS_North)
CL1_South2 <- fortify(CL1_South)
CL1_Sliver2 <- fortify(CL1_Sliver)
CL2_AccessSoutheast2 <- fortify(CL2_AccessSoutheast)
SF2 <- fortify(SF)
CL2_North2 <- fortify(CL2_North)
CL1_Access2 <- fortify(CL1_Access)
NF2 <- fortify(NF)
CL2_Ext2 <- fortify(CL2_Ext)
GSC2 <- fortify(GSC)
NLS_SouthDeep2 <- fortify(NLS_SouthDeep)
NLS_West2 <- fortify(NLS_West)
NLS_SouthShallow2 <- fortify(NLS_SouthShallow)
CL2_AccessSouthwest2 <- fortify(CL2_AccessSouthwest)
SF_East2 <- fortify(SF_East)

# combine polygons and set CRS
GB_sf <- st_union(NLS_North2, CL1_South2) %>%
  st_union(CL1_Sliver2) %>%
  st_union(CL2_AccessSoutheast2) %>%
  st_union(SF2) %>%
  st_union(CL2_North2) %>%
  st_union(CL1_Access2) %>%
  st_union(NF2) %>%
  st_union(CL2_Ext2) %>%
  st_union(GSC2) %>%
  st_union(NLS_SouthDeep2) %>%
  st_union(NLS_West2) %>%
  st_union(NLS_SouthShallow2) %>%
  st_union(CL2_AccessSouthwest2) %>%
  st_union(SF_East2) %>%
  st_transform(crs = 26919)
  
#summary(GB_sf)
```

## Check polygon join
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", colour = "black", size = 0.5)
```

## Check point placement on polygon
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", colour = "black", size = 0.5) +
  geom_point(data = bottom_sf_m, aes(x = Long, y = Lat, colour = Salinity)) +
  geom_text(data = bottom_sf_m, aes(x = Long, y = Lat, label = Station),
            hjust = 0.05, vjust = 0.05, size = 3) +
  scale_colour_viridis() +
  #geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               #fill = "darkgrey", colour = NA) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```

## Move coordinates that are outside GB polygon
```{r}
bottom_sf_m1 <- bottom_sf_m %>%
  mutate(Long = ifelse(Station == "006", Long + 0.06, Long),
         Lat = ifelse(Station == "026", Lat + 0.02, Lat),
         Long = ifelse(Station == "089", Long - 0.04, Long))

surface_sf_m1 <- surface_sf_m %>%
  mutate(Long = ifelse(Station == "006", Long + 0.06, Long),
         Lat = ifelse(Station == "026", Lat + 0.02, Lat),
         Long = ifelse(Station == "089", Long - 0.04, Long))
```

## Begin interpolation round 1 (nearest-neighbor)
```{r}
bottom_sf_m_geom <- st_union(bottom_sf_m1) %>%
  st_transform(crs = 26919)
bottom_sf_m_v <- st_voronoi(bottom_sf_m_geom)
bottom_sf_m_v <- st_sf(bottom_sf_m_v)

surface_sf_m_geom <- st_union(surface_sf_m1) %>%
  st_transform(crs = 26919)
surface_sf_m_v <- st_voronoi(surface_sf_m_geom)
surface_sf_m_v <- st_sf(surface_sf_m_v)

# mask Voronoi with contour
bottom_sf_m_v <- st_intersection(st_cast(bottom_sf_m_v),
                                 st_union(st_buffer(GB_sf, dist = 500)))
bottom_sf_m_v <- st_sf(bottom_sf_m_v)

#st_crs(bottom_sf_m_v)

bottom_sf_m2 <- bottom_sf_m %>%
  st_transform(crs = 26919)

surface_sf_m_v <- st_intersection(st_cast(surface_sf_m_v),
                                  st_union(st_buffer(GB_sf, dist = 500)))
surface_sf_m_v <- st_sf(surface_sf_m_v)

#st_crs(surface_sf_m_v)

surface_sf_m2 <- surface_sf_m %>%
  st_transform(crs = 26919)

# complete spatial join
bottom_sf_m_v2 <- st_join(bottom_sf_m_v, bottom_sf_m2)
#glimpse(bottom_sf_m_v2)
surface_sf_m_v2 <- st_join(surface_sf_m_v, surface_sf_m2)
```

## Create shapefiles for 3 central points
```{r}
bottom_sf_m3 <- bottom_sf_m2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")

surface_sf_m3 <- surface_sf_m2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")
```

## Create coastline polygon
```{r}
# get Massachusetts coastline
library(maps)
library(mapdata)
library(maptools)

mass <- map("worldHires", "USA",
            xlim = c(-73.5, -69.9),
            ylim = c(41.2, 42.9),
            fill = TRUE,
            col = "transparent",
            plot = FALSE)
IDs <- sapply(strsplit(mass$names, ":"), function(x) x[1])
mass_SP <- map2SpatialPolygons(mass, IDs = IDs, proj4string = CRS("+init=epsg:4326"))
#plot(mass_SP)
#st_crs(mass_SP)

data <- data.frame(f = 99.9)
row.names(data) <- mass_SP@polygons[[1]]@ID
mass_SPDF <- SpatialPolygonsDataFrame(mass_SP, data)

mass_sf <- st_as_sf(mass_SPDF) %>%
  st_transform(crs = 26919)
#st_crs(mass_sf)

#ggplot() +
#  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
#  coord_sf(xlim = c(371957.88, 756099.58),
#           ylim = c(4428833.79, 4709654.16),
#           crs = st_crs(26919))
```

## Find property ranges
```{r}
# Temp
min(bottom_sf_m_v2$Temp) # 6.717487
min(surface_sf_m_v2$Temp) # 6.962792
max(bottom_sf_m_v2$Temp) # 10.08
max(surface_sf_m_v2$Temp) # 8.874117

# Sal
min(bottom_sf_m_v2$Salinity) # 32.44675
min(surface_sf_m_v2$Salinity) # 32.29491
max(bottom_sf_m_v2$Salinity) # 34.3967
max(surface_sf_m_v2$Salinity) # 33.07967

# DIC
min(bottom_sf_m_v2$DIC) # 1974.6
min(surface_sf_m_v2$DIC) # 2011.3
max(bottom_sf_m_v2$DIC) # 2137.4
max(surface_sf_m_v2$DIC) # 2082

# TA
min(bottom_sf_m_v2$TA) # 2195.2
min(surface_sf_m_v2$TA) # 2181.3
max(bottom_sf_m_v2$TA) # 2291.8
max(surface_sf_m_v2$TA) # 2234.9

# pH
min(bottom_sf_m_v2$pH) # 7.958684
min(surface_sf_m_v2$pH) # 8.001122
max(bottom_sf_m_v2$pH) # 8.233954
max(surface_sf_m_v2$pH) # 8.167257

# OmegaAragonite
min(bottom_sf_m_v2$OmegaAragonite) # 1.447193
min(surface_sf_m_v2$OmegaAragonite) # 1.547841
max(bottom_sf_m_v2$OmegaAragonite) # 2.499379
max(surface_sf_m_v2$OmegaAragonite) # 2.215415
```

## Make interpolated plots
```{r}
# make bottom plots
ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
                       aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Temperature [May]")

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(31, 36), aesthetics = c("fill", "colour"),
                     name = "Sal") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Salinity [May]")

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket", direction = -1,
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC [May]")

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Alkalinity [May]")

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom pH [May]")

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.1), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour"), name = "OmegaA") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Aragonite [May]")

# make surface plots
ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
                       aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Temperature [May]")

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(31, 36), aesthetics = c("fill", "colour"),
                     name = "Sal") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Salinity [May]")

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket", direction = -1,
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC [May]")

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Alkalinity [May]")

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface pH [May]")

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.1), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour"), name = "OmegaA") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Aragonite [May]")
```












## Attempt to add coastline polygon -- not working rn
```{r}
ggplot() +
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", colour = NA) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5))

reg_SPDF <- SpatialPointsDataFrame(coords = reg[ , c("long","lat")],
                                        data = reg,
                                        proj4string = CRS("+init=epsg:26919"))

reg_sf <- st_as_sf(reg_SPDF) %>%
  st_transform(crs = 26919)

ggplot(data = reg_sf) +
  geom_sf(fill = "lightblue") +
  coord_sf(xlim = c(371957.88, 756099.58),
           ylim = c(4428833.79, 4709654.16),
           crs = st_crs(26919))

#756099.58, 4432068.12
#746508.34, 4709654.16
#376749.56, 4706382.20
#371957.88, 4428833.79

# why won't my map show up :(((
```

## Now for interpolation style 2 (inverse distance weighting)
```{r}
# get the extent of interpolation area
grd_extent <- st_bbox(GB_sf)
 
# create grid
x.range <- as.numeric(c(grd_extent[1], grd_extent[3])) # min/max longitude of the interpolation area
y.range <- as.numeric(c(grd_extent[2], grd_extent[4])) # min/max latitude of the interpolation area
grd <- expand.grid(x = seq(from = x.range[1], to = x.range[2], by = 500),
                   y = seq(from = y.range[1], to = y.range[2], by = 500)) # expand points to grid

# convert grid to spatial object
coordinates(grd) <- ~x + y 
gridded(grd) <- TRUE

bottom_sp <- bottom_sf %>%
  st_transform(crs = 26919) %>%
  as_Spatial()
surface_sp <- surface_sf %>%
  st_transform(crs = 26919) %>%
  as_Spatial()
GB_sp <- as_Spatial(GB_sf)

# grid:
idw_grid <- spsample(GB_sp, type = "regular", n = 4000)

#st_crs(bottom_sp)
#st_crs(surface_sp)
#st_crs(idw_grid)

bottom_sp_temp <- bottom_sf %>%
  filter(!is.na(Temp)) %>%
  st_transform(crs = 26919) %>%
  as_Spatial()
surface_sp_temp <- surface_sf %>%
  filter(!is.na(Temp)) %>%
  st_transform(crs = 26919) %>%
  as_Spatial()

# idw for temp
interp_temp_B <- idw(Temp ~ 1, bottom_sp_temp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_temp_S <- idw(Temp ~ 1, surface_sp_temp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_temp_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom Temperature", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_temp_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface Temperature", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

# idw for Salinity
interp_sal_B <- idw(Salinity ~ 1, bottom_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_sal_S <- idw(Salinity ~ 1, surface_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_sal_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom Salinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_sal_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface Salinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

# idw for DIC
interp_DIC_B <- idw(DIC ~ 1, bottom_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_DIC_S <- idw(DIC ~ 1, surface_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_DIC_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom DIC", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_DIC_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface DIC", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

# idw for TA
interp_TA_B <- idw(TA ~ 1, bottom_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_TA_S <- idw(TA ~ 1, surface_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_TA_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom Alkalinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_TA_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface Alkalinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())
```

## Look at chlorophyll data
```{r}
library(tidync)

# load data

```






## Get bathymetric data
```{r}
library(marmap)
library(mapproj)
# Create base map with NOAA data
GB_bathy <- getNOAA.bathy(lon1 = -70.5, lon2 = -66, lat1 = 40, lat2 = 42.5,
                          resolution = 1)

ggbathy <- GB_bathy %>%
  fortify() %>%
  mutate(lat = y, long = x, depth = z) %>%
  select(-c(x, y, z)) %>%
  mutate(depth_bins = cut(depth, breaks = c(0, -30, -55, -75, -90, -120, -150, -180,
                                            -780, -1380, -1980, -2580, -3180, -Inf)))
```

## Get regional polygons
```{r}
library(mapdata)

reg = map_data("world2Hires")
reg = subset(reg, region %in% 'USA')

# convert longs
reg$long = (360 - reg$long)*-1
```

## Create bathy map
```{r}
map <- ggplot() +
  geom_raster(data = ggbathy, aes(long, lat, fill = depth_bins), interpolate = TRUE,
              alpha = 0.75) +
  scale_fill_manual(values = c("#08306B", "#084184", "#08519C","#1561A9", "#2171B5",
                               "#3282BE", "#4292C6", "#57A0CE", "#6BAED6", "#85BCDC",
                               "#9ECAE1", "#B2D3E8", "#C6DBEF"),
                    guide = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(breaks = c(40, 41, 42), expand = c(0, 0)) +
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", colour = NA) +
  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
  theme(axis.title = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
```

## Add points to map
```{r}
min(may$Temp, na.rm = TRUE)
max(may$Temp, na.rm = TRUE)

bottomTemp <- map +
  geom_sf(data = bottom_sf1, aes(size = Temp, colour = Temp), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(6.5, 10.5), option = "rocket") +
  scale_size_continuous(limits = c(6.5, 10.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Temperature (C)"), size = guide_legend(reverse = TRUE, title = "Temperature (C)")) +
  labs(title = "Bottom Temperature") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomTemp

surfaceTemp <- map +
  geom_sf(data = surface_sf1, aes(size = Temp, colour = Temp), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(6.5, 10.5), option = "rocket") +
  scale_size_continuous(limits = c(6.5, 10.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Temperature (C)"), size = guide_legend(reverse = TRUE, title = "Temperature (C)")) +
  labs(title = "Surface Temperature") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceTemp

min(may$Salinity)
max(may$Salinity)

bottomSal <- map +
  geom_sf(data = bottom_sf1, aes(size = Salinity, colour = Salinity),
          inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(32, 34.5), option = "rocket") +
  scale_size_continuous(limits = c(32, 34.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Salinity (PSU)"), size = guide_legend(reverse = TRUE, title = "Salinity (PSU)")) +
  labs(title = "Bottom Salinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomSal

surfaceSal <- map +
  geom_sf(data = surface_sf1, aes(size = Salinity, colour = Salinity),
          inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(32, 34.5), option = "rocket") +
  scale_size_continuous(limits = c(32, 34.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Salinity (PSU)"), size = guide_legend(reverse = TRUE, title = "Salinity (PSU)")) +
  labs(title = "Surface Salinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceSal

min(may$DIC)
max(may$DIC)

bottomDIC <- map +
  geom_sf(data = bottom_sf1, aes(colour = DIC), size = 5, inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2000, 2150), option = "rocket") +
  #scale_size_continuous(limits = c(1950, 2150), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "DIC (umol/kg)"), size = guide_legend(reverse = TRUE, title = "DIC (umol/kg)")) +
  labs(title = "Bottom DIC") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomDIC

surfaceDIC <- map +
  geom_sf(data = surface_sf1, aes(colour = DIC), size = 5, inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2000, 2150), option = "rocket") +
  #scale_size_continuous(limits = c(1950, 2150), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "DIC (umol/kg)"), size = guide_legend(reverse = TRUE, title = "DIC (umol/kg)")) +
  labs(title = "Surface DIC") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceDIC

min(may$TA)
max(may$TA)

bottomTA <- map +
  geom_sf(data = bottom_sf1, aes(size = TA, colour = TA), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2175, 2300), option = "rocket") +
  scale_size_continuous(limits = c(2175, 2300), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "TA (umol/kg)"),
         size = guide_legend(reverse = TRUE, title = "TA (umol/kg)")) +
  labs(title = "Bottom Alkalinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomTA

surfaceTA <- map +
  geom_sf(data = surface_sf1, aes(size = TA, colour = TA), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2175, 2300), option = "rocket") +
  scale_size_continuous(limits = c(2175, 2300), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "TA (umol/kg)"),
         size = guide_legend(reverse = TRUE, title = "TA (umol/kg)")) +
  labs(title = "Surface Alkalinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceTA
```






























## Load Oct datasheet
```{r}
oct <- read.csv("./data/OctoberCruiseData.csv") %>%
  rename(octLat = Latitude_degrees_start,
         octLong = Longitude_degrees_start,
         depth = Depth_meters) %>%
  select(Station, Cast, octLat, octLong, depth)

# convert latitude from DM to DD
Lat_split_oct <- str_split_fixed(oct$octLat, chd, 2) %>%
  as.data.frame()
Lat_split_oct$V2 <- str_remove_all(Lat_split_oct$V2, pattern = "'") %>%
  as.numeric()
Lat_split_oct$V2 <- Lat_split_oct$V2/60
Lat_split_oct$V1 <- as.numeric(Lat_split_oct$V1)

oct$octLat <- Lat_split_oct$V1 + Lat_split_oct$V2

# convert longitude from DM to DD
Long_split_oct <- str_split_fixed(oct$octLong, chd, 2) %>%
  as.data.frame()
Long_split_oct$V2 <- str_remove_all(Long_split_oct$V2, pattern = "'") %>%
  as.numeric()
Long_split_oct$V2 <- Long_split_oct$V2/60
Long_split_oct$V1 <- as.numeric(Long_split_oct$V1)

oct$octLong <- -(Long_split_oct$V1 + Long_split_oct$V2)
```

## Compare May vs Oct coordinates
```{r}
may <- may %>%
  rename(mayLat = Lat,
         mayLong = Long)

joined <- left_join(may, oct, by = c("Station", "Cast"), suffix = c("_may", "_oct")) %>%
  mutate(diffLat = abs(mayLat - octLat), diffLong = abs(mayLong - octLong))

max(joined$diffLat)
max(joined$diffLong)
which(joined$diffLat > 0.05)
which(joined$diffLong > 0.05)
```












## Extracting casts
```{r}
for(i in 1:length(chem$BottleID)) {
  c <- str_extract(chem$BottleID[i], ".$")
  if(c == "A") {
    chem$Cast[i] <- "Bottom"
  } else if (c == "B") {
    chem$Cast[i] <- "Surface"
  }
}

chem$Cast[1] <- "Surface" # correct flipped bottles
chem$Cast[2] <- "Bottom"
```
