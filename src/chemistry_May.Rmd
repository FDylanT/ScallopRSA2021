---
title: "MayCruiseChemistry"
author: "Dylan Titmuss"
date: "1/19/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script manipulates the chemistry data from the May RSA cruise.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")

library(tidyverse)
library(numform) # for f_pad_zero()
library(seacarb)
library(gsw) # for AOU
library(viridis)
library(ncdf4)
library(chron)
# download MixSIAR from GitHub; latest changes not yet on CRAN
#remotes::install_github("brianstock/MixSIAR", dependencies = T)
library(MixSIAR)
library(rjags)

setwd("~/Desktop/Repos/ScallopRSA2021")
```

## Load data
```{r}
may <- read.csv("./data/MayCruiseData.csv") %>%
  rename(Lat = Latitude_degrees_start,
         Long = Longitude_degrees_start,
         Depth = Depth_m_CTD,
         Temp = Temperature,
         DO = Dissolved_oxygen) %>%
    select(Date, Station, Cast, Lat, Long,
         Depth, Temp, Pressure, SeaPressure, Salinity,
         DIC, TA, DO) %>%
  mutate(Station = as.character(f_pad_zero(Station))) # add leading zeros to stations
```

## Convert coordinates from DM to DD
```{r}
chd <- substr(may$Lat, 3, 3)[1]

# latitude
Lat_split_may <- str_split_fixed(may$Lat, chd, 2) %>%
  as.data.frame()
Lat_split_may$V2 <- str_remove_all(Lat_split_may$V2, pattern = "'") %>%
  as.numeric()
Lat_split_may$V2 <- Lat_split_may$V2/60
Lat_split_may$V1 <- as.numeric(Lat_split_may$V1)

may$Lat <- Lat_split_may$V1 + Lat_split_may$V2
rm(Lat_split_may)

# longitude
Long_split_may <- str_split_fixed(may$Long, chd, 2) %>%
  as.data.frame()
Long_split_may$V2 <- str_remove_all(Long_split_may$V2, pattern = "'") %>%
  as.numeric()
Long_split_may$V2 <- Long_split_may$V2/60
Long_split_may$V1 <- as.numeric(Long_split_may$V1)

may$Long <- -(Long_split_may$V1 + Long_split_may$V2)
rm(Long_split_may)
rm(chd)
```

## *SKIP SOMETIMES* Fill in missing temp & DO values
```#{r}
# temp
for(i in 1:nrow(may)) {
  if(may$Station[i] == "006") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.5 * may$Temp[may$Station == "005" & may$Cast == cast] +
                   0.5 * may$Temp[may$Station == "007" & may$Cast == cast]
  }
  if(may$Station[i] == "012") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.271 * may$Temp[may$Station == "011" & may$Cast == cast] +
                   0.305 * may$Temp[may$Station == "013" & may$Cast == cast] +
                   0.203 * may$Temp[may$Station == "014" & may$Cast == cast] +
                   0.221 * may$Temp[may$Station == "091" & may$Cast == cast]
  }
  if(may$Station[i] == "016") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.333 * may$Temp[may$Station == "015" & may$Cast == cast] +
                   0.666 * may$Temp[may$Station == "017" & may$Cast == cast]
  }
  if(may$Station[i] == "022") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.333 * may$Temp[may$Station == "023" & may$Cast == cast] +
                   0.666 * may$Temp[may$Station == "019" & may$Cast == cast]
  }
  if(may$Station[i] == "030") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.5 * may$Temp[may$Station == "029" & may$Cast == cast] +
                   0.5 * may$Temp[may$Station == "031" & may$Cast == cast]
  }
  if(may$Station[i] == "081") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.179 * may$Temp[may$Station == "077" & may$Cast == cast] +
                   0.220 * may$Temp[may$Station == "080" & may$Cast == cast] +
                   0.238 * may$Temp[may$Station == "082" & may$Cast == cast] +
                   0.204 * may$Temp[may$Station == "083" & may$Cast == cast] +
                   0.159 * may$Temp[may$Station == "084" & may$Cast == cast]
  }
  if(may$Station[i] == "111") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.304 * may$Temp[may$Station == "107" & may$Cast == cast] +
                   0.348 * may$Temp[may$Station == "108" & may$Cast == cast] +
                   0.348 * may$Temp[may$Station == "112" & may$Cast == cast]
  }
  if(may$Station[i] == "114") {
    cast <- may$Cast[i]
    may$Temp[i] <- 0.205 * may$Temp[may$Station == "107" & may$Cast == cast] +
                   0.178 * may$Temp[may$Station == "108" & may$Cast == cast] +
                   0.230 * may$Temp[may$Station == "112" & may$Cast == cast] +
                   0.387 * may$Temp[may$Station == "113" & may$Cast == cast]
  }
}

# DO
for(i in 1:nrow(may)) {
  if(may$Station[i] == "006") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.5 * may$DO[may$Station == "005" & may$Cast == cast] +
                 0.5 * may$DO[may$Station == "007" & may$Cast == cast]
  }
  if(may$Station[i] == "012") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.271 * may$DO[may$Station == "011" & may$Cast == cast] +
                 0.305 * may$DO[may$Station == "013" & may$Cast == cast] +
                 0.203 * may$DO[may$Station == "014" & may$Cast == cast] +
                 0.221 * may$DO[may$Station == "091" & may$Cast == cast]
  }
  if(may$Station[i] == "016") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.333 * may$DO[may$Station == "015" & may$Cast == cast] +
                 0.666 * may$DO[may$Station == "017" & may$Cast == cast]
  }
  if(may$Station[i] == "022") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.333 * may$DO[may$Station == "023" & may$Cast == cast] +
                 0.666 * may$DO[may$Station == "019" & may$Cast == cast]
  }
  if(may$Station[i] == "030") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.5 * may$DO[may$Station == "029" & may$Cast == cast] +
                 0.5 * may$DO[may$Station == "031" & may$Cast == cast]
  }
  if(may$Station[i] == "081") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.179 * may$DO[may$Station == "077" & may$Cast == cast] +
                 0.220 * may$DO[may$Station == "080" & may$Cast == cast] +
                 0.238 * may$DO[may$Station == "082" & may$Cast == cast] +
                 0.204 * may$DO[may$Station == "083" & may$Cast == cast] +
                 0.159 * may$DO[may$Station == "084" & may$Cast == cast]
  }
  if(may$Station[i] == "111") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.304 * may$DO[may$Station == "107" & may$Cast == cast] +
                 0.348 * may$DO[may$Station == "108" & may$Cast == cast] +
                 0.348 * may$DO[may$Station == "112" & may$Cast == cast]
  }
  if(may$Station[i] == "114") {
    cast <- may$Cast[i]
    may$DO[i] <- 0.205 * may$DO[may$Station == "107" & may$Cast == cast] +
                 0.178 * may$DO[may$Station == "108" & may$Cast == cast] +
                 0.230 * may$DO[may$Station == "112" & may$Cast == cast] +
                 0.387 * may$DO[may$Station == "113" & may$Cast == cast]
  }
}
```

## Calculate density & carbon system parameters
```{r}
for(i in which(is.na(may$SeaPressure))) {
  # substitude depth for sites without sea pressure
  may$SeaPressure[i] <- may$Depth[i]
  # calculate surface pressure
  may$Pressure[i] <- may$SeaPressure[i] + 10.1325
}

# calculate density
may$Density <- gsw_rho(may$Salinity, may$Temp, may$SeaPressure)

# convert DO from umol/L to umol/kg
may$DO_L <- may$DO
may$DO <- may$DO / (may$Density / 1000) # convert m^3 to L

# remove station 112 bottom DIC
may$DIC[may$Station == "112" & may$Cast == "Bottom"] <- NA

mayCarb <- carb(flag = 15,                                                  # 15 = ALK & DIC given
                var1 = may$TA[!is.na(may$Temp) & !is.na(may$DIC)] / 10^6,   # in mol/kg
                var2 = may$DIC[!is.na(may$Temp) & !is.na(may$DIC)] / 10^6,  # in mol/kg
                S = may$Salinity[!is.na(may$Temp) & !is.na(may$DIC)],
                T = may$Temp[!is.na(may$Temp) & !is.na(may$DIC)],           # in deg C
                Patm = may$Pressure[!is.na(may$Temp) & !is.na(may$DIC)] * 0.098692326671601,
                                                                            # in atm
                P = may$SeaPressure[!is.na(may$Temp) & !is.na(may$DIC)] / 10, # in bar
                k1k2 = "l",                                                 # l = Lueker et al. (2000)
                # kf: unspecified b/c low temps
                ks = "d",                                                   # d = Dickson (1990)
                b = "l10")                                                  # l10 = Lee et al. (2010)

# combine may & carb data
r <- 1
for(i in c(1:10, 13:22, 25:30, 33:42, 45:58, 61:160, 163:220, 224:226)) {
  may$pH[i] <- mayCarb$pH[r]
  may$fCO2[i] <- mayCarb$fCO2[r]
  may$pCO2[i] <- mayCarb$pCO2[r]
  may$OmegaAragonite[i] <- mayCarb$OmegaAragonite[r]
  may$OmegaCalcite[i] <- mayCarb$OmegaCalcite[r]
  r <- r + 1
}

for(i in 1:nrow(may)) {
  if(is.na(may$Temp[i])) {
    may$pH[i] <- NA
    may$pCO2[i] <- NA
    may$OmegaAragonite[i] <- NA
    may$OmegaCalcite[i] <- NA
  }
  if(is.na(may$DIC[i])) {
    may$pH[i] <- NA
    may$pCO2[i] <- NA
    may$OmegaAragonite[i] <- NA
    may$OmegaCalcite[i] <- NA
  }
}
```

## Calculate AOU
```{r}
# calc absolute sal
may$AbsSal <- gsw_SA_from_SP(SP = may$Salinity,
                             p = may$SeaPressure,
                             longitude = may$Long,
                             latitude = may$Lat)

# calc conservative temp
may$ConsTemp <- gsw_CT_from_t(SA = may$AbsSal,
                              t = may$Temp,
                              p = may$SeaPressure)

# calc O2 sol
may$O2sol <- gsw_O2sol(SA = may$AbsSal,
                       CT = may$ConsTemp,
                       p = may$SeaPressure,
                       longitude = may$Long,
                       latitude = may$Lat)

# calc AOU
may$AOU <- may$O2sol - may$DO
```

# MIXING ANALYSIS

## Find endmember property values
```{r}
# surface: 4, 72, 113 EMs
# bottom: 4, 62, 79, + 59 EMs

# no data: 6, 12, 16, 22, 30, 81, 111, 114

# surface EMs
EM1 <- which(may$Station == "004" & may$Cast == "Surface") # GoM
EM2 <- which(may$Station == "072" & may$Cast == "Surface") # Labrador
EM3 <- which(may$Station == "113" & may$Cast == "Surface") # OCCC

# bottom EMs
EM4 <- which(may$Station == "062" & may$Cast == "Bottom") # Labrador
EM5 <- which(may$Station == "079" & may$Cast == "Bottom") # central water
EM6 <- which(may$Station == "004" & may$Cast == "Bottom") # GoM water (046, 048)
EM7 <- which(may$Station == "059" & may$Cast == "Bottom") # slope water

# pull values for EMs
S1 <- may$Salinity[EM1]
S2 <- may$Salinity[EM2]
S3 <- may$Salinity[EM3]

S4 <- may$Salinity[EM4]
S5 <- may$Salinity[EM5]
S6 <- may$Salinity[EM6]
S7 <- may$Salinity[EM7]

T1 <- may$Temp[EM1]
T2 <- may$Temp[EM2]
T3 <- may$Temp[EM3]

T4 <- may$Temp[EM4]
T5 <- may$Temp[EM5]
T6 <- may$Temp[EM6]
T7 <- may$Temp[EM7]

DIC1 <- may$DIC[EM1]
DIC2 <- may$DIC[EM2]
DIC3 <- may$DIC[EM3]

DIC4 <- may$DIC[EM4]
DIC5 <- may$DIC[EM5]
DIC6 <- may$DIC[EM6]
DIC7 <- may$DIC[EM7]

TA1 <- may$TA[EM1]
TA2 <- may$TA[EM2]
TA3 <- may$TA[EM3]

TA4 <- may$TA[EM4]
TA5 <- may$TA[EM5]
TA6 <- may$TA[EM6]
TA7 <- may$TA[EM7]
```

## Surface: triangle

## Identify EM stat parameters
```{r}
# surface EM1
EMs1 <- may$Salinity[may$Cast == "Surface" &
                     !is.na(may$Temp) &
                     may$Salinity >= S1 - 0.1 & may$Salinity <= S1 + 0.1 &
                     may$Temp >= T1 - 0.2 & may$Temp <= T1 + 0.2]
for(i in 1:length(EMs1)) {
  EMs1[i] <- which(may$Salinity == EMs1[i])
}
for(i in 1:length(EMs1)) {
  print(may$Station[EMs1[i]])
}

# calc mean & sd for later use
mean_sal_EMs1 <- mean(may$Salinity[EMs1])
sd_sal_EMs1 <- sd(may$Salinity[EMs1])
sal_err1 <- sqrt((1/length(EMs1)) * (0.003^2 * length(EMs1)))
err_sal_EMs1 <- sd_sal_EMs1 + sal_err1

mean_temp_EMs1 <- mean(may$Temp[EMs1])
sd_temp_EMs1 <- sd(may$Temp[EMs1])
temp_err1 <- sqrt((1/length(EMs1)) * (0.002^2 * length(EMs1)))
err_temp_EMs1 <- sd_temp_EMs1 + temp_err1

# surface EM2
EMs2 <- may$Salinity[may$Cast == "Surface" &
                     !is.na(may$Temp) &
                     may$Salinity >= S2 - 0.1 & may$Salinity <= S2 + 0.1 &
                     may$Temp >= T2 - 0.2 & may$Temp <= T2 + 0.2]
for(i in 1:length(EMs2)) {
  EMs2[i] <- which(may$Salinity == EMs2[i])
}
for(i in 1:length(EMs2)) {
  print(may$Station[EMs2[i]])
}

# calc mean & sd for later use
mean_sal_EMs2 <- mean(may$Salinity[EMs2])
sd_sal_EMs2 <- sd(may$Salinity[EMs2])
sal_err2 <- sqrt((1/length(EMs2)) * (0.003^2 * length(EMs2)))
err_sal_EMs2 <- sd_sal_EMs2 + sal_err2

mean_temp_EMs2 <- mean(may$Temp[EMs2])
sd_temp_EMs2 <- sd(may$Temp[EMs2])
temp_err2 <- sqrt((1/length(EMs2)) * (0.002^2 * length(EMs2)))
err_temp_EMs2 <- sd_temp_EMs2 + temp_err2

# surface EM3
EMs3 <- may$Salinity[may$Cast == "Surface" &
                     !is.na(may$Temp) &
                     may$Salinity >= S3 - 0.1 & may$Salinity <= S3 + 0.1 &
                     may$Temp >= T3 - 0.2 & may$Temp <= T3 + 0.2]
for(i in 1:length(EMs3)) {
  EMs3[i] <- which(may$Salinity == EMs3[i])
}
for(i in 1:length(EMs3)) {
  print(may$Station[EMs3[i]])
}

# calc mean & sd for later use
mean_sal_EMs3 <- mean(may$Salinity[EMs3])
sd_sal_EMs3 <- sd(may$Salinity[EMs3])
sal_err3 <- sqrt((1/length(EMs3)) * (0.003^2 * length(EMs3)))
err_sal_EMs3 <- sd_sal_EMs3 + sal_err3

mean_temp_EMs3 <- mean(may$Temp[EMs3])
sd_temp_EMs3 <- sd(may$Temp[EMs3])
temp_err3 <- sqrt((1/length(EMs3)) * (0.002^2 * length(EMs3)))
err_temp_EMs3 <- sd_temp_EMs3 + temp_err3
```

```{r}
summ1m <- read.table("data/mixing/summary_statistics1m.txt", skip = 8) %>%
  select(-V1) %>%
  separate(V2, into = c("Station", "EM")) %>%
  rename(Mean = V3, SD = V4)

may$EM1 <- NA
may$EM1sd <- NA
may$EM2 <- NA
may$EM2sd <- NA
may$EM3 <- NA
may$EM3sd <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface" &
     may$Station[i] != "006" &
     may$Station[i] != "012" &
     may$Station[i] != "016" &
     may$Station[i] != "022" &
     may$Station[i] != "030" &
     may$Station[i] != "081" &
     may$Station[i] != "111" &
     may$Station[i] != "114" #&
     ###
     #may$Station[i] != "058" &
     #may$Station[i] != "029" &
     #may$Station[i] != "002" &
     #may$Station[i] != "047"
  ) {
    may$EM1[i] <- summ1m$Mean[summ1m$EM == "EM1" &
                           summ1m$Station == as.integer(may$Station[i])]
    may$EM1sd[i] <- summ1m$SD[summ1m$EM == "EM1" &
                           summ1m$Station == as.integer(may$Station[i])]
    may$EM2[i] <- summ1m$Mean[summ1m$EM == "EM2" &
                           summ1m$Station == as.integer(may$Station[i])]
    may$EM2sd[i] <- summ1m$SD[summ1m$EM == "EM2" &
                           summ1m$Station == as.integer(may$Station[i])]
    may$EM3[i] <- summ1m$Mean[summ1m$EM == "EM3" &
                           summ1m$Station == as.integer(may$Station[i])]
    may$EM3sd[i] <- summ1m$SD[summ1m$EM == "EM3" &
                           summ1m$Station == as.integer(may$Station[i])]
  }
}
```

## Bottom: quadrangle

## Identify EM stat parameters
```{r}
# bottom EM4
EMs4 <- may$Salinity[may$Cast == "Bottom" &
                     !is.na(may$Temp) &
                     may$Station != "002" &
                     may$Salinity >= S4 - 0.1 & may$Salinity <= S4 + 0.1 &
                     may$Temp >= T4 - 0.2 & may$Temp <= T4 + 0.2]
for(i in 1:length(EMs4)) {
  EMs4[i] <- which(may$Salinity == EMs4[i])
}
for(i in 1:length(EMs4)) {
  print(may$Station[EMs4[i]])
}

# calc mean & sd for later use
mean_sal_EMs4 <- mean(may$Salinity[EMs4])
sd_sal_EMs4 <- sd(may$Salinity[EMs4])
sal_err4 <- sqrt((1/length(EMs4)) * (0.003^2 * length(EMs4)))
err_sal_EMs4 <- sd_sal_EMs4 + sal_err4

mean_temp_EMs4 <- mean(may$Temp[EMs4])
sd_temp_EMs4 <- sd(may$Temp[EMs4])
temp_err4 <- sqrt((1/length(EMs4)) * (0.002^2 * length(EMs4)))
err_temp_EMs4 <- sd_temp_EMs4 + temp_err4

# bottom EM5
EMs5 <- may$Salinity[may$Cast == "Bottom" &
                     !is.na(may$Temp) &
                     may$Salinity >= S5 - 0.1 & may$Salinity <= S5 + 0.1 &
                     may$Temp >= T5 - 0.2 & may$Temp <= T5 + 0.2]
for(i in 1:length(EMs5)) {
  EMs5[i] <- which(may$Salinity == EMs5[i])
}
for(i in 1:length(EMs5)) {
  print(may$Station[EMs5[i]])
}

# calc mean & sd for later use
mean_sal_EMs5 <- mean(may$Salinity[EMs5])
sd_sal_EMs5 <- sd(may$Salinity[EMs5])
sal_err5 <- sqrt((1/length(EMs5)) * (0.003^2 * length(EMs5)))
err_sal_EMs5 <- sd_sal_EMs5 + sal_err5

mean_temp_EMs5 <- mean(may$Temp[EMs5])
sd_temp_EMs5 <- sd(may$Temp[EMs5])
temp_err5 <- sqrt((1/length(EMs5)) * (0.002^2 * length(EMs5)))
err_temp_EMs5 <- sd_temp_EMs5 + temp_err5

# bottom EM6
EMs6 <- may$Salinity[may$Cast == "Bottom" &
                     !is.na(may$Temp) &
                     may$Station != "003" & may$Station != "004" &
                     may$Salinity >= S6 - 0.1 & may$Salinity <= S6 + 0.1 &
                     may$Temp >= T6 - 0.2 & may$Temp <= T6 + 0.2]
for(i in 1:length(EMs6)) {
  EMs6[i] <- which(may$Salinity == EMs6[i])
}
for(i in 1:length(EMs6)) {
  print(may$Station[EMs6[i]])
}

# calc mean & sd for later use
mean_sal_EMs6 <- mean(may$Salinity[EMs6])
sd_sal_EMs6 <- sd(may$Salinity[EMs6])
sal_err6 <- sqrt((1/length(EMs6)) * (0.003^2 * length(EMs6)))
err_sal_EMs6 <- sd_sal_EMs6 + sal_err6

mean_temp_EMs6 <- mean(may$Temp[EMs6])
sd_temp_EMs6 <- sd(may$Temp[EMs6])
temp_err6 <- sqrt((1/length(EMs6)) * (0.002^2 * length(EMs6)))
err_temp_EMs6 <- sd_temp_EMs6 + temp_err6

# bottom EM7
EMs7 <- may$Salinity[may$Cast == "Bottom" &
                     !is.na(may$Temp) &
                     may$Salinity >= S7 - 0.2 & may$Salinity <= S7 + 0.2 &
                     may$Temp >= T7 - 0.5 & may$Temp <= T7 + 0.5]
for(i in 1:length(EMs7)) {
  EMs7[i] <- which(may$Salinity == EMs7[i])
}
for(i in 1:length(EMs7)) {
  print(may$Station[EMs7[i]])
}

# calc mean & sd for later use
mean_sal_EMs7 <- mean(may$Salinity[EMs7])
sd_sal_EMs7 <- sd(may$Salinity[EMs7])
sal_err7 <- sqrt((1/length(EMs7)) * (0.003^2 * length(EMs7)))
err_sal_EMs7 <- sd_sal_EMs7 + sal_err7

mean_temp_EMs7 <- mean(may$Temp[EMs7])
sd_temp_EMs7 <- sd(may$Temp[EMs7])
temp_err7 <- sqrt((1/length(EMs7)) * (0.002^2 * length(EMs7)))
err_temp_EMs7 <- sd_temp_EMs7 + temp_err7
```

```{r}
summ2m <- read.table("data/mixing/summary_statistics2m.txt", skip = 8) %>%
  dplyr::select(-V1) %>%
  separate(V2, into = c("Station", "EM")) %>%
  rename(Mean = V3, SD = V4)

may$EM4 <- NA
may$EM4sd <- NA
may$EM5 <- NA
may$EM5sd <- NA
may$EM6 <- NA
may$EM6sd <- NA
may$EM7 <- NA
may$EM7sd <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Bottom") {
    if(identical(summ2m$Mean[summ2m$Station == as.integer(may$Station[i])],
                 numeric(0))) {
      next
    }
    may$EM4[i] <- summ2m$Mean[summ2m$EM == "EM4" &
                           summ2m$Station == as.integer(may$Station[i])]
    may$EM4sd[i] <- summ2m$SD[summ2m$EM == "EM4" &
                           summ2m$Station == as.integer(may$Station[i])]
    may$EM5[i] <- summ2m$Mean[summ2m$EM == "EM5" &
                           summ2m$Station == as.integer(may$Station[i])]
    may$EM5sd[i] <- summ2m$SD[summ2m$EM == "EM5" &
                           summ2m$Station == as.integer(may$Station[i])]
    may$EM6[i] <- summ2m$Mean[summ2m$EM == "EM6" &
                           summ2m$Station == as.integer(may$Station[i])]
    may$EM6sd[i] <- summ2m$SD[summ2m$EM == "EM6" &
                           summ2m$Station == as.integer(may$Station[i])]
    may$EM7[i] <- summ2m$Mean[summ2m$EM == "EM7" &
                           summ2m$Station == as.integer(may$Station[i])]
    may$EM7sd[i] <- summ2m$SD[summ2m$EM == "EM7" &
                           summ2m$Station == as.integer(may$Station[i])]
  }
}
```

## Calculate mixing-normalized DIC, TA & DO values
```{r}
DIC1 <- mean(may$DIC[EMs1])
DIC2 <- mean(may$DIC[EMs2])
DIC3 <- mean(may$DIC[EMs3])
DIC4 <- mean(may$DIC[EMs4])
DIC5 <- mean(may$DIC[EMs5])
DIC6 <- mean(may$DIC[EMs6])
DIC7 <- mean(may$DIC[EMs7])

sdDIC1 <- sd(may$DIC[EMs1])
sdDIC2 <- sd(may$DIC[EMs2])
sdDIC3 <- sd(may$DIC[EMs3])
sdDIC4 <- sd(may$DIC[EMs4])
sdDIC5 <- sd(may$DIC[EMs5])
sdDIC6 <- sd(may$DIC[EMs6])
sdDIC7 <- sd(may$DIC[EMs7])

TA1 <- mean(may$TA[EMs1])
TA2 <- mean(may$TA[EMs2])
TA3 <- mean(may$TA[EMs3])
TA4 <- mean(may$TA[EMs4])
TA5 <- mean(may$TA[EMs5])
TA6 <- mean(may$TA[EMs6])
TA7 <- mean(may$TA[EMs7])

sdTA1 <- sd(may$TA[EMs1])
sdTA2 <- sd(may$TA[EMs2])
sdTA3 <- sd(may$TA[EMs3])
sdTA4 <- sd(may$TA[EMs4])
sdTA5 <- sd(may$TA[EMs5])
sdTA6 <- sd(may$TA[EMs6])
sdTA7 <- sd(may$TA[EMs7])

DO1 <- mean(may$DO[EMs1])
DO2 <- mean(may$DO[EMs2])
DO3 <- mean(may$DO[EMs3])
DO4 <- mean(may$DO[EMs4])
DO5 <- mean(may$DO[EMs5])
DO6 <- mean(may$DO[EMs6])
DO7 <- mean(may$DO[EMs7])

sdDO1 <- sd(may$DO[EMs1])
sdDO2 <- sd(may$DO[EMs2])
sdDO3 <- sd(may$DO[EMs3])
sdDO4 <- sd(may$DO[EMs4])
sdDO5 <- sd(may$DO[EMs5])
sdDO6 <- sd(may$DO[EMs6])
sdDO7 <- sd(may$DO[EMs7])

may$DICn <- NA
may$dDIC <- NA
may$TAn <- NA
may$dTA <- NA
may$DOn <- NA
may$dDO <- NA

## process used to solve the system of eq is at the end of this script

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
       may$DICn[i] = may$EM1[i]*DIC1 + may$EM2[i]*DIC2 + may$EM3[i]*DIC3
       may$dDIC[i] = may$DIC[i] - may$DICn[i]   # observed - expected
       may$TAn[i] = may$EM1[i]*TA1 + may$EM2[i]*TA2 + may$EM3[i]*TA3
       may$dTA[i] = may$TA[i] - may$TAn[i]   # observed - expected
       may$DOn[i] = may$EM1[i]*DO1 + may$EM2[i]*DO2 + may$EM3[i]*DO3
       may$dDO[i] = may$DO[i] - may$DOn[i]   # observed - expected
       may$sdDICn[i] = sqrt(may$EM1sd[i]^2 * DIC1 + sdDIC1^2 * may$EM1[i] +
                            may$EM2sd[i]^2 * DIC2 + sdDIC2^2 * may$EM2[i] +
                            may$EM3sd[i]^2 * DIC3 + sdDIC3^2 * may$EM3[i])
       may$sdTAn[i] = sqrt(may$EM1sd[i]^2 * TA1 + sdTA1^2 * may$EM1[i] +
                           may$EM2sd[i]^2 * TA2 + sdTA2^2 * may$EM2[i] +
                           may$EM3sd[i]^2 * TA3 + sdTA3^2 * may$EM3[i])
       may$sdDOn[i] = sqrt(may$EM1sd[i]^2 * DO1 + sdDO1^2 * may$EM1[i] +
                           may$EM2sd[i]^2 * DO2 + sdDO2^2 * may$EM2[i] +
                           may$EM3sd[i]^2 * DO3 + sdDO3^2 * may$EM3[i])
     } else if(may$Cast[i] == "Bottom") {
       may$DICn[i] = may$EM4[i]*DIC4 + may$EM5[i]*DIC5 + may$EM6[i]*DIC6 +
         may$EM7[i]*DIC7
       may$dDIC[i] = may$DIC[i] - may$DICn[i]   # observed - expected
       may$TAn[i] = may$EM4[i]*TA4 + may$EM5[i]*TA5 + may$EM6[i]*TA6 +
         may$EM7[i]*TA7
       may$dTA[i] = may$TA[i] - may$TAn[i]   # observed - expected
       may$DOn[i] = may$EM4[i]*DO4 + may$EM5[i]*DO5 + may$EM6[i]*DO6 +
         may$EM7[i]*DO7
       may$dDO[i] = may$DO[i] - may$DOn[i]   # observed - expected
       may$sdDICn[i] = sqrt(may$EM4sd[i]^2 * DIC4 + sdDIC4^2 * may$EM4[i] +
                            may$EM5sd[i]^2 * DIC5 + sdDIC5^2 * may$EM5[i] +
                            may$EM6sd[i]^2 * DIC6 + sdDIC6^2 * may$EM6[i] +
                            may$EM7sd[i]^2 * DIC7 + sdDIC7^2 * may$EM7[i])
       may$sdTAn[i] = sqrt(may$EM4sd[i]^2 * TA4 + sdTA4^2 * may$EM4[i] +
                           may$EM5sd[i]^2 * TA5 + sdTA5^2 * may$EM5[i] +
                           may$EM6sd[i]^2 * TA6 + sdTA6^2 * may$EM6[i] +
                           may$EM7sd[i]^2 * TA7 + sdTA7^2 * may$EM7[i])
       may$sdDOn[i] = sqrt(may$EM4sd[i]^2 * DO4 + sdDO4^2 * may$EM4[i] +
                           may$EM5sd[i]^2 * DO5 + sdDO5^2 * may$EM5[i] +
                           may$EM6sd[i]^2 * DO6 + sdDO6^2 * may$EM6[i] +
                           may$EM7sd[i]^2 * TA7 + sdTA7^2 * may$EM7[i])
     }
}
```

## Calculate air-sea CO2 flux
### Schmidt number
```{r}
# F = k*K0(pCO2w – pCO2a)       # F: mass/area*time
                                # k: length/time
                                # K0: mass/volume*pressure (solubility)

# Schmidt number: kinematic viscosity of the water divided by diffusion coefficient of the gas
  # gas- & temp-specific; also somewhat dependent on salinity

  # Sc = A + Bt + Ct^2 + Dt^3 + Et^4
    # t in °C
    # kinematic viscosity from Sharqawy et al. 2010
    # diffusion coefficient from Jähne et al. 1987

A = 2116.8
B = -136.25
C = 4.7353
D = -0.092307
E = 0.000755566

may$Sc <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    t = may$Temp[i]
    may$Sc[i] = A + B*t + C*t^2 + D*t^3 + E*t^4
  }
}
```

### Gas transfer velocity pt. 1: wind speeds
```{r}
# sample collection: May 2-6, 2021 GMT
# 63-day period centered on May 4, 2021
# Apr 3 - Jun 4

# first satellite
satA <- nc_open("./data/winds/KNMI-GLO-WIND_L3-OBS_METOP-A_ASCAT_25_ASC_V2_may.nc")

lon <- ncvar_get(satA, "lon")
lat <- ncvar_get(satA, "lat")
time <- ncvar_get(satA, "time")
t.units <- ncatt_get(satA, "time", "units")

# convert time
#t.units$value   # "seconds since 1990-01-01 00:00:00"
# chron() calculates *days* since origin
#chron(time/60/60/24, origin = c(month = 1, day = 1, year = 1990))

wind_array <- ncvar_get(satA, "wind_speed")
fillvalue <- ncatt_get(satA, "wind_speed", "_FillValue")
wind_array[wind_array == fillvalue$value] <- NA

wind_6day <- wind_array[ , , 29:34] # 6-day period May 1-6
#image(lon, lat, wind_slice, col = mako(40, direction = -1))

wind_df_A <- data.frame(matrix(ncol = 4, nrow = 0))

# fill dataframe
for(i in 1:6) {
  lonlat <- as.matrix(expand.grid(lon, lat))
  wind_slice <- wind_6day[ , , i]
  wind_vec <- as.vector(wind_slice)
  day_vec <- rep(i, length(wind_vec))
  wind_df_A <- rbind(wind_df_A, data.frame(cbind(day_vec, lonlat, wind_vec)))
}
names(wind_df_A) <- c("day", "lon", "lat", "wind_speed")

# second satellite
satB <- nc_open("./data/winds/KNMI-GLO-WIND_L3-OBS_METOP-B_ASCAT_25_ASC_V2_may.nc")

lon <- ncvar_get(satB, "lon")
lat <- ncvar_get(satB, "lat")
time <- ncvar_get(satB, "time")

#chron(time/60/60/24, origin = c(month = 1, day = 1, year = 1990))

wind_array <- ncvar_get(satB, "wind_speed")
fillvalue <- ncatt_get(satB, "wind_speed", "_FillValue")
wind_array[wind_array == fillvalue$value] <- NA

wind_6day <- wind_array[ , , 29:34]
#image(lon, lat, wind_slice, col = mako(40, direction = -1))

wind_df_B <- data.frame(matrix(ncol = 4, nrow = 0))

# fill dataframe
for(i in 1:6) {
  lonlat <- as.matrix(expand.grid(lon, lat))
  wind_slice <- wind_6day[ , , i]
  wind_vec <- as.vector(wind_slice)
  day_vec <- rep(i, length(wind_vec))
  wind_df_B <- rbind(wind_df_B, data.frame(cbind(day_vec, lonlat, wind_vec)))
}
names(wind_df_B) <- c("day", "lon", "lat", "wind_speed")

# third satellite
satC <- nc_open("./data/winds/KNMI-GLO-WIND_L3-OBS_METOP-C_ASCAT_25_ASC_V2_may.nc")

lon <- ncvar_get(satC, "lon")
lat <- ncvar_get(satC, "lat")
time <- ncvar_get(satC, "time")

#chron(time/60/60/24, origin = c(month = 1, day = 1, year = 1990))

wind_array <- ncvar_get(satC, "wind_speed")
fillvalue <- ncatt_get(satC, "wind_speed", "_FillValue")
wind_array[wind_array == fillvalue$value] <- NA

wind_6day <- wind_array[ , , 29:34]
#image(lon, lat, wind_slice, col = mako(40, direction = -1))

wind_df_C <- data.frame(matrix(ncol = 4, nrow = 0))

# fill dataframe
for(i in 1:6) {
  lonlat <- as.matrix(expand.grid(lon, lat))
  wind_slice <- wind_6day[ , , i]
  wind_vec <- as.vector(wind_slice)
  day_vec <- rep(i, length(wind_vec))
  wind_df_C <- rbind(wind_df_C, data.frame(cbind(day_vec, lonlat, wind_vec)))
}
names(wind_df_C) <- c("day", "lon", "lat", "wind_speed")

# merge dataframes, averaging across 63 days
wind_df <- bind_rows(wind_df_A, wind_df_B, wind_df_C) %>%
  mutate(lon = lon - 360) %>%
  filter(lon >= -70.5 & lon <= -66) %>%
  filter(lat >= 40 & lat <= 42.5) %>%
  group_by(lon, lat) %>%
  summarise(mean_wind = mean(wind_speed, na.rm = TRUE)) %>%
  mutate(mean_wind = ifelse(is.nan(mean_wind), NA, mean_wind)) %>%
  na.omit()

#ggplot(wind_df) +
#  geom_point(aes(x = lon, y = lat, col = mean_wind), size = 15, shape = 15) +
#  scale_color_viridis(limits = c(0.6, 12.4), breaks = c(3, 6, 9, 12),
#                      name = "wspd") +
#  geom_point(data = may, aes(x = Long, y = Lat), shape = 18, size = 4) +
#  xlim(-70.5, -66) +
#  ylim(40, 42.5) +
#  theme_bw() +
#  theme(axis.title = element_blank())

may$wspd <- NA

# assign wind speed to each station
for(i in 1:nrow(may)) {
  may$wspd[i] = mean(wind_df$mean_wind[which(abs(may$Lat[i] - wind_df$lat) +
                                             abs(may$Long[i] - wind_df$lon) ==
                                         min(abs(may$Lat[i] - wind_df$lat) +
                                             abs(may$Long[i] - wind_df$lon)))])
}
```

### Gas transfer velocity pt. 2
```{r}
# k (cm/hr) = 0.251 * U10^2 * (Sc/660)^-0.5   (Wanninkhof 2014)
  # U10 (m/s) = average of neutral stability winds at 10-m height
      # ****need data corr. to 10m****
      # average 30 days around cruise
# k (cm/hr) = 0.266 * U10^2 * (Sc/600)^-0.5   (Ho et al. 2006)

may$k <- NA   # gas transfer velocity (cm/hr)

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    # Wanninkhof 2014
    may$k[i] = 0.251 * may$wspd[i]^2 * (may$Sc[i]/660)^-0.5
    # Ho et al. 2006
    #may$k2[i] = 0.266 * may$wspd[i]^2 * (may$Sc[i]/600)^-0.5
  }
}

# which(abs(may$k - may$k2) > 0.11) # all w/in 0.11 of each other
```

### Solubility constant & flux calc
```{r}
# ln(beta) = Α1 + Α2(100/Τ) + A3ln(T/100) + S[(B1 + B2(T/100) + B3(T/100)^2]
  # beta = K' (mol/L*atm) from Weiss 1974
  # T in K
  # S in ppt (PSU)

A1 = -58.0931
A2 = 90.5069
A3 = 22.2940
B1 = 0.027766
B2 = -0.025888
B3 = 0.0050578

may$K.prime <- NA
may$pH2O <- NA   # seawater vapor pressure

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    T = may$Temp[i] + 273.15
    S = may$Salinity[i]
    may$K.prime[i] = exp(A1 + A2*(100/T) + A3*log(T/100) + S*(B1 + B2*(T/100) + B3*(T/100)^2))
    # partial pressure of H2O right above the sea surface
    may$pH2O[i] = vapress(may$Salinity[i], may$Temp[i], form = "d2007")   # atm
  }
}

# K' ≈ K0 * f/(X(P – PH2O))
  # K' in mol/L*atm
  # f: fugacity
  # X: mole fraction (dry)
  # P: total pressure
  # pH2O: seawater vapor pressure

## OOI data
pCO2_data <- read.csv("./data/pCO2/MayCruiseCNSM.csv") %>%
  filter(DateTime >= "01-May-2021")

P <- mean(pCO2_data$gas_stream_pressure) / 1013.25   # hPa to atm
may$K0 <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    xCO2 = p2xCO2(may$Salinity[i], may$Temp[i], Patm = P, may$pCO2[i])   # ppm
    may$K0[i] = may$K.prime[i] * xCO2 * (P - may$pH2O[i]) / may$fCO2[i]
  }
}

# F = k*K0(pCO2w – pCO2a)

pCO2a <- mean(pCO2_data$partial_pressure_co2_atm)

may$flux <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    k = may$k[i] / 100 * 24         # cm/hr --> m/d
    K0 = may$K0[i] * 10^6 * 10^3 / 10^6    # mol/(L*atm) --> umol/(m^3*uatm)
    d.pCO2 = may$pCO2[i] - pCO2a    # uatm
    may$flux[i] = k * K0 * d.pCO2   # umol/(m^2*d)
  }
}
```

## Add mixed-layer depths
```{r}
MLD <- read.csv("./data/CTD/may_MLD.csv")

may$MLD <- NA
may$MLD_frac <- NA

for(i in 1:nrow(may)) {
  if(may$Station[i] != "006" &
     may$Station[i] != "012" &
     may$Station[i] != "016" &
     may$Station[i] != "022" &
     may$Station[i] != "030" &
     may$Station[i] != "081" &
     may$Station[i] != "111" &
     may$Station[i] != "114") {
    may$MLD[i] = MLD$MLD[MLD$Station == as.integer(may$Station[i])]
    depth = may$Depth[may$Station == may$Station[i] &
                      may$Cast == "Bottom"]
    may$MLD_frac[i] <- may$MLD[i] / depth
  }
}
```

## Add air-sea flux for fully mixed sites
```{r}
for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Bottom" &
     !is.na(may$MLD_frac[i]) &
     may$MLD_frac[i] > 0.75) {
    may$flux[i] = may$flux[which(may$Cast == "Surface" &
                                 may$Station == may$Station[i])]
  }
}
```

## Load & assign residence time data
```{r}
resTimes <- read.csv("data/GB_ResTimes.csv")

LongW <- rep(NA, 160)
LongE <- rep(NA, 160)
LatN <- rep(NA, 160)
LatS <- rep(NA, 160)
ResTime <- rep(NA, 160)

res.new <- as.data.frame(cbind(LongW, LongE, LatN, LatS, ResTime))

for(i in 1:nrow(resTimes)) {
  longW <- resTimes$LongW[i]
  longE <- resTimes$LongE[i]
  latN <- resTimes$LatN[i]
  latS <- resTimes$LatS[i]
  res.new$LongW[i*4-3] <- longW
  res.new$LongE[i*4-3] <- longE - 0.25
  res.new$LatN[i*4-3] <- latN
  res.new$LatS[i*4-3] <- latS + 0.25
  res.new$LongW[i*4-2] <- longW + 0.25
  res.new$LongE[i*4-2] <- longE
  res.new$LatN[i*4-2] <- latN
  res.new$LatS[i*4-2] <- latS + 0.25
  res.new$LongW[i*4-1] <- longW
  res.new$LongE[i*4-1] <- longE - 0.25
  res.new$LatN[i*4-1] <- latN - 0.25
  res.new$LatS[i*4-1] <- latS
  res.new$LongW[i*4] <- longW + 0.25
  res.new$LongE[i*4] <- longE
  res.new$LatN[i*4] <- latN - 0.25
  res.new$LatS[i*4] <- latS
  res.new$ResTime[(i*4-3):(i*4)] <- resTimes$ResTime[i] / 4
}

#ggplot(resTimes, aes(x = LongW, y = LatN, col = ResTime)) +
#  geom_point(shape = 15, size = 12) +
#  scale_color_viridis() +
#  theme_bw()

#ggplot(res.new, aes(x = LongW, y = LatN, col = ResTime)) +
#  geom_point(shape = 15, size = 8) +
#  scale_color_viridis() +
#  theme_bw()

#ggplot(res.new, aes(x = LongE, y = LatS, col = ResTime)) +
#  geom_point(shape = 15, size = 8) +
#  scale_color_viridis() +
#  theme_bw()

# assign res time to each station
for(i in 1:nrow(may)) {
  may$resTime[i] = res.new$ResTime[which(may$Lat[i] < res.new$LatN &
                                           may$Lat[i] >= res.new$LatS &
                                           may$Long[i] > res.new$LongW &
                                           may$Long[i] <= res.new$LongE)]
}
```

## Calculate DICair-sea
```{r}
# umol/(m^2*d) * 1/[MLD]m * m^3/[rho]kg * [res.time]days = umol/kg

may$DICf <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface" &
     !is.na(may$MLD_frac[i])) {
     may$DICf[i] = -1 * may$flux[i] / may$MLD[i] / may$Density[i] * may$resTime[i]
  }
}

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Bottom" &
     !is.na(may$MLD_frac[i]) &
     may$MLD_frac[i] > 0.9) {
     may$DICf[i] = may$DICf[which(may$Cast == "Surface" &
                                 may$Station == may$Station[i])]
  }
}
```

## Calculate air-sea O2 flux
```{r}
# Schmidt number (Wilke & Chang 1955, as adapted by Hayduk & Laudie 1974)
A = 1920.4
B = -135.6
C = 5.2122
D = -0.10939
E = 0.00093777

may$Sc.O2 <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    t = may$Temp[i]
    may$Sc.O2[i] = A + B*t + C*t^2 + D*t^3 + E*t^4
  }
}

# gas transfer velocity
may$k.O2 <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    may$k.O2[i] = 0.251 * may$wspd[i]^2 * (may$Sc.O2[i]/660)^-0.5
  }
}

# may$O2sol = O2 sol in umol/kg
may$O2sol_L <- may$O2sol * (may$Density / 1000)

may$flux.O2 <- NA

# flux
for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    k = may$k.O2[i] / 100 * 24         # cm/hr --> m/d
    d.O2 = (may$DO_L[i] - may$O2sol_L[i]) * 10^3   # umol/L --> umol/m^3
    may$flux.O2[i] = k * d.O2   # umol/(m^2*d)
  }
}

# add to bottom at fully mixed sites
for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Bottom" &
     !is.na(may$MLD_frac[i]) &
     may$MLD_frac[i] > 0.75) {
     may$flux.O2[i] = may$flux.O2[which(may$Cast == "Surface" &
                                 may$Station == may$Station[i])]
  }
}

# umol/(m^2*d) * 1/[MLD]m * m^3/[rho]kg * [res.time]days = umol/kg
may$DOf <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface" |
     (may$Cast[i] == "Bottom" &
     !is.na(may$MLD_frac[i]) &
     may$MLD_frac[i] > 0.75)) {
     may$DOf[i] = -1 * may$flux.O2[i] / may$MLD[i] / may$Density[i] * may$resTime[i]
  }
}

# add zeros to flux-absent sites for use in calcs
for(i in 1:nrow(may)) {
  if(is.na(may$DOf[i])) {
    may$DOf[i] = 0
  }
}
```

## Convert dDO to DIC & TA signals
```{r}
# subtracting O2 flux at surface & fully mixed sites
may$DOpr <- may$dDO - may$DOf

# calling the "other" component of DO negligible; therefore remaining DO is all aerobic

# dDO umol/kg * 106 (DIC) / 138 (O2) = prod/resp DIC signal
may$DICpr <- may$DOpr * -106 / 138

# dDO umol/kg * 17 (TA) / 138 (O2) = prod/resp TA signal
may$TApr <- may$DOpr * 17 / 138
```

## Calculate "other" components of DIC & TA
```{r}
for(i in 1:nrow(may)) {
  if(is.na(may$DICf[i])) {
    may$DICf[i] <- 0
  }
}

may$DIC.other <- NA
may$TA.other <- NA

may$DIC.other <- may$DIC - may$DICn - may$DICf - may$DICpr
may$TA.other = may$TA - may$TAn - may$TApr
```

## Look at unique-signal sites
```{r}
may$dDIC.ex <- NA
may$dTA.ex <- NA
may$ratio <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Bottom" &
     !is.na(may$dDIC[i]) &
     abs(may$dDIC[i]) > median(may$sdDICn, na.rm = TRUE) &
     abs(may$dDO[i]) > median(may$sdDOn, na.rm = TRUE)) {
    may$dDIC.ex[i] <- may$dDIC[i] - (may$dDO[i] * 106/-138)
    may$dTA.ex[i] <- may$dTA[i] - (may$dDO[i] * -17/-138)
    may$ratio[i] <- may$dTA.ex[i] / may$dDIC.ex[i]
  }
}

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface" &
     !is.na(may$dDIC[i]) &
     may$dTA[i] > median(may$sdTAn, na.rm = TRUE) &
     may$dDO[i] > median(may$sdDOn, na.rm = TRUE)) {
    may$dDIC.ex[i] <- may$dDIC[i] - (may$dDO[i] * 106/-138)
    may$dTA.ex[i] <- may$dTA[i] - (may$dDO[i] * -17/-138)
    may$ratio[i] <- may$dTA.ex[i] / may$dDIC.ex[i]
  }
}
```

## Look at photosynth/resp signal sites
```{r}
ggplot() +
  #geom_point(data = may, aes(x = dDIC, y = dDO, col = Cast), shape = 1) +
  geom_text(data = may, aes(x = dDIC, y = dDO, col = Cast, label = Station)) +
  geom_smooth(data = may, aes(x = dDIC, y = dDO, col = Cast), method = "lm") +
  annotate("rect", alpha = 0.2, fill = "grey50",
           xmin = -median(may$sdDICn, na.rm = TRUE),
           xmax = median(may$sdDICn, na.rm = TRUE),
           ymin = -Inf,
           ymax = Inf) +
  annotate("rect", alpha = 0.2, fill = "grey50",
           xmin = -Inf,
           xmax = -median(may$sdDICn, na.rm = TRUE),
           ymin = -median(may$sdDOn, na.rm = TRUE),
           ymax = median(may$sdDOn, na.rm = TRUE)) +
  annotate("rect", alpha = 0.2, fill = "grey50",
           xmin = median(may$sdDICn, na.rm = TRUE),
           xmax = Inf,
           ymin = -median(may$sdDOn, na.rm = TRUE),
           ymax = median(may$sdDOn, na.rm = TRUE)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_abline(slope = -138/106) +
  scale_colour_manual(values = c("royalblue", "coral"),
                     guide = guide_legend(reverse = TRUE)) +
  labs(x = expression("ΔDIC (μmol kg"^-1*")"), y = expression("ΔDO (μmol kg"^-1*")")) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text = element_text(size = 9))

may_bio <- may %>%
  filter(!(Cast == "Bottom" & Station == "001") &
         !(Cast == "Bottom" & Station == "002") &
         !(Cast == "Bottom" & Station == "083") &
         !(Cast == "Bottom" & Station == "113") &
         !(Cast == "Surface" & Station == "049"))

# 138/-106 = -1.3

model <- lm(may$dDO ~ may$dDIC) # slope = -0.5385
lm(may_bio$dDO ~ may_bio$dDIC) # slope = -0.6103

model1 <- lm(may$dDO[may$Cast == "Surface"] ~ may$dDIC[may$Cast == "Surface"]) # -0.3397
model2 <- lm(may$dDO[may$Cast == "Bottom"] ~ may$dDIC[may$Cast == "Bottom"]) # -0.6418

lm(may_bio$dDO[may_bio$Cast == "Surface"] ~ may_bio$dDIC[may_bio$Cast == "Surface"]) # -0.3832
lm(may_bio$dDO[may_bio$Cast == "Bottom"] ~ may_bio$dDIC[may_bio$Cast == "Bottom"]) # -0.7387
```

## Look at possible dissolution sites
```{r}
may %>%
  filter(Cast == "Bottom" &
         Station != "037") %>%
ggplot() +
  geom_point(aes(x = dDIC.ex, y = dTA.ex, shape = Cast, col = "May")) +
  geom_abline(slope = 2, linetype = 2) +
  #annotate("text", x = 4, y = 13, label = "2:1 line", fontface = 4) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = "chartreuse3",
                      name = "Month") +
  theme_bw()

may %>%
  filter(Cast == "Bottom" &
         Station != "037" &
         Station != "018" &
         Station != "076" &
         Station != "093") %>%
ggplot() +
  geom_point(aes(x = dDIC.ex, y = ratio, shape = Cast, col = "May")) +
  geom_hline(yintercept = 2, linetype = 2) +
  annotate("text", x = 4, y = 1.75, label = "TA:DIC = 2", fontface = 4) +
  ylab("Ratio of TA excess : DIC excess") +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = "chartreuse3",
                      name = "Month") +
  theme_bw()
```






## Calculate relative contributions from each
```{r}
for(i in 1:nrow(may)) {
  may$magnitude[i] <- sum(abs(may$DICpr[i]), abs(may$DICf[i]),
                          abs(may$DIC.other[i]))
  may$rel.DICpr[i] <- abs(may$DICpr[i]) / may$magnitude[i]
  may$rel.DICf[i] <- abs(may$DICf[i]) / may$magnitude[i]
  may$rel.DICres[i] <- abs(may$DIC.other[i]) / may$magnitude[i]
  # check sums
  #may$rel.sum[i] <- sum(may$rel.DICpr[i], may$rel.DICf[i], may$rel.DICres[i])
  may$magnitudeT[i] <- sum(abs(may$TApr[i]), abs(may$TA.other[i]))
  may$rel.TApr[i] <- abs(may$TApr[i]) / may$magnitudeT[i]
  may$rel.TAres[i] <- abs(may$TA.other[i]) / may$magnitudeT[i]
  # check sums
  #may$rel.sum[i] <- sum(may$rel.TApr[i], may$rel.TAres[i])
}
```






# Surface: triangle

## Bayesian mixing model 1m
```{r}
# create mixture data: surface data w/ NAs excluded
read.csv("./data/MayCruiseData.csv") %>%
  rename(Temp = Temperature) %>%
  filter(Cast == "Surface",
         !is.na(Temp) &
         Station != 58 &   # remove possible outlier sites for model integrity
         Station != 29 &
         Station != 47 &
         Station != 2) %>%
  write_csv("./mixing/MayCruiseData_surface.csv")

# load mixture data
mix <- load_mix_data(filename = "./mixing/MayCruiseData_surface.csv", 
                     iso_names = c("Salinity", "Temp"),
                     factors = "Station",
                     fac_random = FALSE, # indiv. station is fixed effect
                     fac_nested = NULL,
                     cont_effects = NULL)

# create source data
EM <- c("EM1", "EM2", "EM3")
MeanTemp <- c(mean_temp_EMs1, mean_temp_EMs2, mean_temp_EMs3)
SDTemp <- c(err_temp_EMs1, err_temp_EMs2, err_temp_EMs3)
MeanSalinity <- c(mean_sal_EMs1, mean_sal_EMs2, mean_sal_EMs3)
SDSalinity <- c(err_sal_EMs1, err_sal_EMs2, err_sal_EMs3)
n <- c(length(EMs1), length(EMs2), length(EMs3))

write.csv(cbind(EM, MeanTemp, SDTemp,
                MeanSalinity, SDSalinity, n), "./mixing/sources_surface.csv",
          row.names = FALSE)

# load source data
source <- load_source_data(filename = "./mixing/sources_surface.csv",
                           source_factors = NULL, 
                           conc_dep = FALSE, 
                           data_type = "means", 
                           mix)

# create discrimination data: 0 because conservative parameters
MeanTemp <- rep(0, 3)
SDTemp <- rep(0, 3)
MeanSalinity <- rep(0, 3)
SDSalinity <- rep(0, 3)

write.csv(cbind(EM, MeanTemp, SDTemp,
                MeanSalinity, SDSalinity), "./mixing/discr_surface.csv",
          row.names = FALSE)

# load discrimination data
discr <- load_discr_data(filename = "./mixing/discr_surface.csv", mix)
```

## Make isospace plot & choose prior
```{r}
iso <- plot_data(filename = "isospace_plot", plot_save_pdf = FALSE,
                 plot_save_png = FALSE, mix, source, discr, return_obj = TRUE)
iso + theme(legend.position = "none") +
  scale_x_continuous(limits = c(32.2, 33.2)) +
  scale_y_continuous(limits = c(6.9, 9))

calc_area(source = source, mix = mix, discr = discr) # 263.1986

# uninformative (technically "generalist") prior (alpha = 1)
# Dirichlet distribution: all sources treated independently but must sum to 1 (Gelman et al. 2003)
plot_prior(alpha.prior = 1, source, plot_save_pdf = FALSE, plot_save_png = TRUE)
```

## Write model
```{r}
model_filename <- "./surface_model_may.txt"
resid_err <- FALSE # because n=1 per Station
process_err <- TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)

run <- list(chainLength = 3000000, burn = 1500000, thin = 500, chains = 3,
            calcDIC = TRUE)
jags.1m <- run_model(run, mix, source, discr, model_filename, alpha.prior = 1)
```

## Check for convergence
```{r}
output_options1m <- list(summary_save = TRUE,
                       summary_name = "summary_statistics1m",
                       sup_post = TRUE,
                       plot_post_save_pdf = FALSE,
                       plot_post_name = "posterior_density1m",
                       sup_pairs = TRUE,
                       plot_pairs_save_pdf = FALSE,
                       plot_pairs_name = "pairs_plot1m",
                       sup_xy = FALSE,
                       plot_xy_save_pdf = FALSE,
                       plot_xy_name = "xy_plot1m",
                       gelman = TRUE,
                       heidel = FALSE,
                       geweke = TRUE,
                       diag_save = TRUE,
                       diag_name = "diagnostics1m",
                       indiv_effect = FALSE,
                       plot_post_save_png = FALSE,
                       plot_pairs_save_png = FALSE,
                       plot_xy_save_png = FALSE,
                       diag_save_ggmcmc = FALSE,
                       return_obj = TRUE)

options(max.print = 3000) # change global option
output_JAGS(jags.1m, mix, source, output_options1m)

diag <- output_diagnostics(jags.1m, mix, source, output_options1m)
df.stats <- output_stats(jags.1m, mix, source, output_options1m)
g.post <- output_posteriors(jags.1m, mix, source, output_options1m)

g.post$fac1[[33]]

# Gelman diagnostic should be < 1.05
# 26; 4; 0

# Geweke diagnostic should have ~5% outside +/-1.96 (~31-32/634) in each chain
# 19 / 31 / 66
```

## Plots for 1m
```{r}
ggplot(may[may$Cast == "Surface", ]) +
  geom_point(aes(x = Salinity, y = Temp, col = EM1)) +
  scale_colour_viridis(option = "viridis") +
  theme_bw()

ggplot(may[may$Cast == "Surface", ]) +
  geom_point(aes(x = Salinity, y = Temp, col = EM2)) +
  scale_colour_viridis(option = "viridis") +
  theme_bw()

ggplot(may[may$Cast == "Surface", ]) +
  geom_point(aes(x = Salinity, y = Temp, col = EM3)) +
  scale_colour_viridis(option = "viridis") +
  theme_bw()



ggplot(may[may$Cast == "Surface", ]) +
  #geom_point(aes(x = a1, y = EM1)) +
  geom_text(aes(x = a1, y = EM1, label = Station)) +
  geom_abline(slope = 1) +
  theme_bw()

ggplot(may[may$Cast == "Surface", ]) +
  #geom_point(aes(x = a2, y = EM2)) +
  geom_text(aes(x = a2, y = EM2, label = Station)) +
  geom_abline(slope = 1) +
  theme_bw()

ggplot(may[may$Cast == "Surface", ]) +
  #geom_point(aes(x = a3, y = EM3)) +
  geom_text(aes(x = a3, y = EM3, label = Station)) +
  geom_abline(slope = 1) +
  theme_bw()
```

# Bottom: quadrangle

## Bayesian mixing model 2m
```{r}
# create mixture data: bottom data w/ NAs & slope sites excluded
read.csv("./data/MayCruiseData.csv") %>%
  rename(Temp = Temperature) %>%
  filter(Cast == "Bottom",
         !is.na(Temp),
         Station != 1 &
         Station != 2 &
         Station != 3 &
         Station != 4 &
         Station != 113) %>%
  write_csv("./mixing/MayCruiseData_bottom.csv")

# load mixture data
mix <- load_mix_data(filename = "./mixing/MayCruiseData_bottom.csv", 
                     iso_names = c("Salinity", "Temp"),
                     factors = "Station",
                     fac_random = FALSE, # indiv. station is fixed effect
                     fac_nested = NULL,
                     cont_effects = NULL)

# create source data
EM <- c("EM4", "EM5", "EM6", "EM7")
MeanTemp <- c(mean_temp_EMs4, mean_temp_EMs5, mean_temp_EMs6, mean_temp_EMs7)
SDTemp <- c(err_temp_EMs4, err_temp_EMs5, err_temp_EMs6, err_temp_EMs7)
MeanSalinity <- c(mean_sal_EMs4, mean_sal_EMs5, mean_sal_EMs6, mean_sal_EMs7)
SDSalinity <- c(err_sal_EMs4, err_sal_EMs5, err_sal_EMs6, err_sal_EMs7)
n <- c(length(EMs4), length(EMs5), length(EMs6), 2)

write.csv(cbind(EM, MeanTemp, SDTemp,
                MeanSalinity, SDSalinity, n), "./mixing/sources_bottom.csv",
          row.names = FALSE)

# load source data
source <- load_source_data(filename = "./mixing/sources_bottom.csv",
                           source_factors = NULL, 
                           conc_dep = FALSE, 
                           data_type = "means", 
                           mix)

# create discrimination data: 0 because conservative parameters
MeanTemp <- rep(0, 4)
SDTemp <- rep(0, 4)
MeanSalinity <- rep(0, 4)
SDSalinity <- rep(0, 4)

write.csv(cbind(EM, MeanTemp, SDTemp,
                MeanSalinity, SDSalinity), "./mixing/discr_bottom.csv",
          row.names = FALSE)

# load discrimination data
discr <- load_discr_data(filename = "./mixing/discr_bottom.csv", mix)
```

## Make isospace plot & choose prior
```{r}
iso <- plot_data(filename = "isospace_plot", plot_save_pdf = FALSE,
                 plot_save_png = FALSE, mix, source, discr, return_obj = TRUE)
iso + theme(legend.position = "none")

calc_area(source = source, mix = mix, discr = discr) # 93.34312 # 170.8278 (4 EM)

# uninformative (technically "generalist") prior (alpha = 1)
# Dirichlet distribution: all sources treated independently but must sum to 1 (Gelman et al. 2003)
plot_prior(alpha.prior = 1, source, plot_save_pdf = FALSE, plot_save_png = TRUE)
```

## Write model
```{r}
model_filename <- "./bottom_model_may.txt"
resid_err <- FALSE # because n=1 per Station
process_err <- TRUE
write_JAGS_model(model_filename, resid_err, process_err, mix, source)

run <- list(chainLength = 3000000, burn = 1500000, thin = 500, chains = 3,
            calcDIC = TRUE)
jags.2m <- run_model(run, mix, source, discr, model_filename, alpha.prior = 1)
```

## Check for convergence
```{r}
output_options2m <- list(summary_save = TRUE,
                       summary_name = "summary_statistics2m",
                       sup_post = TRUE,
                       plot_post_save_pdf = FALSE,
                       plot_post_name = "posterior_density2m",
                       sup_pairs = TRUE,
                       plot_pairs_save_pdf = FALSE,
                       plot_pairs_name = "pairs_plot2m",
                       sup_xy = FALSE,
                       plot_xy_save_pdf = FALSE,
                       plot_xy_name = "xy_plot2m",
                       gelman = TRUE,
                       heidel = FALSE,
                       geweke = TRUE,
                       diag_save = TRUE,
                       diag_name = "diagnostics2m",
                       indiv_effect = FALSE,
                       plot_post_save_png = FALSE,
                       plot_pairs_save_png = FALSE,
                       plot_xy_save_png = FALSE,
                       diag_save_ggmcmc = FALSE,
                       return_obj = TRUE)

options(max.print = 10000) # change global option
output_JAGS(jags.2m, mix, source, output_options2m)

diag <- output_diagnostics(jags.2m, mix, source, output_options2m)
df.stats <- output_stats(jags.2m, mix, source, output_options2m)
g.post <- output_posteriors(jags.2m, mix, source, output_options2m)

g.post$fac1[[1]]

# Gelman diagnostic should be < 1.05
# 581; 440; 380   # good GRIEF what happened here
# 9; 0; 0 *good convergence; not great output
# 3; 0; 0

# Geweke diagnostic should have ~5% outside +/-1.96 (40-41/813) in each chain
# 43 / 29 / 35
# 37 / 28 / 33 *good convergence; not great output
# 30 / 84 / 105
```

## Plots for 2m
```{r}
ggplot(may[may$Cast == "Bottom", ]) +
  geom_point(aes(x = Salinity, y = Temp, col = EM4)) +
  scale_colour_viridis(option = "viridis") +
  theme_bw()

ggplot(may[may$Cast == "Bottom", ]) +
  geom_point(aes(x = Salinity, y = Temp, col = EM5)) +
  scale_colour_viridis(option = "viridis") +
  theme_bw()

ggplot(may[may$Cast == "Bottom", ]) +
  geom_point(aes(x = Salinity, y = Temp, col = EM6)) +
  scale_colour_viridis(option = "viridis") +
  theme_bw()

ggplot(may[may$Cast == "Bottom", ]) +
  geom_point(aes(x = Salinity, y = Temp, col = EM7)) +
  scale_colour_viridis(option = "viridis", breaks = c(0.25, 0.5, 0.75)) +
  theme_bw()



ggplot(may[may$Cast == "Bottom", ]) +
  #geom_point(aes(x = a4, y = EM4)) +
  geom_text(aes(x = a4, y = EM4, label = Station)) +
  geom_abline(slope = 1) +
  theme_bw()

ggplot(may[may$Cast == "Bottom", ]) +
  #geom_point(aes(x = a5, y = EM5)) +
  geom_text(aes(x = a5, y = EM5, label = Station)) +
  geom_abline(slope = 1) +
  theme_bw()

ggplot(may[may$Cast == "Bottom", ]) +
  #geom_point(aes(x = a6, y = EM6)) +
  geom_text(aes(x = a6, y = EM6, label = Station)) +
  geom_abline(slope = 1) +
  theme_bw()

ggplot(may[may$Cast == "Bottom", ]) +
  #geom_point(aes(x = a7, y = EM7)) +
  geom_text(aes(x = a7, y = EM7, label = Station)) +
  geom_abline(slope = 1) +
  theme_bw()
```




## *OLD* Calculate contributions from each EM (triangles, not quadrangle)
```{r}
may$a1 <- NA
may$a2 <- NA
may$a3 <- NA
may$a4 <- NA
may$a5 <- NA
may$a6 <- NA
may$a7 <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
       may$a3[i] = (may$Salinity[i] - S1 - may$Temp[i]*(S2-S1)/(T2-T1) +
             T1*(S2-S1)/(T2-T1)) /
            ((S3-S1) - (T3-T1)*(S2-S1)/(T2-T1))
       may$a2[i] = (may$Temp[i] - T1 - may$a3[i]*(T3-T1)) / (T2-T1)
       may$a1[i] = 1 - (may$a2[i] + may$a3[i])
     } else if(may$Station[i] != "059" &
               may$Station[i] != "064" &
               may$Station[i] != "087" &
               may$Station[i] != "053" &
               may$Station[i] != "086" &
               may$Station[i] != "063" &
               may$Station[i] != "047" &
               may$Station[i] != "043" &
               may$Station[i] != "077" &
               may$Station[i] != "076" &
               may$Station[i] != "081" &
               may$Station[i] != "093" &
               may$Station[i] != "078" &
               may$Station[i] != "072" &
               may$Station[i] != "060" &
               may$Station[i] != "058" &
               may$Station[i] != "049" &
               may$Station[i] != "069"){
       may$a6[i] = (may$Salinity[i] - S4 - may$Temp[i]*(S5-S4)/(T5-T4) +
             T4*(S5-S4)/(T5-T4)) /
            ((S6-S4) - (T6-T4)*(S5-S4)/(T5-T4))
       may$a5[i] = (may$Temp[i] - T4 - may$a6[i]*(T6-T4)) / (T5-T4)
       may$a4[i] = 1 - (may$a5[i] + may$a6[i])
     } else {
       may$a7[i] = (may$Salinity[i] - S5) / (S7 - S5)
       may$a5[i] = 1 - may$a7[i]
     }
}
```



## *OLD* Calculate mixing-normalized DIC & TA values
```{r}
may$DICn <- NA
may$TAn <- NA
may$dDIC <- NA
may$dTA <- NA

## processes used to solve the system of eq is at the end of this script &/or chemistry_Oct script

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
       may$DICn[i] = may$a1[i]*DIC1 + may$a2[i]*DIC2 + may$a3[i]*DIC3
       may$dDIC[i] = may$DIC[i] - may$DICn[i]   # observed - expected
       may$TAn[i] = may$a1[i]*TA1 + may$a2[i]*TA2 + may$a3[i]*TA3
       may$dTA[i] = may$TA[i] - may$TAn[i]   # observed - expected
     } else {
       may$DICn[i] = may$a4[i]*DIC4 + may$a5[i]*DIC5 + may$a6[i]*DIC6 +
         may$a7[i]*DIC7
       may$dDIC[i] = may$DIC[i] - may$DICn[i]   # observed - expected
       may$TAn[i] = may$a4[i]*TA4 + may$a5[i]*TA5 + may$a6[i]*TA6 + may$a7[i]*TA7
       may$dTA[i] = may$TA[i] - may$TAn[i]   # observed - expected
     }
}
```

## *OLD* O2 mixing analysis
```{r}
DO1 <- may$DO[EM1]
DO2 <- may$DO[EM2]
DO3 <- may$DO[EM3]

DO4 <- may$DO[EM4]
DO5 <- may$DO[EM5]
DO6 <- may$DO[EM6]
DO7 <- may$DO[EM7]

may$DOn <- NA
may$dDO <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    may$DOn[i] = may$a1[i]*DO1 + may$a2[i]*DO2 + may$a3[i]*DO3
    may$dDO[i] = may$DO[i] - may$DOn[i]   # observed - expected
  } else {
       may$DOn[i] = may$a4[i]*DO4 + may$a5[i]*DO5 + may$a6[i]*DO6 + may$a7[i]*DO7
       may$dDO[i] = may$DO[i] - may$DOn[i]   # observed - expected
    }
}
```

## Calculate CO2 atm equilibration time
```{r}
eqCO2sys <- carb(flag = 24,                               # pCO2 and ALK given
                 var1 = 420,
                 var2 = may$TA / 10^6,                    # in mol/kg
                 S = may$Salinity,
                 T = may$Temp,
                 Patm = may$Pressure * 0.098692326671601, # in atm
                 P = may$SeaPressure / 10,                # in bar
                 k1k2 = "l",
                 ks = "d",
                 b = "l10")

may$eqDIC <- NA
may$d <- NA

for(i in 1:nrow(may)) {
  if(may$Cast[i] == "Surface") {
    may$eqDIC[i] = eqCO2sys$DIC[i] * 10^6
    may$d[i] = (may$DIC[i] - may$eqDIC[i]) /
                (may$flux[i] / may$MLD[i]) * may$Density[i]
  }
}
```





















## Start by using Oct end-members
```{r}
# surface: 5, 7, 43 EMs

may %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = Salinity, y = Temp, col = Cast)) +
    geom_text(aes(label = as.integer(Station)), size = 3) +
    geom_point(data = may[((may$Station == "005" |
                            may$Station == "007" |
                            may$Station == "043") &
                            may$Cast == "Surface"), ],
               aes(x = Salinity, y = Temp),
               shape = 1, col = "black", size = 6, inherit.aes = FALSE) +
    scale_colour_manual(values = "coral2") +
    theme_bw()

library(grid)
grid.force()  # make grobs visible to grid editing tools
grid.edit("geom_point.points", grep = TRUE, gp = gpar(lwd = 2))

# bottom: 9, 33, 53 EMs

may %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Salinity, y = Temp, col = Cast)) +
    geom_text(aes(label = as.integer(Station)), size = 3) +
    geom_point(data = may[((may$Station == "009" |
                            may$Station == "033" |
                            may$Station == "053") &
                            may$Cast == "Bottom"), ],
               aes(x = Salinity, y = Temp),
               shape = 1, col = "red", size = 6, inherit.aes = FALSE) +
    scale_colour_manual(values = "darkblue") +
    theme_bw()

grid.force()  # make grobs visible to grid editing tools
grid.edit("geom_point.points", grep = TRUE, gp = gpar(lwd = 2))
```

## Solve two-variable system
```{r}
#a5 + a7 = 1
#a5 = 1 - a7

#a5*S5 + a7*S7 = may$Salinity[i]
#(1 - a7)*S5 + a7*S7 = may$Salinity[i]
#S5 - a7*S5 + a7*S7 = may$Salinity[i]
# -a7*S5 + a7*S7 = may$Salinity[i] - S5
#a7 * (S7 - S5) = may$Salinity[i] - S5
#a7 = (may$Salinity[i] - S5) / (S7 - S5)
```

## Compare May vs Oct coordinates
Run chunks 1-7 of `Chemistry_Oct.Rmd` to load October data.
```{r}
joined <- left_join(may, oct, by = c("Station", "Cast"), suffix = c("_may", "_oct")) %>%
  mutate(diffLat = abs(mayLat - octLat), diffLong = abs(mayLong - octLong))

max(joined$diffLat)
max(joined$diffLong)
which(joined$diffLat > 0.05)
which(joined$diffLong > 0.05)
```
