---
title: "MayCruiseChemistry"
author: "Dylan Titmuss"
date: "1/19/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script visualizes the chemistry data from the May RSA cruise.
Run chunks 1-7 of `chemistry_May.Rmd` to load data.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")

library(tidyverse)
library(sf)
library(nngeo)
#library(viridis)
#library(RColorBrewer)
#library(pals)
library(cowplot)
```

## Load GB shapefiles
```{r}
GB <- st_read("./data/2020SAMZones/GB_Estimation_Areas_2019_UTM19_PDT_SFModified.shp")

# subset shapefile to SAMs
NLS_North <- subset(GB, NewSAMS == "NLS-North") %>%
  fortify()
CL1_South <- subset(GB, NewSAMS == "CL1-South") %>%
  fortify()
CL1_Sliver <- subset(GB, NewSAMS == "CL1-Sliver") %>%
  fortify()
CL2_AccessSoutheast <- subset(GB, NewSAMS == "CL2-Access-Southeast") %>%
  fortify()
SF <- subset(GB, NewSAMS == "SF") %>%
  fortify()
CL2_North <- subset(GB, NewSAMS == "CL2-North") %>%
  fortify()
CL1_Access <- subset(GB, NewSAMS == "CL1-Access") %>%
  fortify()
NF <- subset(GB, NewSAMS == "NF") %>%
  fortify()
CL2_Ext <- subset(GB, NewSAMS == "CL2-Ext") %>%
  fortify()
GSC <- subset(GB, NewSAMS == "GSC") %>%
  fortify()
NLS_SouthDeep <- subset(GB, NewSAMS == "NLS-South-Deep") %>%
  fortify()
NLS_West <- subset(GB, NewSAMS == "NLS-West") %>%
  fortify()
NLS_SouthShallow <- subset(GB, NewSAMS == "NLS-South-Shallow") %>%
  fortify()
CL2_AccessSouthwest <- subset(GB, NewSAMS == "CL2-Access-Southwest") %>%
  fortify()
SF_East <- subset(GB, NewSAMS == "SF-East") %>%
  fortify()

# combine polygons and set CRS
GB_sf <- st_union(NLS_North, CL1_South) %>%
  st_union(CL1_Sliver) %>%
  st_union(CL2_AccessSoutheast) %>%
  st_union(SF) %>%
  st_union(CL2_North) %>%
  st_union(CL1_Access) %>%
  st_union(NF) %>%
  st_union(CL2_Ext) %>%
  st_union(GSC) %>%
  st_union(NLS_SouthDeep) %>%
  st_union(NLS_West) %>%
  st_union(NLS_SouthShallow) %>%
  st_union(CL2_AccessSouthwest) %>%
  st_union(SF_East) %>%
  st_remove_holes()
  
#summary(GB_sf)
```

## Create coastline polygon
```{r}
# turn off spherical geometry to avoid "duplicate vertex" errors
sf_use_s2(FALSE)

# get Massachusetts coastline
mass <- read_sf("/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/gshhg-shp-2.3.7/GSHHS_shp/f/GSHHS_f_L1.shp") %>%
  st_make_valid() %>%
  st_crop(xmin = -71, xmax = -66, ymin = 40, ymax = 43)
```

## *RUN ONCE* Tweak coords to fit within polygon
```#{r}
may <- may %>%
  mutate(Long = ifelse(Station == "006", Long + 0.06, Long),
         Lat = ifelse(Station == "026", Lat + 0.02, Lat),
         Long = ifelse(Station == "089", Long - 0.04, Long))
```

## Create simple features object of chem data
```{r}
# create geometry column in data frame from lat/long data
for(i in 1:nrow(may)) {
  may$geometry[i] <- st_point(x = c(may$Long[i], may$Lat[i])) %>%
    st_sfc(crs = 4326)
}

# create an sf object from data frame
station_sf_m <- st_sf(may, crs = 4326)

bottom_sf_m <- station_sf_m %>%
  filter(Cast == "Bottom")

surface_sf_m <- station_sf_m %>%
  filter(Cast == "Surface")
```

## Begin interpolation round 1 (nearest-neighbor)
```{r}
bottom_sf_m_geom <- st_union(bottom_sf_m) %>%
  st_transform(crs = 26919)
bottom_sf_m_v <- st_voronoi(bottom_sf_m_geom)
bottom_sf_m_v <- st_sf(bottom_sf_m_v)

surface_sf_m_geom <- st_union(surface_sf_m) %>%
  st_transform(crs = 26919)
surface_sf_m_v <- st_voronoi(surface_sf_m_geom)
surface_sf_m_v <- st_sf(surface_sf_m_v)

# mask Voronoi with contour
bottom_sf_m_v <- st_intersection(st_cast(bottom_sf_m_v),
                                 st_union(st_buffer(GB_sf, dist = 500)))
bottom_sf_m_v <- st_sf(bottom_sf_m_v)

#st_crs(bottom_sf_m_v)

bottom_sf_m2 <- bottom_sf_m %>%
  st_transform(crs = 26919)

surface_sf_m_v <- st_intersection(st_cast(surface_sf_m_v),
                                  st_union(st_buffer(GB_sf, dist = 500)))
surface_sf_m_v <- st_sf(surface_sf_m_v)

#st_crs(surface_sf_m_v)

surface_sf_m2 <- surface_sf_m %>%
  st_transform(crs = 26919)

# complete spatial join
bottom_sf_m_v2 <- st_join(bottom_sf_m_v, bottom_sf_m2)
#glimpse(bottom_sf_m_v2)
surface_sf_m_v2 <- st_join(surface_sf_m_v, surface_sf_m2)
```

## Create simple features objects for 3 central points
```{r}
bottom_sf_m3 <- bottom_sf_m2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")

surface_sf_m3 <- surface_sf_m2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")
```

## Find property ranges
(move this once DIC & TA data finalized)
```{r}
# Temp
min(bottom_sf_m2$Temp) # 6.717487
min(surface_sf_m2$Temp) # 6.962792
max(bottom_sf_m2$Temp) # 10.08
max(surface_sf_m2$Temp) # 8.874117

# Sal
min(bottom_sf_m2$Salinity) # 32.4468
min(surface_sf_m2$Salinity) # 32.2949
max(bottom_sf_m2$Salinity) # 34.3967
max(surface_sf_m2$Salinity) # 33.3611

# DIC
min(bottom_sf_m2$DIC, na.rm = T) # 2025.4
min(surface_sf_m2$DIC) # 2011.3
max(bottom_sf_m2$DIC, na.rm = T) # 2137.4
max(surface_sf_m2$DIC) # 2082

# TA
min(bottom_sf_m2$TA) # 2195.2
min(surface_sf_m2$TA) # 2181.3
max(bottom_sf_m2$TA) # 2291.8
max(surface_sf_m2$TA) # 2234.9

# DO
min(bottom_sf_m2$DO) # 230.2369
min(surface_sf_m2$DO) # 290.0381
max(bottom_sf_m2$DO) # 315.6619
max(surface_sf_m2$DO) # 327.9873

# pH
min(bottom_sf_m2$pH) # 7.958693
min(surface_sf_m2$pH) # 8.004006
  #max(bottom_sf_m2$pH) # 8.233965
sort(bottom_sf_m2$pH, decreasing = TRUE)[2] # 8.141957
max(surface_sf_m2$pH) # 8.169728

# pCO2
min(surface_sf_m2$pCO2) # 280.099
max(surface_sf_m2$pCO2) # 431.2981

# OmegaAragonite
min(bottom_sf_m2$OmegaAragonite) # 1.447342
min(surface_sf_m2$OmegaAragonite) # 1.573476
max(bottom_sf_m2$OmegaAragonite) # 2.499535
max(surface_sf_m2$OmegaAragonite) # 2.243901

# AOU
min(bottom_sf_m2$AOU) # -20.55341
min(surface_sf_m2$AOU) # -36.91533
max(bottom_sf_m2$AOU) # 45.65093
max(surface_sf_m2$AOU) # 7.334928
```

## Interpolated bottom plots
```{r}
ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  #scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
  #                     aesthetics = c("fill", "colour")) +
  scale_fill_viridis(option = "viridis", limits = c(6, 21),
                     aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Temperature [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(31, 36), palette = "OrRd",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"),
                       guide = guide_colorbar(reverse = TRUE)) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Salinity [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket", direction = -1,
                     aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Alkalinity [May]") +
  theme_bw()

# ***DO

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "viridis",
                     aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom pH [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = pCO2), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = pCO2), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(280, 560), palette = "RdBu",
                       aesthetics = c("fill", "colour"),
                       name = bquote(italic("p"~CO[2])),
                       breaks = c(300, 420, 540)) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom pCO2 [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.15), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour"), name = "Ω Aragonite") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Aragonite [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = AOU), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = AOU), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-45, 45), palette = "BrBG",
                       breaks = c(-40, -20, 0, 20, 40),
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom AOU [May]") +
  theme_bw()



ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = OmegaCalcite), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = OmegaCalcite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2, 4.8), option = "mako",
                     aesthetics = c("fill", "colour"), name = "Ω Calcite") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  geom_label(aes(x = 722500, y = 4700000, label = "Bottom"), size = 5, fontface = "bold",
             label.size = 0.75, label.padding = unit(0.5, "lines")) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(title = "Bottom Calcite [May]")
```

## Interpolated surface plots
```{r}
ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Temperature [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(31, 36), palette = "OrRd",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"),
                       guide = guide_colorbar(reverse = TRUE)) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Salinity [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket", direction = -1,
                     aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako", direction = -1,
                     aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Alkalinity [May]") +
  theme_bw()

# ***DO

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "viridis",
                     aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface pH [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = pCO2), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = pCO2), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(300, 500), option = "viridis",
                       aesthetics = c("fill", "colour"),
                       name = bquote(italic("p"~CO[2]))) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface pCO2 [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.1), option = "mako",
                     aesthetics = c("fill", "colour"), name = "Ω Aragonite") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Aragonite [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = AOU), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = AOU), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-46, 46), palette = "BrBG",
                       breaks = c(-40, -20, 0, 20, 40),
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface AOU [May]") +
  theme_bw()



ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = OmegaCalcite), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = OmegaCalcite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2, 4.8), option = "mako",
                     aesthetics = c("fill", "colour"), name = "Ω Calcite") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  geom_label(aes(x = 721500, y = 4700000, label = "Surface"), size = 5, fontface = "bold",
             label.size = 0.75, label.padding = unit(0.5, "lines")) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) #+
  labs(title = "Surface Calcite [May]")
```

### DELTAs & SUBSEQUENT

## Bounds
```{r}
# dDIC
min(bottom_sf_m2$dDIC, na.rm = T) # -38.84535
min(surface_sf_m2$dDIC, na.rm = T) # -40.2324
max(bottom_sf_m2$dDIC, na.rm = T) # 24.0616
max(surface_sf_m2$dDIC, na.rm = T) # 17.07787

# dTA
min(bottom_sf_m2$dTA, na.rm = T) # -12.5855
min(surface_sf_m2$dTA, na.rm = T) # -34.19153
max(bottom_sf_m2$dTA, na.rm = T) # 18.62525
max(surface_sf_m2$dTA, na.rm = T) # 21.471

# dDO
min(bottom_sf_m2$dDO, na.rm = T) # -15.8071
min(surface_sf_m2$dDO, na.rm = T) # -9.423136
max(bottom_sf_m2$dDO, na.rm = T) # 27.54872
max(surface_sf_m2$dDO, na.rm = T) # 26.71113

# flux
min(surface_sf_m2$flux) # -12274.61
max(surface_sf_m2$flux) # 1269.434

# DICf
min(surface_sf_m2$DICf, na.rm = T) # -0.09396105
max(surface_sf_m2$DICf, na.rm = T) # 0.9140467

# DICpr
min(bottom_sf_m2$DICpr, na.rm = T) # -21.64824
min(surface_sf_m2$DICpr, na.rm = T) # -21.39933
max(bottom_sf_m2$DICpr, na.rm = T) # 12.14169
max(surface_sf_m2$DICpr, na.rm = T) # 7.230801

# DIC.other
  #min(bottom_sf_m2$DIC.other, na.rm = T) # -35.582 - outlier
sort(bottom_sf_m2$DIC.other)[2] # -24.72294
  #min(surface_sf_m2$DIC.other, na.rm = T) # -40.77136
sort(surface_sf_m2$DIC.other)[2] # 21.59619
max(bottom_sf_m2$DIC.other, na.rm = T) # 15.92587
max(surface_sf_m2$DIC.other, na.rm = T) # 18.23345

# TApr
min(bottom_sf_m2$TApr, na.rm = T) # -1.947252
min(surface_sf_m2$TApr, na.rm = T) # -1.159657
max(bottom_sf_m2$TApr, na.rm = T) # 3.471888
max(surface_sf_m2$TApr, na.rm = T) # 3.431967

# TA.other
min(bottom_sf_m2$TA.other, na.rm = T) # -15.06976
min(surface_sf_m2$TA.other, na.rm = T) # -33.88
max(bottom_sf_m2$TA.other, na.rm = T) # 19.98476
max(surface_sf_m2$TA.other, na.rm = T) # 20.35492

# dDIC.ex
min(surface_sf_m2$dDIC.ex, na.rm = T) # 
max(surface_sf_m2$dDIC.ex, na.rm = T) # 

min(bottom_sf_m2$dDIC.ex, na.rm = T) # -21.31475
max(bottom_sf_m2$dDIC.ex, na.rm = T) # 15.92587

# dTA.ex
min(surface_sf_m2$dTA.ex, na.rm = T) # 
max(surface_sf_m2$dTA.ex, na.rm = T) # 

min(bottom_sf_m2$dTA.ex, na.rm = T) # -14.99582
max(bottom_sf_m2$dTA.ex, na.rm = T) # 18.67412

# ratio
min(surface_sf_m2$ratio, na.rm = T) # 
max(surface_sf_m2$ratio, na.rm = T) # 

  #min(bottom_sf_m2$ratio, na.rm = T) # -161.231
sort(bottom_sf_m2$ratio)[2] # -0.8398407
max(bottom_sf_m2$ratio, na.rm = T) # 11.22484
sort(bottom_sf_m2$ratio, decreasing = TRUE)[2] # 4.300416
```

## Bottom plots
```{r}
ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = dDIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-40, 40), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom dDIC [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = flux / 10^3), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = flux / 10^3), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-12.5, 12.5), palette = "BrBG",
                       aesthetics = c("fill", "colour"),
                       name = "CO2 flux\n(mmol/m^2/d)") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom CO2 flux [May]") +
  theme_bw() +
  theme(legend.title = element_text(face = "bold"))

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DICf), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = DICf), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-52, 52), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC_flux [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DICpr), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = DICpr), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-23, 23), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC_bio [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DIC.other), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = DIC.other), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-54, 54), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC_residual [May]") +
  theme_bw()
```

## Surface plots
```{r}
ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = dDIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-40, 40), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface dDIC [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = flux / 10^3), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = flux / 10^3), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-12.5, 12.5), palette = "BrBG",
                       aesthetics = c("fill", "colour"),
                       name = "CO2 flux\n(mmol/m^2/d)") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface CO2 flux [May]") +
  theme_bw() +
  theme(legend.title = element_text(face = "bold"))

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DICf), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = DICf), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-2.5, 2.5), #palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC_flux [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = flux.O2 / 10^3), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = flux.O2 / 10^3), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-50, 50), palette = "BrBG",
                       aesthetics = c("fill", "colour"),
                       name = "O2 flux\n(mmol/m^2/d)") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface O2 flux [May]") +
  theme_bw() +
  theme(legend.title = element_text(face = "bold"))

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DICpr), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = DICpr), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-100, 100), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC_bio [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DIC.other), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = DIC.other), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-54, 54), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC_residual [May]") +
  theme_bw()
```

## Bottom plots
```{r}
ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dTA), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = dTA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-34, 34), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom dTA [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = TApr), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = TApr), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-4, 4), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom TA_bio [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = TA.other), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = TA.other), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-34, 34), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom TA_residual [May]") +
  theme_bw()
```

## Surface plots
```{r}
ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = dTA), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = dTA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-34, 34), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface dTA [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = TApr), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = TApr), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-4, 4), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface TA_bio [May]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = TA.other), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = TA.other), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-34, 34), palette = "RdBu",
                       aesthetics = c("fill", "colour")) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface TA_residual [May]") +
  theme_bw()
```

## Paper figures

## 8-panel relative contribution maps (May)
```{r}
dDIC <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(fill = dDIC), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-50.62, 50.62),
                       aesthetics = c("fill", "colour"),
                       name = "ΔDIC") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  labs(title = "Surface") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold.italic", hjust = 0.5, size = 12),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

DICpr <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DICpr), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m_v2[surface_sf_m_v2$Station == "096", ],
          fill = "grey8",
          size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(fill = DICpr), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-24.58, 24.58),
                       aesthetics = c("fill", "colour"),
                       name = expression(bold("DIC"["bio"]))) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Surface DIC_bio [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

DICf <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DICf), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m_v2[(surface_sf_m_v2$Station == "037" | surface_sf_m_v2$Station == "089" | surface_sf_m_v2$Station == "096"), ],
          fill = "grey8",
          size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(fill = DICf), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-1.55, 1.55),
                       breaks = c(-1.4, -0.7, 0, 0.7, 1.4),
                       aesthetics = c("fill", "colour"),
                       name = expression(bold("DIC"["air-sea"]))) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Surface DIC_flux [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

DICo <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = DIC.other), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(fill = DIC.other), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-40.83, 40.83),
                       aesthetics = c("fill", "colour"),
                       name = "ε") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Surface DIC_residual [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 11),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

dDIC2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(fill = dDIC), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-50.62, 50.62),
                       aesthetics = c("fill", "colour"),
                       name = "ΔDIC") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  labs(title = "Bottom") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold.italic", hjust = 0.5, size = 12),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

DICpr2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DICpr), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(fill = DICpr), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-24.58, 24.58),
                       breaks = c(-50, -25, 0, 25, 50),
                       aesthetics = c("fill", "colour"),
                       name = "Bio ") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Bottom DIC_bio [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

DICf2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DICf), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(fill = DICf), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-1.55, 1.55),
                       breaks = c(-1.4, -0.7, 0, 0.7, 1.4),
                       aesthetics = c("fill", "colour"),
                       name = expression(bold("DIC"["air-sea"]))) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Bottom DIC_flux [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

DICo2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = DIC.other), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(fill = DIC.other), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-40.83, 40.83),
                       aesthetics = c("fill", "colour"),
                       name = "ε") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Bottom DIC_residual [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 11),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))
```

## Same for TA
```{r}
dTA <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = dTA), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(fill = dTA), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-34.93, 34.93),
                       breaks = c(-30, -15, 0, 15, 30),
                       aesthetics = c("fill", "colour"),
                       name = "ΔTA") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  labs(title = "Surface") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

TApr <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = TApr), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m_v2[surface_sf_m_v2$Station == "096", ],
          fill = "grey8",
          size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(fill = TApr), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-4.05, 4.05),
                       aesthetics = c("fill", "colour"),
                       name = expression(bold("TA"["bio"]))) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Surface TA_bio [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

TAo <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = TA.other), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(fill = TA.other), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-38.51, 38.51),
                       breaks = c(-30, -15, 0, 15, 30),
                       aesthetics = c("fill", "colour"),
                       name = "ε") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Surface TA_residual [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 11),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

dTA2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dTA), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(fill = dTA), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-34.93, 34.93),
                       breaks = c(-30, -15, 0, 15, 30),
                       aesthetics = c("fill", "colour"),
                       name = "ΔTA") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  labs(title = "Bottom") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

TApr2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = TApr), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(fill = TApr), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-4.05, 4.05),
                       aesthetics = c("fill", "colour"),
                       name = "Bio") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Bottom TA_bio [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 9),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))

TAo2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = TA.other), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(fill = TA.other), shape = 23, linetype = "dashed") +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -50, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -100, alpha = 0.3, colour = "grey50") +
  geom_contour(data = bathy_xyz,
               aes(x = V1, y = V2, z = V3),
               breaks = -500, alpha = 0.3, colour = "grey50") +
  geom_sf(data = mass, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(colours = diverging_hcl(100, "Blue-Red 3"),
                       limits = c(-38.51, 38.51),
                       breaks = c(-30, -15, 0, 15, 30),
                       aesthetics = c("fill", "colour"),
                       name = "ε") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  #labs(title = "Bottom TA_residual [Oct]") +
  guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5),
         col = guide_colourbar(title.position = "top", title.hjust = 0.5)) +
  theme_bw() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold", size = 11),
        legend.text = element_text(size = 7),
        legend.position = "top",
        legend.key.height = unit(0.09, "in"),
        legend.key.width = unit(0.60, "in"),
        legend.spacing.y = unit(0.03, "in"),
        legend.margin = margin(0, 0, 0, 0))
```

## Build massive combo plot
```{r}
theme_set(theme_minimal())

plot_grid(
  plot_grid(
    get_title(dDIC),
    get_title(dDIC2),
    get_title(dDIC),
    get_title(dDIC2),
    ncol = 4
    ),
  plot_grid(
    plot_grid(
      plot_grid(
        get_legend(dDIC)
      ),
      plot_grid(
        dDIC + theme(plot.title = element_blank(), legend.position = "none"),
        dDIC2 + theme(plot.title = element_blank(), legend.position = "none"),
        nrow = 1,
        align = "hv"
      ),
      plot_grid(
        get_legend(DICpr)
      ),
      plot_grid(
        DICpr + theme(legend.position = "none"),
        DICpr2 + theme(legend.position = "none"),
        ncol = 2
      ),
      plot_grid(
        get_legend(DICf)
      ),
      plot_grid(
        DICf + theme(legend.position = "none"),
        DICf2 + theme(legend.position = "none"),
        ncol = 2,
        align = "hv"
      ),
      plot_grid(
        get_legend(DICo)
      ),
      plot_grid(
        DICo + theme(legend.position = "none"),
        DICo2 + theme(legend.position = "none"),
        ncol = 2,
        align = "hv"
      ),
      nrow = 8,
      rel_heights = c(1, 6, 1, 6, 1, 6, 1, 6)
    ),
    plot_grid(
      plot_grid(
        get_legend(dTA)
      ),
      plot_grid(
        dTA + theme(plot.title = element_blank(), legend.position = "none"),
        dTA2 + theme(plot.title = element_blank(), legend.position = "none"),
        nrow = 1),
      plot_grid(
        get_legend(TApr)
      ),
      plot_grid(
        TApr + theme(legend.position = "none"),
        TApr2 + theme(legend.position = "none"),
        ncol = 2
      ),
      plot_grid(
        get_legend(TApr + theme(legend.position = "none"))
      ),
      plot_grid(
        ggplot(),
        ggplot(),
        ncol = 2,
        align = "hv"),
      plot_grid(
        get_legend(TAo)
      ),
      plot_grid(
        TAo + theme(legend.position = "none"),
        TAo2 + theme(legend.position = "none"),
        ncol = 2,
        align = "hv"),
      nrow = 8,
      rel_heights = c(1, 6, 1, 6, 1, 6, 1, 6)
    ),
    ncol = 2
  ),
  nrow = 2,
  rel_heights = c(1, 24)
)

ggsave("Fig8.png", width = 6.5, height = 6.8, units = "in", dpi = 600, bg = "#ffffff")
```


## Old
```{r}
plot_grid(
  plot_grid(
    plot_grid(
      get_title(dDIC)),
    plot_grid(
      get_title(dDIC2))
  ),
  plot_grid(
    plot_grid(
      dDIC + theme(plot.title = element_blank()),
      DICpr,
      DICf,
      DICo,
      nrow = 4,
      align = "hv",
      labels = c("A", "B", "C", "D")),
    plot_grid(
      dTA + theme(plot.title = element_blank()),
      TApr,
      get_legend(TApr + theme(legend.position = "none")),
      TAo,
      nrow = 4,
      align = "hv"),
    plot_grid(
      dDIC2 + theme(plot.title = element_blank()),
      DICpr2,
      DICf2,
      DICo2,
      nrow = 4,
      align = "hv"),
    plot_grid(
      dTA2 + theme(plot.title = element_blank()),
      TApr2,
      get_legend(TApr + theme(legend.position = "none")),
      TAo2,
      nrow = 4,
      align = "hv"),
    ncol = 4
  ),
  nrow = 2,
  rel_heights = c(1, 32)
)
```

## Old plots
```{r}
theme_set(theme_minimal())

# DIC
plot_grid(
  plot_grid(
    get_title(dDIC)),
  plot_grid(
    get_title(dDIC2)),
  plot_grid(
    ggplot()),
  plot_grid(
    dDIC + theme(plot.title = element_blank(), legend.position = "none"),
    DICf + theme(legend.position = "none"),
    DICpr + theme(legend.position = "none"),
    DICo + theme(legend.position = "none"),
    nrow = 4,
    align = "hv",
    labels = c("A", "B", "C", "D")),
  plot_grid(
    dDIC2 + theme(plot.title = element_blank(), legend.position = "none"),
    DICf2 + theme(legend.position = "none"),
    DICpr2 + theme(legend.position = "none"),
    DICo2 + theme(legend.position = "none"),
    nrow = 4,
    align = "hv"),
  plot_grid(
    get_legend(dDIC2),
    ggplot(),
    get_legend(DICf2),
    ggplot(),
    get_legend(DICpr2),
    ggplot(),
    get_legend(DICo2),
    ggplot(),
    nrow = 4),
  ncol = 3, nrow = 2,
  rel_heights = c(1, 32),
  rel_widths = c(6, 6, 1)
)

# TA
plot_grid(
  plot_grid(
    get_title(dTA)),
  plot_grid(
    get_title(dTA2)),
  plot_grid(
    ggplot()),
  plot_grid(
    dTA + theme(plot.title = element_blank(), legend.position = "none"),
    TApr + theme(legend.position = "none"),
    TAo + theme(legend.position = "none"),
    nrow = 3,
    align = "hv",
    labels = c("A", "B", "C", "D")),
  plot_grid(
    dTA2 + theme(plot.title = element_blank(), legend.position = "none"),
    TApr2 + theme(legend.position = "none"),
    TAo2 + theme(legend.position = "none"),
    nrow = 3,
    align = "hv"),
  plot_grid(
    get_legend(dTA2),
    ggplot(),
    get_legend(TApr2),
    ggplot(),
    get_legend(TAo2),
    ggplot(),
    nrow = 3),
  ncol = 3, nrow = 2,
  rel_heights = c(1, 32),
  rel_widths = c(6, 6, 1)
)
```












## 6-panel relative contribution maps
```{r}
library(ggsci)
# dDIC: 41, dTA: 35, dDO: 28

dDIC <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = dDIC), size = 6, shape = 18) +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-41, 41),
  #                     colours = coolwarm(100),
                       breaks = c(-40, -20, 0, 20, 40),
                       aesthetics = c("fill", "colour"),
                       name = "Δ DIC") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))

dTA <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = dTA), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = dTA), size = 6, shape = 18) +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-35, 35),
                       breaks = c(-30, -15, 0, 15, 30),
                       aesthetics = c("fill", "colour"),
                       name = "Δ TA") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface delta TA [May]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

dDO <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = dDO), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = dDO), size = 6, shape = 18) +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-28, 28),
                       breaks = c(-20, -10, 0, 10, 20),
                       aesthetics = c("fill", "colour"),
                       name = "Δ DO") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface delta DO [May]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

dDIC2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = dDIC), size = 6, shape = 18) +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-41, 41),
                       breaks = c(-40, -20, 0, 20, 40),
                       aesthetics = c("fill", "colour"),
                       name = "Δ DIC") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "none")

dTA2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dTA), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = dTA), size = 6, shape = 18) +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-35, 35),
                       breaks = c(-30, -15, 0, 15, 30),
                       aesthetics = c("fill", "colour"),
                       name = "Δ TA") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Bottom delta TA [May]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

dDO2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dDO), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = dDO), size = 6, shape = 18) +
  geom_sf(data = GB_sf, fill = NA, linewidth = 0.4, linetype = "dashed") +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-28, 28),
                       breaks = c(-20, -10, 0, 10, 20),
                       aesthetics = c("fill", "colour"),
                       name = "Δ DO") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Bottom delta DO [May]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

theme_set(theme_minimal())

plot_grid(
  plot_grid(
    get_title(dDIC),
    get_title(dDIC2),
    nrow = 1),
  plot_grid(
    ggplot(),
    scale = 1),
  plot_grid(
    dDIC + theme(legend.position = "none", plot.title = element_blank()),
    dDIC2 + theme(plot.title = element_blank()),
    dTA + theme(legend.position = "none"),
    dTA2,
    dDO + theme(legend.position = "none"),
    dDO2,
    ncol = 2, nrow = 3,
    align = "hv",
    labels = c("A", "", "B", "", "C", "")),
  plot_grid(
    get_legend(dDIC),
    ggplot(),
    get_legend(dTA),
    ggplot(),
    get_legend(dDO),
    ggplot(),
    ncol = 1,
    scale = 1),
  ncol = 2, nrow = 2,
  rel_heights = c(1, 32),
  rel_widths = c(12, 1)
)
```

## 8-panel percent contribution maps (Oct)
```{r}
rel.DICf <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = rel.DICf), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = rel.DICf), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔDIC.flux") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))

rel.DICpr <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = rel.DICpr), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = rel.DICpr), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔDIC.bio") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface DIC_bio [Oct]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

rel.DICres <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = rel.DICres), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = rel.DICres), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔDIC.res") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface DIC_residual [Oct]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

rel.DICf2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = rel.DICf), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = rel.DICf), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔDIC.flux") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))

rel.DICpr2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = rel.DICpr), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = rel.DICpr), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔDIC.bio") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Bottom DIC_bio [Oct]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

rel.DICres2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = rel.DICres), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = rel.DICres), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔDIC.res") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Bottom DIC_residual [Oct]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

theme_set(theme_minimal())

plot_grid(
  plot_grid(
    get_title(rel.DICf)),
  plot_grid(
    get_title(rel.DICf2)),
  plot_grid(
    ggplot()),
  plot_grid(
    rel.DICf + theme(plot.title = element_blank(), legend.position = "none"),
    rel.DICpr + theme(legend.position = "none"),
    rel.DICres + theme(legend.position = "none"),
    ncol = 1,
    align = "hv",
    labels = c("A", "B", "C", "D")),
  plot_grid(
    rel.DICf2 + theme(plot.title = element_blank(), legend.position = "none"),
    rel.DICpr2 + theme(legend.position = "none"),
    rel.DICres2 + theme(legend.position = "none"),
    ncol = 1,
    align = "hv"),
  plot_grid(
    get_legend(rel.DICf2),
    ggplot(),
    get_legend(rel.DICpr2),
    ggplot(),
    get_legend(rel.DICres2),
    ggplot(),
    ncol = 1),
  ncol = 3,
  rel_heights = c(1, 32),
  rel_widths = c(6, 6, 1)
)
```

### Same as above, TA
```{r}
rel.TApr <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = rel.TApr), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = rel.TApr), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔTA.bio") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))

rel.TAres <- ggplot() +
  geom_sf(data = surface_sf_m_v2, aes(fill = rel.TAres), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf_m3, aes(col = rel.TAres), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔTA.res") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface TA_residual [Oct]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

rel.TApr2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = rel.TApr), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = rel.TApr), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔTA.bio") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))

rel.TAres2 <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = rel.TAres), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = rel.TAres), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gradientn(limits = c(0, 1),
                       colours = parula(100),
                       aesthetics = c("fill", "colour"),
                       name = "% ΔTA.res") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Bottom TA_residual [Oct]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

theme_set(theme_minimal())

plot_grid(
  plot_grid(
    get_title(rel.TApr)),
  plot_grid(
    get_title(rel.TApr2)),
  plot_grid(
    ggplot()),
  plot_grid(
    rel.TApr + theme(plot.title = element_blank(), legend.position = "none"),
    rel.TAres + theme(legend.position = "none"),
    ncol = 1,
    align = "hv",
    labels = c("A", "B", "C", "D")),
  plot_grid(
    rel.TApr2 + theme(plot.title = element_blank(), legend.position = "none"),
    rel.TAres2 + theme(legend.position = "none"),
    ncol = 1,
    align = "hv"),
  plot_grid(
    get_legend(rel.TApr2),
    ggplot(),
    get_legend(rel.TAres2),
    ggplot(),
    ncol = 1),
  ncol = 3,
  rel_heights = c(1, 32),
  rel_widths = c(6, 6, 1)
)
```

## "excess" plots
```{r}
# dDIC.ex: 22, dTA.ex: 19, ratio: 4.5

dDIC.ex <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dDIC.ex), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = dDIC.ex), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-22, 22),
#                       breaks = c(-40, -20, 0, 20, 40),
                       aesthetics = c("fill", "colour"),
                       name = "Δ DIC ex") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))

dTA.ex <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = dTA.ex), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = dTA.ex), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-19, 19),
#                       breaks = c(-30, -15, 0, 15, 30),
                       aesthetics = c("fill", "colour"),
                       name = "Δ TA ex") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface delta TA [May]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

ratio <- ggplot() +
  geom_sf(data = bottom_sf_m_v2, aes(fill = ratio), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf_m3, aes(col = ratio), size = 6, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_gsea(limits = c(-4.5, 4.5),
#                       breaks = c(-20, -10, 0, 10, 20),
                       aesthetics = c("fill", "colour"),
                       name = "Ratio") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface delta DO [May]") +
  theme_bw() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"))

theme_set(theme_minimal())

plot_grid(
    dDIC.ex,
    dTA.ex,
    ratio,
    nrow = 3,
    align = "hv",
    labels = c("A", "B", "C"))
```









## Plot MLDs with bathymetry
```{r}
library(marmap)

bathy <- getNOAA.bathy(lon1 = -71, lon2 = -65, lat1 = 39, lat2 = 43, resolution = 1)

# flat map
library(oce)
library(ocedata)
data("coastlineWorldFine")

# convert bathymetry
bathyLon = as.numeric(rownames(bathy))
bathyLat = as.numeric(colnames(bathy))
bathyZ = as.numeric(bathy)
dim(bathyZ) = dim(bathy)

# plot coastline (no projection)
plot(coastlineWorldFine, clon = mean(c(-66, -70.5)), clat = mean(c(40, 42.5)), span = 400)

# plot bathymetry
contour(bathyLon, bathyLat, bathyZ,
        levels = c(-25, -50, -75, -100, -200),
        lty = c(3, 1, 2, 1, 1),
        lwd = c(1, 1, 1, 1.5, 0.5),
        drawlabels = FALSE, add = TRUE, col = 'darkgray')

# add depth legend
legend("bottomright", seg.len = 3, cex = 0.75,
       legend = c("25", "50", "75", "100", "200"),
       lty = c(3, 1, 2, 1, 1),
       lwd = c(1, 1, 1, 1.5, 0.5),
       col = "darkgray", title = "Depth (m)", bg = "white")

# add map data (MLD)
pal <- viridis(n = 107, option = "viridis", direction = -1)
MLD_col <- pal[as.numeric(cut(may$MLD[which(may$Cast == "Bottom")], breaks = 106))]
points(x = may$Long[which(may$Cast == "Surface")],
       y = may$Lat[which(may$Cast == "Surface")],
       pch = 18,
       cex = 2,
       col = MLD_col)

# add color legend (MLD)
legend("right", seg.len = 3, cex = 0.75,
       legend = c("0", "20", "40", "60", "80", "100"),
       pch = 18, pt.cex = 1.5,
       col = viridis(n = 6, option = "viridis", direction = -1),
       title = "MLD (m)", bg = "white")

###

# add map data (MLD %)
pal <- viridis(n = 107, option = "viridis", direction = -1)
MLD_col <- pal[as.numeric(cut(may$MLD_frac[which(may$Cast == "Surface")], breaks = 106))]
points(x = may$Long[which(may$Cast == "Surface")],
       y = may$Lat[which(may$Cast == "Surface")],
       pch = 18,
       cex = 2,
       col = MLD_col)

# add color legend (MLD %)
legend("right", seg.len = 3, cex = 0.75,
       legend = c("1", "0.8", "0.6", "0.4", "0.2", "0"),
       pch = 18, pt.cex = 1.5,
       col = viridis(n = 6, option = "viridis", direction = 1),
       title = "MLD %", bg = "white")

###

# add map data (depth)
pal <- viridis(n = 112, option = "viridis", direction = 1)
depth_col <- pal[as.numeric(cut(may$Depth[which(may$Cast == "Surface")], breaks = 111))]
points(x = may$Long[which(may$Cast == "Surface")],
       y = may$Lat[which(may$Cast == "Surface")],
       pch = 18,
       cex = 2,
       col = depth_col)

# add color legend (depth)
legend("right", seg.len = 3, cex = 0.75,
       legend = c("20", "40", "60", "80", "100", "120"),
       pch = 18, pt.cex = 1.5,
       col = viridis(n = 6, option = "viridis", direction = -1),
       title = "MLD (m)", bg = "white")
```











## Check mapping
```{r}
ggplot(bottom_sf_m, aes(x = Long, y = Lat)) +
  geom_point(aes(colour = Salinity)) +
  geom_text(aes(label = Station), hjust = 0.05, vjust = 0.05, size = 3) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_colour_viridis() +
  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```

## Check polygon join
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", size = 0.5)
```

## Check point placement on polygon
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", size = 0.5) +
  geom_point(data = bottom_sf_m, aes(x = Long, y = Lat, colour = Salinity)) +
  geom_text(data = bottom_sf_m, aes(x = Long, y = Lat, label = Station),
            hjust = 0.05, vjust = 0.05, size = 3) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_colour_viridis() +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```







## Now for interpolation style 2 (inverse distance weighting)
```{r}
library(gstat)

# get the extent of interpolation area
grd_extent <- st_bbox(GB_sf)
 
# create grid
x.range <- as.numeric(c(grd_extent[1], grd_extent[3])) # min/max longitude of the interpolation area
y.range <- as.numeric(c(grd_extent[2], grd_extent[4])) # min/max latitude of the interpolation area
grd <- expand.grid(x = seq(from = x.range[1], to = x.range[2], by = 500),
                   y = seq(from = y.range[1], to = y.range[2], by = 500)) # expand points to grid

# convert grid to spatial object
coordinates(grd) <- ~x + y 
gridded(grd) <- TRUE

bottom_sp <- bottom_sf %>%
  st_transform(crs = 26919) %>%
  as_Spatial()
surface_sp <- surface_sf %>%
  st_transform(crs = 26919) %>%
  as_Spatial()
GB_sp <- as_Spatial(GB_sf)

# grid:
idw_grid <- spsample(GB_sp, type = "regular", n = 4000)

#st_crs(bottom_sp)
#st_crs(surface_sp)
#st_crs(idw_grid)

bottom_sp_temp <- bottom_sf %>%
  filter(!is.na(Temp)) %>%
  st_transform(crs = 26919) %>%
  as_Spatial()
surface_sp_temp <- surface_sf %>%
  filter(!is.na(Temp)) %>%
  st_transform(crs = 26919) %>%
  as_Spatial()

# idw for temp
interp_temp_B <- idw(Temp ~ 1, bottom_sp_temp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_temp_S <- idw(Temp ~ 1, surface_sp_temp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_temp_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom Temperature", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_temp_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface Temperature", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

# idw for Salinity
interp_sal_B <- idw(Salinity ~ 1, bottom_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_sal_S <- idw(Salinity ~ 1, surface_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_sal_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom Salinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_sal_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface Salinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

# idw for DIC
interp_DIC_B <- idw(DIC ~ 1, bottom_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_DIC_S <- idw(DIC ~ 1, surface_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_DIC_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom DIC", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_DIC_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface DIC", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

# idw for TA
interp_TA_B <- idw(TA ~ 1, bottom_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()
interp_TA_S <- idw(TA ~ 1, surface_sp, newdata = idw_grid, idp = 2) %>%
  as.data.frame()

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_TA_B, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Bottom Alkalinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())

ggplot() +
  geom_sf(data = GB_sf, fill = NA, size = 0.3, colour = "grey45") +
  geom_tile(data = interp_TA_S, aes(x = x1, y = x2, fill = var1.pred)) +
  scale_fill_viridis() +
  labs(title = "Surface Alkalinity", fill = "Salinity (PSU)") +
  theme(panel.grid = element_line(color = "grey70", size = 0.2),
        axis.title = element_blank())
```






# Alternative mapping styles

## Get bathymetric data
```{r}
library(marmap)
library(mapproj)
# Create base map with NOAA data
GB_bathy <- getNOAA.bathy(lon1 = -70.5, lon2 = -66, lat1 = 40, lat2 = 42.5,
                          resolution = 1)

ggbathy <- GB_bathy %>%
  fortify() %>%
  mutate(lat = y, long = x, depth = z) %>%
  select(-c(x, y, z)) %>%
  mutate(depth_bins = cut(depth, breaks = c(0, -30, -55, -75, -90, -120, -150, -180,
                                            -780, -1380, -1980, -2580, -3180, -Inf)))
```

## Get regional polygons
```{r}
library(mapdata)

reg = map_data("world2Hires")
reg = subset(reg, region %in% 'USA')

# convert longs
reg$long = (360 - reg$long)*-1
```

## Create bathy map
```{r}
map <- ggplot() +
  geom_raster(data = ggbathy, aes(long, lat, fill = depth_bins), interpolate = TRUE,
              alpha = 0.75) +
  scale_fill_manual(values = c("#08306B", "#084184", "#08519C","#1561A9", "#2171B5",
                               "#3282BE", "#4292C6", "#57A0CE", "#6BAED6", "#85BCDC",
                               "#9ECAE1", "#B2D3E8", "#C6DBEF"),
                    guide = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(breaks = c(40, 41, 42), expand = c(0, 0)) +
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", colour = NA) +
  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
  theme(axis.title = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
```

## Add points to map
```{r}
min(may$Temp)
max(may$Temp)

bottomTemp <- map +
  geom_sf(data = bottom_sf1, aes(size = Temp, colour = Temp), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(6.5, 10.5), option = "rocket") +
  scale_size_continuous(limits = c(6.5, 10.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Temperature (C)"), size = guide_legend(reverse = TRUE, title = "Temperature (C)")) +
  labs(title = "Bottom Temperature") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomTemp

surfaceTemp <- map +
  geom_sf(data = surface_sf1, aes(size = Temp, colour = Temp), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(6.5, 10.5), option = "rocket") +
  scale_size_continuous(limits = c(6.5, 10.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Temperature (C)"), size = guide_legend(reverse = TRUE, title = "Temperature (C)")) +
  labs(title = "Surface Temperature") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceTemp

min(may$Salinity)
max(may$Salinity)

bottomSal <- map +
  geom_sf(data = bottom_sf1, aes(size = Salinity, colour = Salinity),
          inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(32, 34.5), option = "rocket") +
  scale_size_continuous(limits = c(32, 34.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Salinity (PSU)"), size = guide_legend(reverse = TRUE, title = "Salinity (PSU)")) +
  labs(title = "Bottom Salinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomSal

surfaceSal <- map +
  geom_sf(data = surface_sf1, aes(size = Salinity, colour = Salinity),
          inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(32, 34.5), option = "rocket") +
  scale_size_continuous(limits = c(32, 34.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Salinity (PSU)"), size = guide_legend(reverse = TRUE, title = "Salinity (PSU)")) +
  labs(title = "Surface Salinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceSal

min(may$DIC)
max(may$DIC)

bottomDIC <- map +
  geom_sf(data = bottom_sf1, aes(colour = DIC), size = 5, inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2000, 2150), option = "rocket") +
  #scale_size_continuous(limits = c(1950, 2150), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "DIC (umol/kg)"), size = guide_legend(reverse = TRUE, title = "DIC (umol/kg)")) +
  labs(title = "Bottom DIC") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomDIC

surfaceDIC <- map +
  geom_sf(data = surface_sf1, aes(colour = DIC), size = 5, inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2000, 2150), option = "rocket") +
  #scale_size_continuous(limits = c(1950, 2150), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "DIC (umol/kg)"), size = guide_legend(reverse = TRUE, title = "DIC (umol/kg)")) +
  labs(title = "Surface DIC") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceDIC

min(may$TA)
max(may$TA)

bottomTA <- map +
  geom_sf(data = bottom_sf1, aes(size = TA, colour = TA), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2175, 2300), option = "rocket") +
  scale_size_continuous(limits = c(2175, 2300), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "TA (umol/kg)"),
         size = guide_legend(reverse = TRUE, title = "TA (umol/kg)")) +
  labs(title = "Bottom Alkalinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomTA

surfaceTA <- map +
  geom_sf(data = surface_sf1, aes(size = TA, colour = TA), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf1, aes(label = Station), nudge_x = 0, nudge_y = 0.09,
  #             size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2175, 2300), option = "rocket") +
  scale_size_continuous(limits = c(2175, 2300), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "TA (umol/kg)"),
         size = guide_legend(reverse = TRUE, title = "TA (umol/kg)")) +
  labs(title = "Surface Alkalinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceTA
```
