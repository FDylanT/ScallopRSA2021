---
title: "OctCruiseChemistry"
author: "Dylan Titmuss"
date: "3/15/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script visualizes the chemistry data from the October RSA cruise.
Run chunks 1-7 of `Chemistry_Oct.Rmd` to load data.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")

library(tidyverse)
library(sp)
library(sf)
library(viridis)
library(RColorBrewer)
library(shades)
```

## Add chem to shapefile
```{r}
station_SPDF <- SpatialPointsDataFrame(coords = oct[ , c("Long", "Lat")],
                                        data = oct[ , c("Long", "Lat",
                                                        "Station", "Cast",
                                                        "Depth",
                                                        "Temp", "Salinity", "Density",
                                                        "DIC", "TA",
                                                        "DO", "DO_sat", "AOU",
                                                        "pH", "fCO2", "pCO2",
                                                        "OmegaAragonite",
                                                        "OmegaCalcite",
                                                        "dDIC", "dTA", "DIC.other",
                                                        "flux", "MLD", "MLD_frac"
                                                        )],
                                        proj4string = CRS("+init=epsg:4326"))

station_sf <- st_as_sf(station_SPDF) #%>%
  #st_transform(crs = 4326)

bottom_sf <- station_sf %>%
  filter(Cast == "Bottom")

surface_sf <- station_sf %>%
  filter(Cast == "Surface")
```

## Load GB shapefiles
```{r}
GB <- st_read("./data/2020SAMZones/GB_Estimation_Areas_2019_UTM19_PDT_SFModified.shp")

# subset shapefile to SAMs
NLS_North <- subset(GB, NewSAMS == "NLS-North") %>%
  fortify()
CL1_South <- subset(GB, NewSAMS == "CL1-South") %>%
  fortify()
CL1_Sliver <- subset(GB, NewSAMS == "CL1-Sliver") %>%
  fortify()
CL2_AccessSoutheast <- subset(GB, NewSAMS == "CL2-Access-Southeast") %>%
  fortify()
SF <- subset(GB, NewSAMS == "SF") %>%
  fortify()
CL2_North <- subset(GB, NewSAMS == "CL2-North") %>%
  fortify()
CL1_Access <- subset(GB, NewSAMS == "CL1-Access") %>%
  fortify()
NF <- subset(GB, NewSAMS == "NF") %>%
  fortify()
CL2_Ext <- subset(GB, NewSAMS == "CL2-Ext") %>%
  fortify()
GSC <- subset(GB, NewSAMS == "GSC") %>%
  fortify()
NLS_SouthDeep <- subset(GB, NewSAMS == "NLS-South-Deep") %>%
  fortify()
NLS_West <- subset(GB, NewSAMS == "NLS-West") %>%
  fortify()
NLS_SouthShallow <- subset(GB, NewSAMS == "NLS-South-Shallow") %>%
  fortify()
CL2_AccessSouthwest <- subset(GB, NewSAMS == "CL2-Access-Southwest") %>%
  fortify()
SF_East <- subset(GB, NewSAMS == "SF-East") %>%
  fortify()

# combine polygons and set CRS
GB_sf <- st_union(NLS_North, CL1_South) %>%
  st_union(CL1_Sliver) %>%
  st_union(CL2_AccessSoutheast) %>%
  st_union(SF) %>%
  st_union(CL2_North) %>%
  st_union(CL1_Access) %>%
  st_union(NF) %>%
  st_union(CL2_Ext) %>%
  st_union(GSC) %>%
  st_union(NLS_SouthDeep) %>%
  st_union(NLS_West) %>%
  st_union(NLS_SouthShallow) %>%
  st_union(CL2_AccessSouthwest) %>%
  st_union(SF_East) %>%
  st_transform(crs = 26919)
  
#summary(GB_sf)
```

## Begin interpolation round 1 (nearest-neighbor)
```{r}
bottom_sf_geom <- st_union(bottom_sf) %>%
  st_transform(crs = 26919)
bottom_sf_v <- st_voronoi(bottom_sf_geom)
bottom_sf_v <- st_sf(bottom_sf_v)

surface_sf_geom <- st_union(surface_sf) %>%
  st_transform(crs = 26919)
surface_sf_v <- st_voronoi(surface_sf_geom)
surface_sf_v <- st_sf(surface_sf_v)

# mask Voronoi with contour
bottom_sf_v <- st_intersection(st_cast(bottom_sf_v),
                               st_union(st_buffer(GB_sf, dist = 500)))
bottom_sf_v <- st_sf(bottom_sf_v)

#st_crs(bottom_sf_v)

bottom_sf2 <- bottom_sf %>%
  st_transform(crs = 26919)

surface_sf_v <- st_intersection(st_cast(surface_sf_v),
                                st_union(st_buffer(GB_sf, dist = 500)))
surface_sf_v <- st_sf(surface_sf_v)

#st_crs(surface_sf_v)

surface_sf2 <- surface_sf %>%
  st_transform(crs = 26919)

# complete spatial join
bottom_sf_v2 <- st_join(bottom_sf_v, bottom_sf2)
#glimpse(bottom_sf_v2)
surface_sf_v2 <- st_join(surface_sf_v, surface_sf2)
```

## Create shapefiles for 3 central points
```{r}
bottom_sf3 <- bottom_sf2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")

surface_sf3 <- surface_sf2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")
```

## Create coastline polygon
```{r}
# get Massachusetts coastline
library(maps)
library(mapdata)
library(maptools) # retiring by the end of 2023; transition to 'sp'

mass <- map("worldHires", "USA",
            xlim = c(-73.5, -69.9),
            ylim = c(41.2, 42.9),
            fill = TRUE,
            col = "transparent",
            plot = FALSE)
IDs <- sapply(strsplit(mass$names, ":"), function(x) x[1])
mass_SP <- map2SpatialPolygons(mass, IDs = IDs, proj4string = CRS("+init=epsg:4326"))
#plot(mass_SP)
#st_crs(mass_SP)

data <- data.frame(f = 99.9)
row.names(data) <- mass_SP@polygons[[1]]@ID
mass_SPDF <- SpatialPolygonsDataFrame(mass_SP, data)

mass_sf <- st_as_sf(mass_SPDF) %>%
  st_transform(crs = 26919)
#st_crs(mass_sf)

#ggplot() +
#  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
#  coord_sf(xlim = c(371957.88, 756099.58),
#           ylim = c(4428833.79, 4709654.16),
#           crs = st_crs(26919))
```

## Find property ranges
(move this once DIC & TA data finalized)
```{r}
# Temp
min(bottom_sf2$Temp) # 8.317186
min(surface_sf2$Temp) # 14.26168
max(bottom_sf2$Temp) # 18.4182
max(surface_sf2$Temp) # 20.69855

# Sal
min(bottom_sf2$Salinity) # 32.4402
min(surface_sf2$Salinity) # 31.5991
max(bottom_sf2$Salinity) # 35.6009
max(surface_sf2$Salinity) # 34.0748

# DIC
min(bottom_sf2$DIC) # 1992.8
min(surface_sf2$DIC) # 1931.6
max(bottom_sf2$DIC) # 2154.9
max(surface_sf2$DIC) # 2035.2

# TA
min(bottom_sf2$TA) # 2181.2
min(surface_sf2$TA) # 2143.2
max(bottom_sf2$TA) # 2355
max(surface_sf2$TA) # 2281.1

# pH
min(bottom_sf2$pH) # 7.855834
min(surface_sf2$pH) # 7.95683
max(bottom_sf2$pH) # 8.08838
max(surface_sf2$pH) # 8.099045

# pCO2
min(surface_sf2$pCO2) # 336.7068
max(surface_sf2$pCO2) # 491.8113

# OmegaCalcite
min(bottom_sf2$OmegaCalcite) # 2.052275
min(surface_sf2$OmegaCalcite) # 3.069203
max(bottom_sf2$OmegaCalcite) # 3.887822
max(surface_sf2$OmegaCalcite) # 4.769167

# OmegaAragonite
min(bottom_sf2$OmegaAragonite) # 1.300137
min(surface_sf2$OmegaAragonite) # 1.963683
max(bottom_sf2$OmegaAragonite) # 2.491296
max(surface_sf2$OmegaAragonite) # 3.100417

# Density
min(bottom_sf2$Density) # 1023.384
min(surface_sf2$Density) # 1022.813
max(bottom_sf2$Density) # 1026.645
max(surface_sf2$Density) # 1024.035

# AOU
min(bottom_sf2$AOU) # -42.56385
min(surface_sf2$AOU) # -53.3255
max(bottom_sf2$AOU) # 42.19573
max(surface_sf2$AOU) # -8.418143

# dDIC
min(bottom_sf2$dDIC) # -19.09361
min(surface_sf2$dDIC) # -14.23064
max(bottom_sf2$dDIC) # 85.13874
max(surface_sf2$dDIC) # 36.93672

# DIC.other
min(bottom_sf2$DIC.other) # 
min(surface_sf2$DIC.other) # 
max(bottom_sf2$DIC.other) # 
max(surface_sf2$DIC.other) # 

# flux
min(surface_sf2$flux) # -6638.723
max(surface_sf2$flux) # 5664.694
```

## Interpolated bottom plots
```{r}
ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
                       aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Temperature [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(31, 36), palette = "OrRd",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"),
                       guide = guide_colorbar(reverse = TRUE)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Salinity [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Alkalinity [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom pH [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = OmegaCalcite), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = OmegaCalcite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2, 4.8), option = "mako",
                     aesthetics = c("fill", "colour"), name = "Ω Calcite") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  geom_label(aes(x = 722500, y = 4700000, label = "Bottom"), size = 5, fontface = "bold",
             label.size = 0.75, label.padding = unit(0.5, "lines")) +
  #labs(title = "Bottom Calcite [Oct]") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.15), option = "mako",
                     aesthetics = c("fill", "colour"), name = "Ω Aragonite") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Aragonite [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = AOU), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = AOU), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-55, 45), palette = "RdBu",
                       aesthetics = c("fill", "colour"), name = "AOU") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom AOU [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = dDIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-65, 75), palette = "YlGnBu",
                       aesthetics = c("fill", "colour"), name = "dDIC") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom delta DIC [Oct]") +
  theme_bw()
```

## Interpolated surface plots
```{r}
ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
                       aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Temperature [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(31, 36), palette = "OrRd",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"),
                       guide = guide_colorbar(reverse = TRUE)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Salinity [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Alkalinity [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface pH [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = pCO2), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = pCO2), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(335, 495), palette = "BrBG",
                       aesthetics = c("fill", "colour"),
                       name = bquote(italic("p"~CO[2])),
                       breaks = c(350, 390, 430, 470)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface pCO2 [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = OmegaCalcite), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = OmegaCalcite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2, 4.8), option = "mako",
                     aesthetics = c("fill", "colour"), name = "Ω Calcite") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  geom_label(aes(x = 721500, y = 4700000, label = "Surface"), size = 5, fontface = "bold",
             label.size = 0.75, label.padding = unit(0.5, "lines")) +
  #labs(title = "Surface Calcite [Oct]") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.15), option = "mako",
                     aesthetics = c("fill", "colour"), name = "OmegaA") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Aragonite [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = AOU), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = AOU), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-55, 45), palette = "RdBu",
                       aesthetics = c("fill", "colour"), name = "AOU") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface AOU [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = dDIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-40, 40), palette = "RdBu",
                       aesthetics = c("fill", "colour"), name = "dDIC") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface delta DIC [Oct]") +
  theme_bw()

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = flux / 10^3), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = flux / 10^3), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-7, 6), palette = "BrBG",
                       breaks = c(-5, 0, 5),
                       aesthetics = c("fill", "colour"),
                       name = "CO2 flux\n(mmol/m^2/d)") +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  #labs(title = "Surface CO2 flux [Oct]") +
  theme_bw() +
  theme(legend.title = element_text(face = "bold"))

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = MLD_frac), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = MLD_frac), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  lightness(scale_fill_distiller(palette = "BuGn", direction = "horizontal",
                       aesthetics = c("fill", "colour")),
            scalefac(0.90)) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "MLD as % Depth [Oct]") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))
```

## Add bathymetry
```{r}
library(marmap)

bathy <- getNOAA.bathy(lon1 = -71, lon2 = -65, lat1 = 39, lat2 = 43, resolution = 1)
  
  

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = MLD_frac), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = MLD_frac), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  #geom_contour(data = bathy, aes(x = x, y = y, z = z), col = "grey40", size = 0.2) +
  lightness(scale_fill_distiller(palette = "BuGn", direction = "horizontal",
                       aesthetics = c("fill", "colour")),
            scalefac(0.90)) +
  scale_y_continuous(breaks = c(40, 41, 42)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "MLD as % Depth [Oct]") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        legend.title = element_text(face = "bold"))



# flat map
library(oce)
library(ocedata)
data("coastlineWorldFine")

# convert bathymetry
bathyLon = as.numeric(rownames(bathy))
bathyLat = as.numeric(colnames(bathy))
bathyZ = as.numeric(bathy)
dim(bathyZ) = dim(bathy)

# plot coastline (no projection)
plot(coastlineWorldFine, clon = mean(c(-66, -70.5)), clat = mean(c(40, 42.5)), span = 400)

# plot bathymetry
contour(bathyLon, bathyLat, bathyZ,
        levels = c(-25, -50, -75, -100, -200),
        lty = c(3, 1, 2, 1, 1),
        lwd = c(1, 1, 1, 1.5, 0.5),
        drawlabels = FALSE, add = TRUE, col = 'darkgray')

# add depth legend
legend("bottomright", seg.len = 3, cex = 0.8,
       legend = c("25", "50", "75", "100", "200"),
       lty = c(3, 1, 2, 1, 1),
       lwd = c(1, 1, 1, 1.5, 0.5),
       col = "darkgray", title = "Depth (m)", bg = "white")

# add map data (MLD %)
pal <- viridis(n = 112, option = "viridis", direction = -1)
MLD_col <- pal[as.numeric(cut(oct$MLD_frac[which(oct$Cast == "Surface")], breaks = 111))]

points(x = oct$Long[which(oct$Cast == "Surface")],
       y = oct$Lat[which(oct$Cast == "Surface")],
       pch = 16,
       cex = 1.5,
       col = MLD_col)

# add color legend (MLD %)
legend("right", seg.len = 3, cex = 0.8,
       legend = c("1", "0.8", "0.6", "0.4", "0.2", "0"),
       pch = 16, pt.cex = 1.5,
       col = viridis(n = 6, option = "viridis", direction = 1),
       title = "MLD %", bg = "white")

# add map data (MLD)
pal <- viridis(n = 112, option = "viridis", direction = -1)
MLD_col <- pal[as.numeric(cut(oct$MLD[which(oct$Cast == "Surface")], breaks = 111))]

points(x = oct$Long[which(oct$Cast == "Surface")],
       y = oct$Lat[which(oct$Cast == "Surface")],
       pch = 16,
       cex = 1.5,
       col = MLD_col)

# add color legend (MLD)
legend("right", seg.len = 3, cex = 0.8,
       legend = c("20", "40", "60", "80", "100", "120"),
       pch = 16, pt.cex = 1.5,
       col = viridis(n = 6, option = "viridis", direction = 1),
       title = "MLD (m)", bg = "white")
```

## Prior attempts
```{r}
bathy_full <- getNOAA.bathy(lon1 = -71, lon2 = -65, lat1 = 39, lat2 = 43, resolution = 1)

bathy <- bathy_full %>%
  fortify() %>%
  filter(z < 1) %>%   # remove positive topology
  group_by(z) %>%
  filter(n() >= 4) %>%   # remove depths without min 4 points for a polygon
  ungroup()

poly_list <- split(bathy, bathy$z)
poly_list <- lapply(poly_list, function(x) {x["z"] <- NULL; x})
ps <- sapply(poly_list, Polygon)
p1 <- lapply(seq_along(ps), function(i) Polygons(list(ps[[i]]),
                                                 ID = names(poly_list)[i]))
sps <- SpatialPolygons(p1, proj4string = CRS("+init=epsg:4326"))
spdf <- SpatialPolygonsDataFrame(sps, data.frame(id = unique(bathy$z),
                                                 row.names = unique(bathy$z)))

#poly_list <- list()
#poly_data <- data.frame(matrix(ncol = 1, nrow = 0))
#colnames(poly_data) <- "z"

#for(i in 1:nrow(bathy)) {
#  z = bathy$z[i]
#  if(any(poly_data$z==z)) {
#   next
#  }
#  p = Polygon(bathy[bathy$z==z, 1:2])
#  poly_list[[length(poly_list) + 1]] <- p
#  poly_data[nrow(poly_data) + 1, ] <- z
#}

# n_distinct(bathy$z) # 3795 # woohoo! it matches my poly list!

#ps <- lapply(poly_list, Polygon)
#sps = SpatialPolygons(list(ps))


bathy_sf <- st_as_sf(spdf) %>%
  st_transform(crs = 26919) %>%
  filter(id == -40)

ggplot() +
  geom_sf(data = bathy_sf) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  geom_sf(data = b40, size = 0.2) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16))
```












## Check mapping
```{r}
ggplot(bottom_sf, aes(x = Long, y = Lat)) +
  geom_point(aes(colour = Salinity)) +
  geom_text(aes(label = Station), hjust = 0.05, vjust = 0.05, size = 3) +
  #geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_colour_viridis() +
  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```

## Check polygon join
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", colour = "black", size = 0.5)
```

## Check point placement on polygon
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = NA, colour = "black", size = 0.5) +
  geom_point(data = bottom_sf, aes(x = Long, y = Lat, colour = OmegaAragonite)) +
  geom_text(data = bottom_sf, aes(x = Long, y = Lat, label = Station),
            hjust = -0.05, vjust = 0.05, size = 3) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_colour_viridis() +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```
