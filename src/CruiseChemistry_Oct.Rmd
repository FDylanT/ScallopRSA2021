---
title: "OctCruiseChemistry"
author: "Dylan Titmuss"
date: "3/15/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script visualizes the chemistry data from the October RSA cruise.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")

library(tidyverse)
library(sf)
library(numform)
library(sp)
library(viridis)
library(gstat)
library(seacarb)
```

## Load data
```{r}
setwd("~/Desktop/Repos/ScallopRSA2021")

oct_full <- read.csv("./data/OctCruiseData.csv") %>%
  rename(Lat = Latitude_degrees_start,
         Long = Longitude_degrees_start,
         Depth = Depth_m_CTD,
         Temp = Temperature,
         DO = Dissolved_oxygen) %>%
  select(Station, Cast, BottleID, Filtered, Lat, Long, Depth, Temp, Pressure, SeaPressure, Salinity, DIC, TA, DO, DO_sat) %>%
  mutate(Station = as.character(f_pad_zero(Station))) # add leading zeros to station numbers

oct <- oct_full %>%
  filter(Filtered == "") %>%
  select(-Filtered)
```

## Fill in missing temps
```{r}
oct <- oct %>%
  mutate(Temp = ifelse(Station == "022", 0.611 * Temp[Station == "019"] +
                                         0.389 * Temp[Station == "024"], Temp),
         Temp = ifelse(Station == "023", Temp[Station == "021"], Temp),
         Temp = ifelse(Station == "104", 0.249 * Temp[Station == "094"] +
                                         0.303 * Temp[Station == "103"] +
                                         0.212 * Temp[Station == "105"] +
                                         0.236 * Temp[Station == "106"], Temp))

oct <- oct %>%
  mutate(Temp = ifelse(Station == "022", 0.611 * Temp[Station == "019"] +
                                         0.389 * Temp[Station == "024"], Temp),
         Temp = ifelse(Station == "023", Temp[Station == "021"], Temp),
         Temp = ifelse(Station == "104", 0.249 * Temp[Station == "094"] +
                                         0.303 * Temp[Station == "103"] +
                                         0.212 * Temp[Station == "105"] +
                                         0.236 * Temp[Station == "106"], Temp))
```

## Calculate carbon system parameters & density
```{r}
for(i in which(is.na(oct$SeaPressure))) {
    oct$SeaPressure[i] <- oct$Depth[i] # substitute depth for sites without sea pressure
    oct$Pressure[i] <- oct$SeaPressure[i] + 10.1325 # calculate surface pressure from depth
}

octCarb <- carb(flag = 15,                               # 15 = ALK & DIC given
                var1 = oct$TA / 10^6,                    # in mol/kg
                var2 = oct$DIC / 10^6,                   # in mol/kg
                S = oct$Salinity,
                T = oct$Temp,                            # in deg C
                Patm = oct$Pressure * 0.098692326671601, # in atm
                P = oct$SeaPressure / 10,                # in bar
                k1k2 = "l",                              # l = Lueker et al. (2000)
                                                         # kf: unspecified b/c low temps
                ks = "d",                                # d = Dickson (1990)
                b = "l10")                               # l10 = Lee et al. (2010)

# calculate density
oct$Density <- gsw_rho(oct$Salinity, oct$Temp, oct$SeaPressure)
```

## Combine oct & carb data
```{r}
oct <- cbind(oct,
             pH = octCarb$pH,
             fCO2 = octCarb$fCO2,
             OmegaAragonite = octCarb$OmegaAragonite,
             OmegaCalcite = octCarb$OmegaCalcite)
```

## Calculate AOU
```{r}
library(gsw)

oct$AbsSal <- rep(NA, 228)
oct$ConsTemp <- rep(NA, 228)
oct$AOU <- rep(NA, 228)

# calc absolute sal
oct$AbsSal <- gsw_SA_from_SP(SP = oct$Salinity,
                             p = oct$SeaPressure,
                             longitude = oct$Long,
                             latitude = oct$Lat)

# calc conservative temp
oct$ConsTemp <- gsw_CT_from_t(SA = oct$AbsSal, t = oct$Temp, p = oct$SeaPressure)

# in order, gsw_O2sol needs: SA, CT, p, long, lat
oxy <- as.data.frame(cbind(oct$AbsSal, oct$ConsTemp, oct$SeaPressure, oct$Long, oct$Lat))
write_csv(oxy, "data/oxy_data.csv")
```

Then use "O2_Calcs.m" script in MATLAB. Script runs the equivalent of:
`oct$O2sol <- gsw_O2sol(oct$AbsSal, oct$ConsTemp, oct$SeaPressure, oct$Long, oct$Lat)`

## after MATLAB
```{r}
oxy <- read.csv("data/oxy_data.csv")
oct$O2sol <- oxy$O2sol

## fill in missing DO values
oct <- oct %>%
  mutate(DO = ifelse(Station == "022", 0.611 * DO[Station == "019"] +
                                         0.389 * DO[Station == "024"], DO),
         DO = ifelse(Station == "023", DO[Station == "021"], DO),
         DO = ifelse(Station == "104", 0.249 * DO[Station == "094"] +
                                         0.303 * DO[Station == "103"] +
                                         0.212 * DO[Station == "105"] +
                                         0.236 * DO[Station == "106"], DO))

oct <- oct %>%
  mutate(DO = ifelse(Station == "022", 0.611 * DO[Station == "019"] +
                                         0.389 * DO[Station == "024"], DO),
         DO = ifelse(Station == "023", DO[Station == "021"], DO),
         DO = ifelse(Station == "104", 0.249 * DO[Station == "094"] +
                                         0.303 * DO[Station == "103"] +
                                         0.212 * DO[Station == "105"] +
                                         0.236 * DO[Station == "106"], DO))

# calc AOU
oct$AOU <- oct$O2sol - oct$DO
```

## Prop-prop plots
```{r}
# Temp vs Sal, coloured cast
#plot <-
ggplot(oct, aes(x = Salinity, y = Temp, shape = Cast, col = Cast)) +
  #geom_point() +
  geom_text(aes(label = as.integer(Station)), size = 3) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

# DIC vs Sal, coloured cast
ggplot(oct, aes(x = Salinity, y = DIC, shape = Cast, col = Cast)) +
  geom_point() +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

#plot(DIC ~ Salinity, data = oct, col = factor(Cast))
#identify(oct$DIC ~ oct$Salinity)

# TA vs Sal, coloured cast
ggplot(oct, aes(x = Salinity, y = TA, shape = Cast, col = Cast)) +
  geom_point() +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

#plot(TA ~ Salinity, data = oct, col = factor(Cast))
#abline(lm(oct$TA ~ oct$Salinity))
#identify(oct$TA ~ oct$Salinity)

### check 096, 098, 100 bottom TA + sal

# TA vs DIC, coloured cast
ggplot(oct, aes(x = DIC, y = TA, shape = Cast, col = Cast)) +
  geom_point() +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

#plot(oct$TA ~ oct$DIC, col = factor(oct$Cast))
#identify(oct$TA ~ oct$DIC)

# DIC vs density, coloured cast
ggplot(oct, aes(x = Density, y = DIC, shape = Cast, col = Cast)) +
  geom_point() +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

# TA vs density, coloured cast
ggplot(oct, aes(x = Density, y = TA, shape = Cast, col = Cast)) +
  geom_point() +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()
```

## Temp v Sal, coloured by 3rd property
```{r}
#ggplot_build(plot)$layout$panel_scales_x[[1]]$range$range # [31.5991 35.6009]
#ggplot_build(plot)$layout$panel_scales_y[[1]]$range$range # [8.317186 20.698551]

# Temp vs Sal, bottom, coloured depth
oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Salinity, y = Temp, col = Depth)) +
  geom_point() +
  scale_colour_viridis(option = "mako", direction = -1) +
  scale_x_continuous(limits = c(31.59, 35.61)) +
  scale_y_continuous(limits = c(8.31, 20.70)) +
  guides(colour = guide_colourbar(reverse = TRUE)) + 
  theme_bw()

#plot(Temp ~ Salinity, data = oct)
#identify(oct$Temp ~ oct$Salinity)

# Temp vs Sal, coloured DIC
ggplot(oct, aes(x = Salinity, y = Temp, col = DIC, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(option = "rocket") +
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()

#plot(Temp ~ Salinity, data = oct, col = factor(DIC))
#identify(oct$Temp ~ oct$Salinity)

### already checked 009 bottom DIC -- fine

# Temp vs Sal, coloured TA
ggplot(oct, aes(x = Salinity, y = Temp, col = TA, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(option = "mako") +
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()

# Temp vs Sal, coloured pH
ggplot(oct, aes(x = Salinity, y = Temp, col = pH, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(name = "pH") +
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()

# Temp vs Sal, coloured OmegaAragonite
ggplot(oct, aes(x = Salinity, y = Temp, col = OmegaAragonite, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(name = "OmegaAragonite") +
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()

# Temp vs Sal, coloured density
ggplot(oct, aes(x = Salinity, y = Temp, col = Density, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(name = "Density") +
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()
```

## Oct + May together
(Must run first chunks 2-4 of CruiseChemistry_May.Rmd file for the below chunk to run)
```{r}
# Temp vs Sal, coloured season
ggplot() +
  geom_point(data = may, aes(x = Salinity, y = Temp, shape = Cast, col = "May")) +
  geom_point(data = oct, aes(x = Salinity, y = Temp, shape = Cast, col = "October")) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("chartreuse3", "royalblue"),
                      name = "Month") +
  theme_bw()

# DIC vs Sal, coloured season
ggplot() +
  geom_point(data = may, aes(x = Salinity, y = DIC, shape = Cast, col = "May")) +
  geom_point(data = oct, aes(x = Salinity, y = DIC, shape = Cast, col = "October")) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("chartreuse3", "royalblue"),
                      name = "Month") +
  theme_bw()

# TA vs Sal, coloured season
ggplot() +
  geom_point(data = may, aes(x = Salinity, y = TA, shape = Cast, col = "May")) +
  geom_point(data = oct, aes(x = Salinity, y = TA, shape = Cast, col = "October")) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("chartreuse3", "royalblue"),
                      name = "Month") +
  theme_bw()

# TA vs DIC, coloured season
ggplot() +
  geom_point(data = may, aes(x = DIC, y = TA, shape = Cast, col = "May")) +
  geom_point(data = oct, aes(x = DIC, y = TA, shape = Cast, col = "October")) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("chartreuse3", "royalblue"),
                      name = "Month") +
  theme_bw()

# DIC vs density, coloured season
ggplot() +
  geom_point(data = may, aes(x = Density, y = DIC, shape = Cast, col = "May")) +
  geom_point(data = oct, aes(x = Density, y = DIC, shape = Cast, col = "October")) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("chartreuse3", "royalblue"),
                      name = "Month") +
  theme_bw()

# TA vs density, coloured season
ggplot() +
  geom_point(data = may, aes(x = Density, y = TA, shape = Cast, col = "May")) +
  geom_point(data = oct, aes(x = Density, y = TA, shape = Cast, col = "October")) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("chartreuse3", "royalblue"),
                      name = "Month") +
  theme_bw()
```

## Identify end-members
```{r}
# TA vs density
plot(TA ~ Density, data = oct, pch = c(16, 1)[factor(Cast)])
identify(oct$TA ~ oct$Density)

plot(TA ~ Density, data = oct, pch = c(16, 1)[factor(Cast)],
     xlim = c(1025, 1026),
     ylim = c(2200, 2240))
identify(oct$TA ~ oct$Density)

plot(TA ~ Density, data = oct, pch = c(16, 1)[factor(Cast)],
     xlim = c(1023, 1024),
     ylim = c(2170, 2190))
identify(oct$TA ~ oct$Density)

# DIC vs sal
plot(DIC ~ Salinity, data = oct, pch = c(16, 1)[factor(Cast)])
identify(oct$DIC ~ oct$Salinity)

plot(DIC ~ Salinity, data = oct, pch = c(16, 1)[factor(Cast)],
     xlim = c(32.5, 33),
     ylim = c(1975, 2025))
identify(oct$DIC ~ oct$Salinity)

# DIC vs density
plot(DIC ~ Density, data = oct, pch = c(16, 1)[factor(Cast)])
identify(oct$DIC ~ oct$Density)

# TA vs sal
plot(TA ~ Salinity, data = oct, pch = c(1, 16)[factor(Cast)])
identify(oct$TA ~ oct$Salinity)

# OmegaA vs sal
plot(OmegaAragonite ~ Salinity, data = oct, pch = c(16, 1)[factor(Cast)])
identify(oct$OmegaAragonite ~ oct$Salinity)

# temp vs sal
plot(Temp ~ Salinity, data = oct, pch = c(16, 1)[factor(Cast)])
which(oct$Station == "020")
points(oct$Salinity[40], oct$Temp[40], col = "red")
identify(oct$Temp ~ oct$Salinity)
```

## Isolate certain sets of values separately
```{r}
oct %>%
  filter(Station > "014" & Station < "033") %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = Density, y = TA)) +
  geom_point(shape = 1) +
  xlim(1023, 1027) +
  ylim(2150, 2355) +
  theme_bw()

oct %>%
  filter(Station > "036" & Station < "098") %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = Salinity, y = DIC)) +
  geom_point(shape = 1) +
  xlim(31.5, 35.5) +
  ylim(1925, 2150) +
  theme_bw()

oct %>%
  filter(Station > "036" & Station < "098") %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = Density, y = TA)) +
  geom_point(shape = 1) +
  xlim(1023, 1027) +
  ylim(2150, 2355) +
  theme_bw()

oct %>%
  filter(Station > "036" & Station < "098") %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = Salinity, y = TA)) +
  geom_point(shape = 1) +
  xlim(31.5, 35.5) +
  ylim(2150, 2355) +
  theme_bw()

oct %>%
  filter(Station > "036" & Station < "098") %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Salinity, y = DIC)) +
  geom_point(shape = 16) +
  xlim(31.5, 35.5) +
  ylim(1925, 2150) +
  theme_bw()

oct %>%
  filter(Station > "036" & Station < "098") %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Density, y = TA)) +
  geom_point(shape = 16) +
  xlim(1023, 1027) +
  ylim(2150, 2355) +
  theme_bw()

oct %>%
  filter(Station > "036" & Station < "098") %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Salinity, y = TA)) +
  geom_point(shape = 16) +
  xlim(31.5, 35.5) +
  ylim(2150, 2355) +
  theme_bw()

######
plot(TA ~ Density,
     data = subset(oct, Station > "036" & Station < "098" & Cast == "Bottom"),
     pch = 16,
     xlim = c(1023, 1027),
     ylim = c(2150, 2355))
#identify(oct$TA ~ oct$Density)

plot(Temp ~ Salinity,
     data = subset(oct, Station > "036" & Station < "081" & Cast == "Surface"),
     pch = 1,
     xlim = c(31.6, 35.6),
     ylim = c(8, 20.75))
#identify(oct$Temp ~ oct$Salinity)
```

## Connect surface & bottom points with lines
```{r}
ggplot(oct, aes(x = Density, y = TA, shape = Cast, col = Cast, group = Station)) +
  geom_point() +
  geom_line(col = "grey56", linetype = "dotted") +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

ggplot(oct, aes(x = Salinity, y = DIC, shape = Cast, col = Cast, group = Station)) +
  geom_point() +
  geom_line(col = "grey56", linetype = "dotted") +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

ggplot(oct, aes(x = Density, y = DIC, shape = Cast, col = Cast, group = Station)) +
  geom_point() +
  geom_line(col = "grey56", linetype = "dotted") +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()

ggplot(oct, aes(x = Salinity, y = TA, shape = Cast, col = Cast, group = Station)) +
  geom_point() +
  geom_line(col = "grey56", linetype = "dotted") +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()
```

## Convert coordinates
```{r}
oct <- oct %>%
  arrange(Station)

chd <- substr(oct$Lat, 3, 3)[1]

# convert latitude from DM to DD
Lat_split_oct <- str_split_fixed(oct$Lat, chd, 2) %>%
  as.data.frame()
Lat_split_oct$V2 <- str_remove_all(Lat_split_oct$V2, pattern = "'") %>%
  as.numeric()
Lat_split_oct$V2 <- Lat_split_oct$V2/60
Lat_split_oct$V1 <- as.numeric(Lat_split_oct$V1)

oct$Lat <- Lat_split_oct$V1 + Lat_split_oct$V2

# convert longitude from DM to DD
Long_split_oct <- str_split_fixed(oct$Long, chd, 2) %>%
  as.data.frame()
Long_split_oct$V2 <- str_remove_all(Long_split_oct$V2, pattern = "'") %>%
  as.numeric()
Long_split_oct$V2 <- Long_split_oct$V2/60
Long_split_oct$V1 <- as.numeric(Long_split_oct$V1)

oct$Long <- -(Long_split_oct$V1 + Long_split_oct$V2)
```

## Add chem to shapefile
```{r}
station_SPDF <- SpatialPointsDataFrame(coords = oct[ , c("Long", "Lat")],
                                        data = oct[ , c("Long", "Lat",
                                                        "Station", "Cast",
                                                        "Depth",
                                                        "Temp", "Salinity", "Density",
                                                        "DIC", "TA",
                                                        "DO", "DO_sat",
                                                        "AOU",
                                                        "pH", "fCO2",
                                                        "OmegaAragonite",
                                                        "OmegaCalcite"
                                                        #, "dDIC", "dTA"
                                                        )],
                                        proj4string = CRS("+init=epsg:4326"))

station_sf <- st_as_sf(station_SPDF) %>%
  st_transform(crs = 4326)

bottom_sf <- station_sf %>%
  filter(Cast == "Bottom")

surface_sf <- station_sf %>%
  filter(Cast == "Surface")
```

## Check mapping
```{r}
#ggplot(bottom_sf, aes(x = Long, y = Lat)) +
#  geom_point(aes(colour = Salinity)) +
#  geom_text(aes(label = Station), hjust = 0.05, vjust = 0.05, size = 3) +
#  scale_colour_viridis() +
  #geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
  #             fill = "darkgrey", colour = NA) +
#  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
#  scale_y_continuous(breaks = c(40, 41, 42))
```

## Load GB shapefiles
```{r}
GB <- st_read("./data/2020SAMZones/GB_Estimation_Areas_2019_UTM19_PDT_SFModified.shp")

# subset shapefile to SAMs
NLS_North <- subset(GB, NewSAMS == "NLS-North") %>%
  fortify()
CL1_South <- subset(GB, NewSAMS == "CL1-South") %>%
  fortify()
CL1_Sliver <- subset(GB, NewSAMS == "CL1-Sliver") %>%
  fortify()
CL2_AccessSoutheast <- subset(GB, NewSAMS == "CL2-Access-Southeast") %>%
  fortify()
SF <- subset(GB, NewSAMS == "SF") %>%
  fortify()
CL2_North <- subset(GB, NewSAMS == "CL2-North") %>%
  fortify()
CL1_Access <- subset(GB, NewSAMS == "CL1-Access") %>%
  fortify()
NF <- subset(GB, NewSAMS == "NF") %>%
  fortify()
CL2_Ext <- subset(GB, NewSAMS == "CL2-Ext") %>%
  fortify()
GSC <- subset(GB, NewSAMS == "GSC") %>%
  fortify()
NLS_SouthDeep <- subset(GB, NewSAMS == "NLS-South-Deep") %>%
  fortify()
NLS_West <- subset(GB, NewSAMS == "NLS-West") %>%
  fortify()
NLS_SouthShallow <- subset(GB, NewSAMS == "NLS-South-Shallow") %>%
  fortify()
CL2_AccessSouthwest <- subset(GB, NewSAMS == "CL2-Access-Southwest") %>%
  fortify()
SF_East <- subset(GB, NewSAMS == "SF-East") %>%
  fortify()

# combine polygons and set CRS
GB_sf <- st_union(NLS_North, CL1_South) %>%
  st_union(CL1_Sliver) %>%
  st_union(CL2_AccessSoutheast) %>%
  st_union(SF) %>%
  st_union(CL2_North) %>%
  st_union(CL1_Access) %>%
  st_union(NF) %>%
  st_union(CL2_Ext) %>%
  st_union(GSC) %>%
  st_union(NLS_SouthDeep) %>%
  st_union(NLS_West) %>%
  st_union(NLS_SouthShallow) %>%
  st_union(CL2_AccessSouthwest) %>%
  st_union(SF_East) %>%
  st_transform(crs = 26919)
  
#summary(GB_sf)
```

## Check polygon join
```{r}
#ggplot() +
#  geom_sf(data = GB_sf, fill = "lightblue", colour = "black", size = 0.5)
```

## Check point placement on polygon
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = NA, colour = "black", size = 0.5) +
  geom_point(data = bottom_sf, aes(x = Long, y = Lat, colour = OmegaAragonite)) +
  geom_text(data = bottom_sf, aes(x = Long, y = Lat, label = Station),
            hjust = -0.05, vjust = 0.05, size = 3) +
  scale_colour_viridis(option = "mako", name = "OmegaA") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```

## Begin interpolation round 1 (nearest-neighbor)
```{r}
bottom_sf_geom <- st_union(bottom_sf) %>%
  st_transform(crs = 26919)
bottom_sf_v <- st_voronoi(bottom_sf_geom)
bottom_sf_v <- st_sf(bottom_sf_v)

surface_sf_geom <- st_union(surface_sf) %>%
  st_transform(crs = 26919)
surface_sf_v <- st_voronoi(surface_sf_geom)
surface_sf_v <- st_sf(surface_sf_v)

# mask Voronoi with contour
bottom_sf_v <- st_intersection(st_cast(bottom_sf_v), st_union(st_buffer(GB_sf, dist = 500)))
bottom_sf_v <- st_sf(bottom_sf_v)

#st_crs(bottom_sf_v)

bottom_sf2 <- bottom_sf %>%
  st_transform(crs = 26919)

surface_sf_v <- st_intersection(st_cast(surface_sf_v), st_union(st_buffer(GB_sf, dist = 500)))
surface_sf_v <- st_sf(surface_sf_v)

#st_crs(surface_sf_v)

surface_sf2 <- surface_sf %>%
  st_transform(crs = 26919)

# complete spatial join
bottom_sf_v2 <- st_join(bottom_sf_v, bottom_sf2)
#glimpse(bottom_sf_v2)
surface_sf_v2 <- st_join(surface_sf_v, surface_sf2)
```

## Create shapefiles for 3 central points
```{r}
bottom_sf3 <- bottom_sf2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")

surface_sf3 <- surface_sf2 %>%
  filter(Station == "033" | Station == "034" | Station == "035")
```

## Create coastline polygon
```{r}
# get Massachusetts coastline
library(maps)
library(mapdata)
library(maptools)

mass <- map("worldHires", "USA", xlim = c(-73.5, -69.9), ylim = c(41.2, 42.9), fill = TRUE, col = "transparent", plot = FALSE)
IDs <- sapply(strsplit(mass$names, ":"), function(x) x[1])
mass_SP <- map2SpatialPolygons(mass, IDs = IDs, proj4string = CRS("+init=epsg:4326"))
#plot(mass_SP)
#st_crs(mass_SP)

data <- data.frame(f = 99.9)
row.names(data) <- mass_SP@polygons[[1]]@ID
mass_SPDF <- SpatialPolygonsDataFrame(mass_SP, data)

mass_sf <- st_as_sf(mass_SPDF) %>%
  st_transform(crs = 26919)
#st_crs(mass_sf)

#ggplot() +
#  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
#  coord_sf(xlim = c(371957.88, 756099.58), ylim = c(4428833.79, 4709654.16), crs = st_crs(26919))
```

## Find property ranges
```{r}
# Temp
min(bottom_sf_v2$Temp, na.rm = TRUE) # 8.317186
min(surface_sf_v2$Temp, na.rm = TRUE) # 14.26168
max(bottom_sf_v2$Temp, na.rm = TRUE) # 17.79557
max(surface_sf_v2$Temp, na.rm = TRUE) # 20.69855

# Sal
min(bottom_sf_v2$Salinity, na.rm = TRUE) # 32.4402
min(surface_sf_v2$Salinity, na.rm = TRUE) # 31.5991
max(bottom_sf_v2$Salinity, na.rm = TRUE) # 35.6009
max(surface_sf_v2$Salinity, na.rm = TRUE) # 34.0748

# DIC
min(bottom_sf_v2$DIC, na.rm = TRUE) # 2004.8
min(surface_sf_v2$DIC, na.rm = TRUE) # 1931.6
max(bottom_sf_v2$DIC, na.rm = TRUE) # 2154.9
max(surface_sf_v2$DIC, na.rm = TRUE) # 2035.2

# TA
min(bottom_sf_v2$TA, na.rm = TRUE) # 2185.3
min(surface_sf_v2$TA, na.rm = TRUE) # 2143.2
max(bottom_sf_v2$TA, na.rm = TRUE) # 2355
max(surface_sf_v2$TA, na.rm = TRUE) # 2281.1

# pH
min(bottom_sf_v2$pH, na.rm = TRUE) # 7.855834
min(surface_sf_v2$pH, na.rm = TRUE) # 7.962125
max(bottom_sf_v2$pH, na.rm = TRUE) # 8.08838
max(surface_sf_v2$pH, na.rm = TRUE) # 8.099045

# OmegaAragonite
min(bottom_sf_v2$OmegaAragonite, na.rm = TRUE) # 1.300137
min(surface_sf_v2$OmegaAragonite, na.rm = TRUE) # 1.963683
max(bottom_sf_v2$OmegaAragonite, na.rm = TRUE) # 2.491296
max(surface_sf_v2$OmegaAragonite, na.rm = TRUE) # 3.100417

# Density
min(bottom_sf_v2$Density, na.rm = TRUE) # 1023.6
min(surface_sf_v2$Density, na.rm = TRUE) # 1022.813
max(bottom_sf_v2$Density, na.rm = TRUE) # 1026.645
max(surface_sf_v2$Density, na.rm = TRUE) # 1024.035

# DO_sat
min(bottom_sf_v2$DO_sat, na.rm = TRUE) # 84.87207
min(surface_sf_v2$DO_sat, na.rm = TRUE) # 83.85446
max(bottom_sf_v2$DO_sat, na.rm = TRUE) # 116.5714
max(surface_sf_v2$DO_sat, na.rm = TRUE) # 119.8024

# AOU
min(bottom_sf_v2$AOU, na.rm = TRUE) # -40.91224
min(surface_sf_v2$AOU, na.rm = TRUE) # -53.3255
max(bottom_sf_v2$AOU, na.rm = TRUE) # 42.19578
max(surface_sf_v2$AOU, na.rm = TRUE) # -8.418145

# dDIC
min(bottom_sf_v2$dDIC, na.rm = TRUE) # 
min(surface_sf_v2$dDIC, na.rm = TRUE) #
max(bottom_sf_v2$dDIC, na.rm = TRUE) # 
max(surface_sf_v2$dDIC, na.rm = TRUE) # 
```

## Make interpolated plots
```{r}
# make bottom plots
ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
                       aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Temperature [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(31, 36), palette = "OrRd",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"),
                       guide = guide_colorbar(reverse = TRUE)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Salinity [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Alkalinity [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom pH [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.15), option = "mako",
                     aesthetics = c("fill", "colour"), name = "OmegaA") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Aragonite [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = Density), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = Density), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(1022, 1027), palette = "YlGn",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"), name = "Density",
                       guide = guide_colorbar(reverse = TRUE)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Density [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = DO_sat), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = DO_sat), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(80, 120), palette = "YlGnBu",
                       aesthetics = c("fill", "colour"), name = "% O2") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Oxygen Saturation [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = AOU), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = AOU), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-55, 45), palette = "RdBu",
                       aesthetics = c("fill", "colour"), name = "AOU") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom AOU [Oct]")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = bottom_sf3, aes(col = dDIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-65, 75), palette = "YlGnBu",
                       aesthetics = c("fill", "colour"), name = "dDIC") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom delta DIC [Oct]")

# make surface plots
ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = Temp), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(6, 21), palette = "YlGnBu",
                       aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Temperature [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = Salinity), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(31, 36), palette = "OrRd",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"),
                       guide = guide_colorbar(reverse = TRUE)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Salinity [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = DIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1930, 2155), option = "rocket",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = TA), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = TA), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(2140, 2355), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Alkalinity [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = pH), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = pH), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(7.8, 8.25), option = "mako",
                     aesthetics = c("fill", "colour")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface pH [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = OmegaAragonite), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = OmegaAragonite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.15), option = "mako",
                     aesthetics = c("fill", "colour"), name = "OmegaA") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Aragonite [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = OmegaCalcite), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = OmegaCalcite), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_viridis(limits = c(1.3, 3.1), option = "mako",
                     aesthetics = c("fill", "colour"), name = "OmegaC") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Calcite [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = Density), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = Density), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(1022, 1027), palette = "YlGn",
                       direction = "horizontal",
                       aesthetics = c("fill", "colour"), name = "Density",
                       guide = guide_colorbar(reverse = TRUE)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Density [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = DO_sat), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = DO_sat), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(80, 120), palette = "YlGnBu",
                       aesthetics = c("fill", "colour"), name = "% O2") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Oxygen Saturation [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = AOU), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = AOU), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-55, 45), palette = "RdBu",
                       aesthetics = c("fill", "colour"), name = "AOU") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface AOU [Oct]")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = dDIC), size = 0.25, colour = NA) +
  geom_sf(data = surface_sf3, aes(col = dDIC), size = 8, shape = 18) +
  geom_sf(data = mass_sf, fill = "darkgrey", colour = NA) +
  scale_fill_distiller(limits = c(-65, 75), palette = "YlGnBu",
                       aesthetics = c("fill", "colour"), name = "dDIC") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface delta DIC [Oct]")
```
