---
title: "OctCruiseChemistry"
author: "Dylan Titmuss"
date: "3/15/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script visualizes the chemistry data from the October RSA cruise.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")
```

## Load packages
```{r}
library(tidyverse)
library(sf)
library(numform)
library(sp)
library(viridis)
library(gstat)
```

## Load data
```{r}
setwd("./Repos/ScallopRSA2021")

oct <- read.csv("./data/OctCruiseData.csv") %>%
  rename(Lat = Latitude_degrees_start,
         Long = Longitude_degrees_start,
         Depth = Depth_m_CTD,
         Temp = Temperature) %>%
  select(Station, Cast, Lat, Long, Depth, Temp, Salinity, DIC, TA) %>%
  mutate(Station = as.character(f_pad_zero(Station))) # add leading zeros to station numbers
```

## Prop-prop plots
```{r}
# Temp vs. Sal, coloured cast
ggplot(oct, aes(x = Salinity, y = Temp, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

# Temp vs. Sal, bottom, coloured depth
#plot <-
oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Salinity, y = Temp, col = Depth)) +
  geom_point() +
  scale_colour_viridis(option = "mako", direction = -1) +
  theme_bw()
  
#ggplot_build(plot)$layout$panel_scales_x[[1]]$range$range
#ggplot_build(plot)$layout$panel_scales_y[[1]]$range$range

# Temp vs. Sal, surface, coloured bottom depth
oct %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = Salinity, y = Temp, col = Depth)) +
  geom_point(shape = 17) +
  scale_colour_viridis(option = "mako", direction = -1) +
  scale_x_continuous(limits = c(32.447, 34.397)) +
  scale_y_continuous(limits = c(6.717487, 10.080005)) +
  theme_bw()

# Temp vs. Sal, coloured DIC
ggplot(oct, aes(x = Salinity, y = Temp, col = DIC, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(option = "rocket") +
  theme_bw()

# Temp vs. Sal, coloured TA
ggplot(oct, aes(x = Salinity, y = Temp, col = TA, shape = Cast)) +
  geom_point() +
  scale_colour_viridis() +
  theme_bw()

# DIC vs. Sal, coloured cast
ggplot(oct, aes(x = Salinity, y = DIC, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

#plot(DIC ~ Salinity, data = oct)
#identify(oct$DIC ~ oct$Salinity)

### check xxx DIC

# TA vs. Sal, coloured cast
ggplot(oct, aes(x = Salinity, y = TA, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

plot(oct$TA ~ oct$Salinity)
abline(lm(oct$TA ~ oct$Salinity))
identify(oct$TA ~ oct$Salinity)

### check xxx TA

# DIC vs. TA, coloured cast
ggplot(oct, aes(x = DIC, y = TA, shape = Cast, col = Cast)) +
  geom_point() +
  theme_bw()

#plot(oct$TA ~ oct$DIC)
#identify(oct$TA ~ oct$DIC)
```

## Convert coordinates
```{r}
oct <- oct %>%
  arrange(Station)

chd <- substr(oct$Lat, 3, 3)[1]

# convert latitude from DM to DD
Lat_split_oct <- str_split_fixed(oct$Lat, chd, 2) %>%
  as.data.frame()
Lat_split_oct$V2 <- str_remove_all(Lat_split_oct$V2, pattern = "'") %>%
  as.numeric()
Lat_split_oct$V2 <- Lat_split_oct$V2/60
Lat_split_oct$V1 <- as.numeric(Lat_split_oct$V1)

oct$Lat <- Lat_split_oct$V1 + Lat_split_oct$V2

# convert longitude from DM to DD
Long_split_oct <- str_split_fixed(oct$Long, chd, 2) %>%
  as.data.frame()
Long_split_oct$V2 <- str_remove_all(Long_split_oct$V2, pattern = "'") %>%
  as.numeric()
Long_split_oct$V2 <- Long_split_oct$V2/60
Long_split_oct$V1 <- as.numeric(Long_split_oct$V1)

oct$Long <- -(Long_split_oct$V1 + Long_split_oct$V2)

# preserve oct file; update coords to fit within polygon
#stationChem <- oct %>%
#  mutate(Long = ifelse(Station == "006", Long + 0.06, Long),
#         Lat = ifelse(Station == "026", Lat + 0.02, Lat),
#         Long = ifelse(Station == "089", Long - 0.04, Long))
```

## Add chem to shapefile
```{r}
station_SPDF <- SpatialPointsDataFrame(coords = stationChem[ , c("Long","Lat")],
                                        data = stationChem[ ,c("Long", "Lat", "Station", "Cast", "Depth",
                                                             "Temp", "Salinity", "DIC", "TA")],
                                        proj4string = CRS("+init=epsg:4326"))

station_sf <- st_as_sf(station_SPDF) %>%
  st_transform(crs = 4326)

bottom_sf <- station_sf %>%
  filter(Cast == "Bottom")

surface_sf <- station_sf %>%
  filter(Cast == "Surface")
```

## Check mapping
```{r}
ggplot(bottom_sf, aes(x = Long, y = Lat)) +
  geom_point(aes(colour = Salinity)) +
  geom_text(aes(label = Station), hjust = 0.05, vjust = 0.05, size = 3) +
  scale_colour_viridis() +
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", colour = NA) +
  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```

## Load GB shapefiles
```{r}
GB <- st_read("./data/2020SAMZones/GB_Estimation_Areas_2019_UTM19_PDT_SFModified.shp")

# subset shapefile to SAMs
NLS_North <- subset(GB, NewSAMS == "NLS-North")
CL1_South <- subset(GB, NewSAMS == "CL1-South")
CL1_Sliver <- subset(GB, NewSAMS == "CL1-Sliver")
CL2_AccessSoutheast <- subset(GB, NewSAMS == "CL2-Access-Southeast")
SF <- subset(GB, NewSAMS == "SF")
CL2_North <- subset(GB, NewSAMS == "CL2-North")
CL1_Access <- subset(GB, NewSAMS == "CL1-Access")
NF <- subset(GB, NewSAMS == "NF")
CL2_Ext <- subset(GB, NewSAMS == "CL2-Ext")
GSC <- subset(GB, NewSAMS == "GSC")
NLS_SouthDeep <- subset(GB, NewSAMS == "NLS-South-Deep")
NLS_West <- subset(GB, NewSAMS == "NLS-West")
NLS_SouthShallow <- subset(GB, NewSAMS == "NLS-South-Shallow")
CL2_AccessSouthwest <- subset(GB, NewSAMS == "CL2-Access-Southwest")
SF_East <- subset(GB, NewSAMS == "SF-East")

# fortify regions for use with ggplot
NLS_North2 <- fortify(NLS_North)
CL1_South2 <- fortify(CL1_South)
CL1_Sliver2 <- fortify(CL1_Sliver)
CL2_AccessSoutheast2 <- fortify(CL2_AccessSoutheast)
SF2 <- fortify(SF)
CL2_North2 <- fortify(CL2_North)
CL1_Access2 <- fortify(CL1_Access)
NF2 <- fortify(NF)
CL2_Ext2 <- fortify(CL2_Ext)
GSC2 <- fortify(GSC)
NLS_SouthDeep2 <- fortify(NLS_SouthDeep)
NLS_West2 <- fortify(NLS_West)
NLS_SouthShallow2 <- fortify(NLS_SouthShallow)
CL2_AccessSouthwest2 <- fortify(CL2_AccessSouthwest)
SF_East2 <- fortify(SF_East)

# combine polygons and set CRS
GB_sf <- st_union(NLS_North2, CL1_South2) %>%
  st_union(CL1_Sliver2) %>%
  st_union(CL2_AccessSoutheast2) %>%
  st_union(SF2) %>%
  st_union(CL2_North2) %>%
  st_union(CL1_Access2) %>%
  st_union(NF2) %>%
  st_union(CL2_Ext2) %>%
  st_union(GSC2) %>%
  st_union(NLS_SouthDeep2) %>%
  st_union(NLS_West2) %>%
  st_union(NLS_SouthShallow2) %>%
  st_union(CL2_AccessSouthwest2) %>%
  st_union(SF_East2) %>%
  st_transform(crs = 26919)
  
#summary(GB_sf)

ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", colour = "black", size = 0.5)
```

## Check point placement on polygon
```{r}
ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", colour = "black", size = 0.5) +
  geom_point(data = bottom_sf, aes(x = Long, y = Lat, colour = Salinity)) +
  geom_text(data = bottom_sf, aes(x = Long, y = Lat, label = Station),
            hjust = 0.05, vjust = 0.05, size = 3) +
  scale_colour_viridis() +
  #geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               #fill = "darkgrey", colour = NA) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```

## Move coordinates that are outside GB polygon
```{r}
#bottom_sf1 <- bottom_sf %>%
#  mutate(Long = ifelse(Station == "006", Long + 0.06, Long),
#         Lat = ifelse(Station == "026", Lat + 0.02, Lat),
#         Long = ifelse(Station == "089", Long - 0.04, Long))

#surface_sf1 <- surface_sf %>%
#  mutate(Long = ifelse(Station == "006", Long + 0.06, Long),
#         Lat = ifelse(Station == "026", Lat + 0.02, Lat),
#         Long = ifelse(Station == "089", Long - 0.04, Long))
```

## Begin interpolation round 1 (nearest-neighbor)
```{r}
bottom_sf_geom <- st_union(bottom_sf1) %>%
  st_transform(crs = 26919)
bottom_sf_v <- st_voronoi(bottom_sf_geom)
bottom_sf_v <- st_sf(bottom_sf_v)

surface_sf_geom <- st_union(surface_sf1) %>%
  st_transform(crs = 26919)
surface_sf_v <- st_voronoi(surface_sf_geom)
surface_sf_v <- st_sf(surface_sf_v)

#GB_sf <- GB_sf %>%
  #st_set_precision(1000000) %>%
  #st_make_valid()

#bottom_sf_v <- bottom_sf_v %>%
  #st_set_precision(1000000) %>%
  #st_make_valid()

#surface_sf_v <- surface_sf_v %>%
  #st_set_precision(1000000) %>%
  #st_make_valid()

# mask Voronoi with contour
bottom_sf_v <- st_intersection(st_cast(bottom_sf_v), st_union(st_buffer(GB_sf, dist = 500)))
bottom_sf_v <- st_sf(bottom_sf_v)

#st_crs(bottom_sf_v)

bottom_sf2 <- bottom_sf %>%
  st_transform(crs = 26919)

surface_sf_v <- st_intersection(st_cast(surface_sf_v), st_union(st_buffer(GB_sf, dist = 500)))
surface_sf_v <- st_sf(surface_sf_v)

#st_crs(surface_sf_v)

surface_sf2 <- surface_sf %>%
  st_transform(crs = 26919)

# complete spatial join
bottom_sf_v2 <- st_join(bottom_sf_v, bottom_sf2)
#glimpse(bottom_sf_v2)
surface_sf_v2 <- st_join(surface_sf_v, surface_sf2)
```

## Fill in missing temps
```{r}
bottom_sf_v3 <- bottom_sf_v2 %>%
  mutate(Temp = ifelse(Station == "006", mean(c(Temp[Station == "005"],
                                                Temp[Station == "007"])), Temp),
         Temp = ifelse(Station == "012", 0.271 * Temp[Station == "011"] +
                                         0.305 * Temp[Station == "013"] +
                                         0.203 * Temp[Station == "014"] +
                                         0.221 * Temp[Station == "091"], Temp),
         Temp = ifelse(Station == "016", 0.333 * Temp[Station == "015"] +
                                         0.666 * Temp[Station == "017"], Temp),
         Temp = ifelse(Station == "022", 0.333 * Temp[Station == "023"] +
                                         0.666 * Temp[Station == "019"], Temp),
         Temp = ifelse(Station == "030", mean(c(Temp[Station == "029"],
                                                Temp[Station == "031"])), Temp),
         Temp = ifelse(Station == "081", 0.179 * Temp[Station == "077"] +
                                         0.220 * Temp[Station == "080"] +
                                         0.238 * Temp[Station == "082"] +
                                         0.204 * Temp[Station == "083"] +
                                         0.159 * Temp[Station == "084"], Temp),
         Temp = ifelse(Station == "111", 0.304 * Temp[Station == "107"] +
                                         0.348 * Temp[Station == "108"] +
                                         0.348 * Temp[Station == "112"], Temp),
         Temp = ifelse(Station == "114", 0.205 * Temp[Station == "107"] +
                                         0.178 * Temp[Station == "108"] +
                                         0.230 * Temp[Station == "112"] +
                                         0.387 * Temp[Station == "113"], Temp))

surface_sf_v3 <- surface_sf_v2 %>%
  mutate(Temp = ifelse(Station == "006", mean(c(Temp[Station == "005"],
                                                Temp[Station == "007"])), Temp),
         Temp = ifelse(Station == "012", 0.271 * Temp[Station == "011"] +
                                         0.305 * Temp[Station == "013"] +
                                         0.203 * Temp[Station == "014"] +
                                         0.221 * Temp[Station == "091"], Temp),
         Temp = ifelse(Station == "016", 0.333 * Temp[Station == "015"] +
                                         0.666 * Temp[Station == "017"], Temp),
         Temp = ifelse(Station == "022", 0.333 * Temp[Station == "023"] +
                                         0.666 * Temp[Station == "019"], Temp),
         Temp = ifelse(Station == "030", mean(c(Temp[Station == "029"],
                                                Temp[Station == "031"])), Temp),
         Temp = ifelse(Station == "081", 0.179 * Temp[Station == "077"] +
                                         0.220 * Temp[Station == "080"] +
                                         0.238 * Temp[Station == "082"] +
                                         0.204 * Temp[Station == "083"] +
                                         0.159 * Temp[Station == "084"], Temp),
         Temp = ifelse(Station == "111", 0.304 * Temp[Station == "107"] +
                                         0.348 * Temp[Station == "108"] +
                                         0.348 * Temp[Station == "112"], Temp),
         Temp = ifelse(Station == "114", 0.205 * Temp[Station == "107"] +
                                         0.178 * Temp[Station == "108"] +
                                         0.230 * Temp[Station == "112"] +
                                         0.387 * Temp[Station == "113"], Temp))
```

## Make interpolated plots
```{r}
# make bottom plots
ggplot() +
  geom_sf(data = bottom_sf_v3, aes(fill = Temp), size = 0.25, colour = NA) +
  scale_fill_viridis() +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Temperature")

ggplot() +
  geom_sf(data = bottom_sf_v3, aes(fill = Salinity), size = 0.25, colour = NA) +
  scale_fill_viridis() +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Salinity")

ggplot() +
  geom_sf(data = bottom_sf_v3, aes(fill = DIC), size = 0.25, colour = NA) +
  scale_fill_viridis() +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC")

ggplot() +
  geom_sf(data = bottom_sf_v3, aes(fill = TA), size = 0.25, colour = NA) +
  scale_fill_viridis(limits = c(2180, 2300)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom TA")

# make surface plots
ggplot() +
  geom_sf(data = surface_sf_v3, aes(fill = Temp), size = 0.25, colour = NA) +
  scale_fill_viridis() +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Temperature")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  scale_fill_viridis() +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface Salinity")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = DIC), size = 0.25, colour = NA) +
  scale_fill_viridis() +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface DIC")

ggplot() +
  geom_sf(data = surface_sf_v2, aes(fill = TA), size = 0.25, colour = NA) +
  scale_fill_viridis(limits = c(2180, 2300)) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Surface TA")
```

## Calculate carbon system parameters
```{r}
library(seacarb)

carb(15, may$TA, may$DIC, S = may$Salinity, T = Temp, Patm = *, P = SeaPressure, k1k2 = 1) # flag:15 = ALK & DIC   # k1k2:1 = Lueker et al. (2000)   # 
```
