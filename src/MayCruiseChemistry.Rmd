---
title: "MayCruiseChemistry"
author: "Dylan Titmuss"
date: "1/19/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script visualizes the chemistry data from the May RSA cruise.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")
```

## Load packages
```{r}
library(tidyverse)
library(sf)
library(numform)
library(sp)
library(viridis)
```

## Load data
```{r}
setwd("./Repos/ScallopRSA2021")

chem <- read.csv("./data/StationData.csv") %>%
  mutate(Station = str_extract(BottleID, "[0-9]{3}"),
         Cast = rep(NA, 228))

for(i in 1:length(chem$BottleID)) {
  c <- str_extract(chem$BottleID[i], ".$")
  if(c == "A") {
    chem$Cast[i] <- "Bottom"
  } else if (c == "B") {
    chem$Cast[i] <- "Surface"
  }
}

chem$Cast[1] <- "Surface" # correct flipped bottles
chem$Cast[2] <- "Bottom"
```

## Prop-prop plots
```{r}
ggplot(chem, aes(x = Salinity, y = Temp, col = CTD_depth, shape = Cast)) +
  geom_point() +
  scale_colour_viridis(option = "rocket", direction = -1) +
  theme_bw()

ggplot(chem, aes(x = Salinity, y = DIC_avg, shape = Cast)) +
  geom_point() +
  theme_bw()

ggplot(chem, aes(x = DIC_avg, y = TA_avg, shape = Cast)) +
  geom_point() +
  theme_bw()
```

## Visualize TA data
```{r}
ggplot(chem, aes(x = Cast, y = TA_avg)) +
  geom_boxplot() +
  theme_bw()

ggplot(chem, aes(x = Salinity, y = TA_avg)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()

ggplot(chem, aes(x = Salinity, y = TA_avg, col = Cast)) +
  geom_point() +
  scale_colour_manual(values = c("black", "red")) +
  theme_bw()

chem <- chem %>%
  mutate(Ratio = TA_avg / Salinity) %>%
  arrange(TA_avg)

ggplot(chem, aes(x = Ratio)) +
  geom_histogram() +
  theme_bw()

ggplot(chem, aes(x = TA_avg)) +
  geom_histogram() +
  theme_bw()

which(chem$TA_avg == min(chem$TA_avg))
which(chem$TA_avg < 2190)

plot(chem$TA_avg ~ chem$Salinity)
abline(lm(chem$TA_avg ~ chem$Salinity))
identify(chem$TA_avg ~ chem$Salinity)

lm(chem$TA_avg ~ chem$Salinity)

chem <- chem %>%
  mutate(line = Salinity * 45.19 + 736.94,
         resid = TA_avg - line) %>%
  arrange(desc(abs(resid)))

### ***TA or sal value for 053B (surface) seems wrong***

# TA value for 052B (surface) is questionable; salinity seems okay
# 049B salinity is questionable (took screenshot)
# 113A & 113B both questionable

# RSA_053B: -38.73061
# RSA_052B: -26.84136
# RSA_113B: -20.71048
# RSA_049B: -20.69908
# RSA_082A: 19.15330
# RSA_113A: -17.34985
# RSA_097B: 17.07788
# RSA_114A: -14.15680
```

## marmap version
```{r}
library(marmap)
library(mapdata)
library(mapproj)
# Create base map with NOAA data
GB_bathy <- getNOAA.bathy(lon1 = -70.5, lon2 = -66, lat1 = 40, lat2 = 42.5, resolution = 1)

ggbathy <- GB_bathy %>%
  fortify() %>%
  mutate(lat = y, long = x, depth = z) %>%
  select(-c(x, y, z)) %>%
  mutate(depth_bins = cut(depth, breaks = c(0, -30, -55, -75, -90, -120, -150, -180, -780, -1380, -1980, -2580, -3180, -Inf)))

# get regional polygons
reg = map_data("world2Hires")
reg = subset(reg, region %in% 'USA')

# convert lat longs
reg$long = (360 - reg$long)*-1

map <- ggplot() +
  geom_raster(data = ggbathy, aes(long, lat, fill = depth_bins), interpolate = TRUE, alpha = 0.75) +
  scale_fill_manual(values = c("#08306B", "#084184", "#08519C", "#1561A9", "#2171B5", "#3282BE", "#4292C6", "#57A0CE", "#6BAED6", "#85BCDC", "#9ECAE1", "#B2D3E8", "#C6DBEF"), guide = "none") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(breaks = c(40, 41, 42), expand = c(0, 0)) +
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", colour = NA) +
  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
  theme(axis.title = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
```

## Load station data & convert coordinates
```{r}
may <- read.csv("./data/MayCruiseData.csv") %>%
  rename(Lat = Latitude_degrees_start,
         Long = Longitude_degrees_start,
         depth = Depth_meters) %>%
  select(Station, Cast, Lat, Long, depth) %>%
  mutate(Station = as.character(f_pad_zero(Station))) # add leading zeros to station numbers

chd <- substr(may$Lat, 3, 3)[1]

# convert latitude from DM to DD
Lat_split_may <- str_split_fixed(may$Lat, chd, 2) %>%
  as.data.frame()
Lat_split_may$V2 <- str_remove_all(Lat_split_may$V2, pattern = "'") %>%
  as.numeric()
Lat_split_may$V2 <- Lat_split_may$V2/60
Lat_split_may$V1 <- as.numeric(Lat_split_may$V1)

may$Lat <- Lat_split_may$V1 + Lat_split_may$V2

# convert longitude from DM to DD
Long_split_may <- str_split_fixed(may$Long, chd, 2) %>%
  as.data.frame()
Long_split_may$V2 <- str_remove_all(Long_split_may$V2, pattern = "'") %>%
  as.numeric()
Long_split_may$V2 <- Long_split_may$V2/60
Long_split_may$V1 <- as.numeric(Long_split_may$V1)

may$Long <- -(Long_split_may$V1 + Long_split_may$V2)

# combine chemistry data & station info
stationChem <- right_join(may, chem, by = c("Station", "Cast"))
```

## Add chem to shapefile
```{r}
station_SPDF <- SpatialPointsDataFrame(coords = stationChem[ , c("Long","Lat")],
                                        data = stationChem[ ,c("Long", "Lat", "Station", "Cast", "depth",
                                                             "Temp", "Salinity", "DIC_avg", "TA_avg")],
                                        proj4string = CRS("+init=epsg:4326"))

station_sf <- st_as_sf(station_SPDF) %>%
  st_transform(crs = 4326)

bottom_sf <- station_sf %>%
  filter(Cast == "Bottom")

surface_sf <- station_sf %>%
  filter(Cast == "Surface")
```

## Add points to map
```{r}
min(chem$Temp, na.rm = TRUE)
max(chem$Temp, na.rm = TRUE)

bottomTemp <- map +
  geom_sf(data = bottom_sf, aes(size = Temp, colour = Temp), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(6.5, 10.5), option = "rocket") +
  scale_size_continuous(limits = c(6.5, 10.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Temperature (C)"), size = guide_legend(reverse = TRUE, title = "Temperature (C)")) +
  labs(title = "Bottom Temperature") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomTemp

surfaceTemp <- map +
  geom_sf(data = surface_sf, aes(size = Temp, colour = Temp), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(6.5, 10.5), option = "rocket") +
  scale_size_continuous(limits = c(6.5, 10.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Temperature (C)"), size = guide_legend(reverse = TRUE, title = "Temperature (C)")) +
  labs(title = "Surface Temperature") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceTemp

min(chem$Salinity)
max(chem$Salinity)

bottomSal <- map +
  geom_sf(data = bottom_sf, aes(size = Salinity, colour = Salinity), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(32, 34.5), option = "rocket") +
  scale_size_continuous(limits = c(32, 34.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Salinity (PSU)"), size = guide_legend(reverse = TRUE, title = "Salinity (PSU)")) +
  labs(title = "Bottom Salinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomSal

surfaceSal <- map +
  geom_sf(data = surface_sf, aes(size = Salinity, colour = Salinity), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(32, 34.5), option = "rocket") +
  scale_size_continuous(limits = c(32, 34.5), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "Salinity (PSU)"), size = guide_legend(reverse = TRUE, title = "Salinity (PSU)")) +
  labs(title = "Surface Salinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceSal

min(chem$DIC_avg)
max(chem$DIC_avg)

bottomDIC <- map +
  geom_sf(data = bottom_sf, aes(size = DIC_avg, colour = DIC_avg), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(1950, 2150), option = "rocket") +
  scale_size_continuous(limits = c(1950, 2150), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "DIC (umol/kg)"), size = guide_legend(reverse = TRUE, title = "DIC (umol/kg)")) +
  labs(title = "Bottom DIC") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomDIC

surfaceDIC <- map +
  geom_sf(data = surface_sf, aes(size = DIC_avg, colour = DIC_avg), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(1950, 2150), option = "rocket") +
  scale_size_continuous(limits = c(1950, 2150), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "DIC (umol/kg)"), size = guide_legend(reverse = TRUE, title = "DIC (umol/kg)")) +
  labs(title = "Surface DIC") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceDIC

min(chem$TA_avg)
max(chem$TA_avg)

bottomTA <- map +
  geom_sf(data = bottom_sf, aes(size = TA_avg, colour = TA_avg), inherit.aes = FALSE) +
  #geom_sf_text(data = bottom_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2175, 2300), option = "rocket") +
  scale_size_continuous(limits = c(2175, 2300), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "TA (umol/kg)"), size = guide_legend(reverse = TRUE, title = "TA (umol/kg)")) +
  labs(title = "Bottom Alkalinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

bottomTA

surfaceTA <- map +
  geom_sf(data = surface_sf, aes(size = TA_avg, colour = TA_avg), inherit.aes = FALSE) +
  #geom_sf_text(data = surface_sf, aes(label = Station), nudge_x = 0, nudge_y = 0.09, size = 3.5, inherit.aes = FALSE) +
  scale_colour_viridis(limits = c(2175, 2300), option = "rocket") +
  scale_size_continuous(limits = c(2175, 2300), range = c(2, 6)) +
  guides(colour = guide_legend(reverse = TRUE, title = "TA (umol/kg)"), size = guide_legend(reverse = TRUE, title = "TA (umol/kg)")) +
  labs(title = "Surface Alkalinity") +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5), crs = st_crs(4326)) +
  theme(legend.key = element_blank(),
        legend.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))

surfaceTA
```

## Attempt to interpolate chem parameters

### Check mapping
```{r}
# filter null points (no CTD temp)
bottomTemp_filt <- bottom_sf %>%
  filter(!is.na(Temp))

# create plot to check mapping
ggplot(bottomTemp_filt, aes(x = Long, y = Lat)) +
  geom_point(aes(colour = Temp)) +
  geom_text(aes(label = Station), hjust = 0.05, vjust = 0.05, size = 3) +
  scale_colour_gradientn(colours = c("navyblue", "blue", "cyan", "green", "yellow", "orange", "red")) +
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", colour = NA) +
  coord_cartesian(xlim = c(-70.5, -66), ylim = c(40, 42.5)) +
  scale_y_continuous(breaks = c(40, 41, 42))
```

## Load GB shapefiles
```{r}
GB <- st_read("./data/2020SAMZones/GB_Estimation_Areas_2019_UTM19_PDT_SFModified.shp")

# subset shapefile to SAMs
NLS_North <- subset(GB, NewSAMS == "NLS-North")
CL1_South <- subset(GB, NewSAMS == "CL1-South")
CL1_Sliver <- subset(GB, NewSAMS == "CL1-Sliver")
CL2_AccessSoutheast <- subset(GB, NewSAMS == "CL2-Access-Southeast")
SF <- subset(GB, NewSAMS == "SF")
CL2_North <- subset(GB, NewSAMS == "CL2-North")
CL1_Access <- subset(GB, NewSAMS == "CL1-Access")
NF <- subset(GB, NewSAMS == "NF")
CL2_Ext <- subset(GB, NewSAMS == "CL2-Ext")
GSC <- subset(GB, NewSAMS == "GSC")
NLS_SouthDeep <- subset(GB, NewSAMS == "NLS-South-Deep")
NLS_West <- subset(GB, NewSAMS == "NLS-West")
NLS_SouthShallow <- subset(GB, NewSAMS == "NLS-South-Shallow")
CL2_AccessSouthwest <- subset(GB, NewSAMS == "CL2-Access-Southwest")
SF_East <- subset(GB, NewSAMS == "SF-East")

# fortify regions for use with ggplot
NLS_North2 <- fortify(NLS_North)
CL1_South2 <- fortify(CL1_South)
CL1_Sliver2 <- fortify(CL1_Sliver)
CL2_AccessSoutheast2 <- fortify(CL2_AccessSoutheast)
SF2 <- fortify(SF)
CL2_North2 <- fortify(CL2_North)
CL1_Access2 <- fortify(CL1_Access)
NF2 <- fortify(NF)
CL2_Ext2 <- fortify(CL2_Ext)
GSC2 <- fortify(GSC)
NLS_SouthDeep2 <- fortify(NLS_SouthDeep)
NLS_West2 <- fortify(NLS_West)
NLS_SouthShallow2 <- fortify(NLS_SouthShallow)
CL2_AccessSouthwest2 <- fortify(CL2_AccessSouthwest)
SF_East2 <- fortify(SF_East)

# combine polygons and set CRS
GB_sf <- st_union(NLS_North2, CL1_South2) %>%
  st_union(CL1_Sliver2) %>%
  st_union(CL2_AccessSoutheast2) %>%
  st_union(SF2) %>%
  st_union(CL2_North2) %>%
  st_union(CL1_Access2) %>%
  st_union(NF2) %>%
  st_union(CL2_Ext2) %>%
  st_union(GSC2) %>%
  st_union(NLS_SouthDeep2) %>%
  st_union(NLS_West2) %>%
  st_union(NLS_SouthShallow2) %>%
  st_union(CL2_AccessSouthwest2) %>%
  st_union(SF_East2) %>%
  st_transform(crs = 26919)
  
summary(GB_sf)

ggplot() +
  geom_sf(data = GB_sf, fill = "lightblue", colour = "black", size = 0.5)
```

## Begin interpolation round 1 (nearest-neighbor)
```{r}
bottom_sf_geom <- st_union(bottom_sf) %>%
  st_transform(crs = 26919)
bottom_sf_v <- st_voronoi(bottom_sf_geom)
bottom_sf_v <- st_sf(bottom_sf_v)

GB_sf <- GB_sf %>%
  st_set_precision(1000000) %>%
  st_make_valid()

bottom_sf_v <- bottom_sf_v %>%
  st_set_precision(1000000) %>%
  st_make_valid()

# mask Voronoi with contour
bottom_sf_v <- st_intersection(st_cast(bottom_sf_v), st_union(st_buffer(GB_sf, dist = 500)))
bottom_sf_v <- st_sf(bottom_sf_v)

bottom_sf2 <- bottom_sf %>%
  st_transform(crs = 26919)

# complete spatial join
bottom_sf_v2 <- st_join(bottom_sf_v, bottom_sf2)
glimpse(bottom_sf_v2)

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = Temp), size = 0.25, colour = NA) +
  scale_fill_gradientn(colours = c("navyblue", "blue", "cyan", "green", "yellow", "orange", "red")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Temperature")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = Salinity), size = 0.25, colour = NA) +
  scale_fill_gradientn(colours = c("navyblue", "blue", "cyan", "green", "yellow", "orange", "red")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom Salinity")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = DIC_avg), size = 0.25, colour = NA) +
  scale_fill_gradientn(colours = c("navyblue", "blue", "cyan", "green", "yellow", "orange", "red")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom DIC")

ggplot() +
  geom_sf(data = bottom_sf_v2, aes(fill = TA_avg), size = 0.25, colour = NA) +
  scale_fill_gradientn(colours = c("navyblue", "blue", "cyan", "green", "yellow", "orange", "red")) +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16)) +
  labs(title = "Bottom TA")
```

## Attempt to add coastline polygon -- not working rn
```{r}
ggplot() +
  geom_polygon(data = reg, aes(x = long, y = lat, group = group), 
               fill = "darkgrey", colour = NA) +
  coord_sf(xlim = c(-70.5, -66), ylim = c(40, 42.5))

reg_SPDF <- SpatialPointsDataFrame(coords = reg[ , c("long","lat")],
                                        data = reg,
                                        proj4string = CRS("+init=epsg:26919"))

reg_sf <- st_as_sf(reg_SPDF) %>%
  st_transform(crs = 26919)

ggplot() +
  geom_sf(data = reg_sf, fill = "lightblue") +
  coord_sf(xlim = c(371957.88, 746508.34), ylim = c(4428833.79, 4709654.16), crs = st_crs(26919))
# why won't my map show up :(((
```

## Now for interpolation style 2 (inverse distance weighting)
```{r}

```

## Look at chlorophyll data
```{r}
library(tidync)
```






























## Load Oct datasheet
```{r}
oct <- read.csv("./data/OctoberCruiseData.csv") %>%
  rename(octLat = Latitude_degrees_start,
         octLong = Longitude_degrees_start,
         depth = Depth_meters) %>%
  select(Station, Cast, octLat, octLong, depth)

# convert latitude from DM to DD
Lat_split_oct <- str_split_fixed(oct$octLat, chd, 2) %>%
  as.data.frame()
Lat_split_oct$V2 <- str_remove_all(Lat_split_oct$V2, pattern = "'") %>%
  as.numeric()
Lat_split_oct$V2 <- Lat_split_oct$V2/60
Lat_split_oct$V1 <- as.numeric(Lat_split_oct$V1)

oct$octLat <- Lat_split_oct$V1 + Lat_split_oct$V2

# convert longitude from DM to DD
Long_split_oct <- str_split_fixed(oct$octLong, chd, 2) %>%
  as.data.frame()
Long_split_oct$V2 <- str_remove_all(Long_split_oct$V2, pattern = "'") %>%
  as.numeric()
Long_split_oct$V2 <- Long_split_oct$V2/60
Long_split_oct$V1 <- as.numeric(Long_split_oct$V1)

oct$octLong <- -(Long_split_oct$V1 + Long_split_oct$V2)
```

## Compare May vs Oct coordinates
```{r}
may <- may %>%
  rename(mayLat = Lat,
         mayLong = Long)

joined <- left_join(may, oct, by = c("Station", "Cast"), suffix = c("_may", "_oct")) %>%
  mutate(diffLat = abs(mayLat - octLat), diffLong = abs(mayLong - octLong))

max(joined$diffLat)
max(joined$diffLong)
which(joined$diffLat > 0.05)
which(joined$diffLong > 0.05)
```
