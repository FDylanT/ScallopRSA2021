---
title: "OctCruiseChemistry"
author: "Dylan Titmuss"
date: "3/15/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script manipulates the chemistry data from the October RSA cruise.

## Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/Desktop/Repos/ScallopRSA2021")

library(tidyverse)
library(numform) # for f_pad_zero()
library(seacarb)
library(gsw) # for AOU
library(viridis)
```

## Load data
```{r}
setwd("~/Desktop/Repos/ScallopRSA2021")

oct <- read.csv("./data/OctCruiseData.csv") %>%
  rename(Lat = Latitude_degrees_start,
         Long = Longitude_degrees_start,
         Depth = Depth_m_CTD,
         Temp = Temperature,
         DO = Dissolved_oxygen) %>%
  filter(Filtered == "") %>%
  select(Station, Cast, BottleID, Lat, Long,
         Depth, Temp, Pressure, SeaPressure, Salinity,
         DIC, TA, DO, DO_sat) %>%
  mutate(Station = as.character(f_pad_zero(Station))) # add leading zeros to stations
```

## Convert coordinates from DM to DD
```{r}
chd <- substr(oct$Lat, 3, 3)[1]

# latitude
Lat_split_oct <- str_split_fixed(oct$Lat, chd, 2) %>%
                 as.data.frame()
Lat_split_oct$V2 <- str_remove_all(Lat_split_oct$V2, pattern = "'") %>%
                    as.numeric()
Lat_split_oct$V2 <- Lat_split_oct$V2/60
Lat_split_oct$V1 <- as.numeric(Lat_split_oct$V1)

oct$Lat <- Lat_split_oct$V1 + Lat_split_oct$V2
rm(Lat_split_oct)

# longitude
Long_split_oct <- str_split_fixed(oct$Long, chd, 2) %>%
                  as.data.frame()
Long_split_oct$V2 <- str_remove_all(Long_split_oct$V2, pattern = "'") %>%
                     as.numeric()
Long_split_oct$V2 <- Long_split_oct$V2/60
Long_split_oct$V1 <- as.numeric(Long_split_oct$V1)

oct$Long <- -(Long_split_oct$V1 + Long_split_oct$V2)
rm(Long_split_oct)
rm(chd)
```

## Fill in missing temp & DO values
```{r}
# temp
oct <- oct %>%
  mutate(Temp = ifelse(Station == "022", 0.611 * Temp[Station == "019"] +
                                         0.389 * Temp[Station == "024"], Temp),
         Temp = ifelse(Station == "023", Temp[Station == "021"], Temp),
         Temp = ifelse(Station == "104", 0.249 * Temp[Station == "094"] +
                                         0.303 * Temp[Station == "103"] +
                                         0.212 * Temp[Station == "105"] +
                                         0.236 * Temp[Station == "106"], Temp))

# DO
oct <- oct %>%
  mutate(DO = ifelse(Station == "022", 0.611 * DO[Station == "019"] +
                                       0.389 * DO[Station == "024"], DO),
         DO = ifelse(Station == "023", DO[Station == "021"], DO),
         DO = ifelse(Station == "104", 0.249 * DO[Station == "094"] +
                                       0.303 * DO[Station == "103"] +
                                       0.212 * DO[Station == "105"] +
                                       0.236 * DO[Station == "106"], DO))
```

## Calculate carbon system parameters & density
```{r}
for(i in which(is.na(oct$SeaPressure))) {
    oct$SeaPressure[i] <- oct$Depth[i] # substitute depth for sites without sea pressure
    oct$Pressure[i] <- oct$SeaPressure[i] + 10.1325 # calculate surface pressure
}

octCarb <- carb(flag = 15,                               # 15 = ALK & DIC given
                var1 = oct$TA / 10^6,                    # in mol/kg
                var2 = oct$DIC / 10^6,                   # in mol/kg
                S = oct$Salinity,
                T = oct$Temp,                            # in deg C
                Patm = oct$Pressure * 0.098692326671601, # in atm
                P = oct$SeaPressure / 10,                # in bar
                k1k2 = "l",                              # l = Lueker et al. (2000)
                                                         # kf: unspecified b/c low temps
                ks = "d",                                # d = Dickson (1990)
                b = "l10")                               # l10 = Lee et al. (2010)

# calculate density
oct$Density <- gsw_rho(oct$Salinity, oct$Temp, oct$SeaPressure) # kg/m^3

# combine oct & carb data
oct <- cbind(oct,
             pH = octCarb$pH,
             fCO2 = octCarb$fCO2,
             pCO2 = octCarb$pCO2,
             OmegaAragonite = octCarb$OmegaAragonite,
             OmegaCalcite = octCarb$OmegaCalcite)
```

## Calculate AOU
```{r}
# calc absolute sal
oct$AbsSal <- gsw_SA_from_SP(SP = oct$Salinity,
                             p = oct$SeaPressure,
                             longitude = oct$Long,
                             latitude = oct$Lat)

# calc conservative temp
oct$ConsTemp <- gsw_CT_from_t(SA = oct$AbsSal,
                              t = oct$Temp,
                              p = oct$SeaPressure)

# calc O2 sol
oct$O2sol <- gsw_O2sol(SA = oct$AbsSal,
                       CT = oct$ConsTemp,
                       p = oct$SeaPressure,
                       longitude = oct$Long,
                       latitude = oct$Lat)

# calc AOU
oct$AOU <- oct$O2sol - oct$DO
```

# MIXING ANALYSIS

## Identify end-members
```{r}
# surface
oct %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = Salinity, y = Temp, shape = Cast, col = Cast)) +
    geom_text(aes(label = as.integer(Station)), size = 3) +
    scale_colour_manual(values = "coral2") +
    theme_bw()

# calling 5, 43, 7 EMs

# bottom
oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = Salinity, y = Temp, shape = Cast, col = Cast)) +
    geom_text(aes(label = as.integer(Station)), size = 3) +
    scale_colour_manual(values = "darkblue") +
    theme_bw()

# calling 33, 53, 9 EMs
```

## Find endmember property values
```{r}
# surface EMs
EM1 <- which(oct$Station == "005" & oct$Cast == "Surface")
EM2 <- which(oct$Station == "043" & oct$Cast == "Surface")
EM3 <- which(oct$Station == "007" & oct$Cast == "Surface")

# bottom EMs
EM4 <- which(oct$Station == "033" & oct$Cast == "Bottom")
EM5 <- which(oct$Station == "053" & oct$Cast == "Bottom")
EM6 <- which(oct$Station == "009" & oct$Cast == "Bottom") # this gives WOW dDIC-AOU correlation

# pull values for EMs
S1 <- oct$Salinity[EM1]
S2 <- oct$Salinity[EM2]
S3 <- oct$Salinity[EM3]

S4 <- oct$Salinity[EM4]
S5 <- oct$Salinity[EM5]
S6 <- oct$Salinity[EM6]

T1 <- oct$Temp[EM1]
T2 <- oct$Temp[EM2]
T3 <- oct$Temp[EM3]

T4 <- oct$Temp[EM4]
T5 <- oct$Temp[EM5]
T6 <- oct$Temp[EM6]

DIC1 <- oct$DIC[EM1]
DIC2 <- oct$DIC[EM2]
DIC3 <- oct$DIC[EM3]

DIC4 <- oct$DIC[EM4]
DIC5 <- oct$DIC[EM5]
DIC6 <- oct$DIC[EM6]

TA1 <- oct$TA[EM1]
TA2 <- oct$TA[EM2]
TA3 <- oct$TA[EM3]

TA4 <- oct$TA[EM4]
TA5 <- oct$TA[EM5]
TA6 <- oct$TA[EM6]
```

## Calculate mixing-normalized DIC & TA values
```{r}
oct$DICn <- NA
oct$TAn <- NA
oct$dDIC <- NA
oct$dTA <- NA

## process used to solve the system of eq is at the end of this script

# a1*DIC1 + a2*DIC2 + a3*DIC3 = oct$DICn[i]
# a1*TA1 + a2*TA2 + a3*TA3 = oct$TAn[i]
# oct$DIC[i] - oct$DICn[i] = oct$dDICn[i]
# oct$TA[i] - oct$TAn[i] = oct$dTAn[i]

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
       a3 = (oct$Salinity[i] - S1 - oct$Temp[i]*(S2-S1)/(T2-T1) + T1*(S2-S1)/(T2-T1)) /
         ((S3-S1) - (T3-T1)*(S2-S1)/(T2-T1))
       a2 = (oct$Temp[i] - T1 - a3*(T3-T1)) / (T2-T1)
       a1 = 1 - (a2 + a3)
       oct$a1[i] = a1
       oct$a2[i] = a2
       oct$a3[i] = a3
       oct$DICn[i] = a1*DIC1 + a2*DIC2 + a3*DIC3
       oct$dDIC[i] = oct$DIC[i] - oct$DICn[i]   # observed - expected
       oct$TAn[i] = a1*TA1 + a2*TA2 + a3*TA3
       oct$dTA[i] = oct$TA[i] - oct$TAn[i]   # observed - expected
     } else if(oct$Cast[i] == "Bottom") {
       a6 = (oct$Salinity[i] - S4 - oct$Temp[i]*(S5-S4)/(T5-T4) + T4*(S5-S4)/(T5-T4)) /
         ((S6-S4) - (T6-T4)*(S5-S4)/(T5-T4))
       a5 = (oct$Temp[i] - T4 - a6*(T6-T4)) / (T5-T4)
       a4 = 1 - (a5 + a6)
       oct$a4[i] = a4
       oct$a5[i] = a5
       oct$a6[i] = a6
       oct$DICn[i] = a4*DIC4 + a5*DIC5 + a6*DIC6
       oct$dDIC[i] = oct$DIC[i] - oct$DICn[i]   # observed - expected
       oct$TAn[i] = a4*TA4 + a5*TA5 + a6*TA6
       oct$dTA[i] = oct$TA[i] - oct$TAn[i]   # observed - expected
     }
}
```

## Plot delta values
```{r}
oct %>%
  ggplot(aes(x = dDIC, y = dTA)) +
  geom_point(aes(shape = Cast)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_abline(intercept = 0, slope = 2) +
  geom_abline(intercept = 0, slope = -17/106) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  theme_bw()

# negative DIC means DIC < expected --> photosynth signal
  # combination of photosynth & calcification/precipitation
# positive DIC means DIC > expected --> respiration signal
  # combination of respiration & dissolution

# positive TA is combination of dissolution & photosynthesis
# negative TA is combination of calcification/precipitation & respiration

# surface
oct %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = dDIC, y = dTA)) +
  geom_point(aes(shape = Cast, col = pCO2)) + # color by pCO2
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_abline(intercept = 0, slope = 2) +
  geom_abline(intercept = 0, slope = -17/106) +
  scale_shape_manual(values = 1) +
  scale_colour_viridis(limits = c(330, 510), option = "magma") +
  theme_bw()
```

## Plot AOU data
```{r}
oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = dDIC, y = dTA)) +
  geom_point(aes(shape = Cast, col = AOU)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_abline(intercept = 0, slope = 2) +
  geom_abline(intercept = 0, slope = -17/106) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_color_viridis(option = "magma") +
  theme_bw()

# dDIC vs AOU
oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = dDIC, y = AOU, shape = Cast, col = Cast)) +
    geom_point() +
    #geom_text(aes(label = as.integer(Station)), size = 3) +
    geom_point(data = oct[((oct$Station == "009" |
                            oct$Station == "033" |
                            oct$Station == "053") &
                            oct$Cast == "Bottom"), ],
               col = "red", size = 3) +
    scale_colour_manual(values = "darkblue") +
    theme_bw() +
    theme(legend.position = "none") + 
    geom_vline(xintercept = 0, linetype = 2) +
    geom_hline(yintercept = 0, linetype = 2)

oct.bottom <- oct %>%
  filter(Cast == "Bottom")

lm(oct.bottom$AOU ~ oct.bottom$dDIC) # slope = 0.4223

ggplot(oct, aes(x = AOU, y = dDIC, shape = Cast)) +
  geom_point() +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_abline(slope = 0.768) +   # 106/138
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()

lm(oct.bottom$dDIC ~ oct.bottom$AOU) # 0.505

# dTA vs AOU
ggplot(oct, aes(x = AOU, y = dTA, shape = Cast)) +
  geom_point() +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_abline(slope = -0.123) +   # -17/138   # negative for AOU
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()

lm(oct.bottom$dTA ~ oct.bottom$AOU) # -0.1142

# AOU vs Sal
ggplot(oct, aes(x = Salinity, y = AOU, shape = Cast, col = Cast)) +
  geom_point() +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_colour_manual(values = c("darkblue", "coral2"),
                      guide = guide_legend(reverse = TRUE)) +
  theme_bw()
```

## O2 mixing analysis
```{r}
DO1 <- oct$DO[EM1]
DO2 <- oct$DO[EM2]
DO3 <- oct$DO[EM3]

DO4 <- oct$DO[EM4]
DO5 <- oct$DO[EM5]
DO6 <- oct$DO[EM6]

oct$DOn <- NA
oct$dDO <- NA

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
       oct$DOn[i] = a1*DO1 + a2*DO2 + a3*DO3
       oct$dDO[i] = oct$DO[i] - oct$DOn[i]   # observed - expected
     } else if(oct$Cast[i] == "Bottom") {
       oct$DOn[i] = a4*DO4 + a5*DO5 + a6*DO6
       oct$dDO[i] = oct$DO[i] - oct$DOn[i]   # observed - expected
     }
}
```

## Visualize DO prop-prop
```{r}
oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = dDIC, y = dTA)) +
  geom_point(aes(shape = Cast, col = dDO)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_color_viridis(option = "magma") +
  theme_bw()

oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = dDIC, y = dDO)) +
  geom_point(aes(shape = Cast)) +
  #geom_text(aes(label = as.integer(Station)), size = 3) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16)) +
  theme_bw()

oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = dTA, y = dDO)) +
  geom_point(aes(shape = Cast)) +
  #geom_text(aes(label = as.integer(Station)), size = 3) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16)) +
  theme_bw()

oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = dDO, y = AOU)) +
  geom_point(aes(shape = Cast)) +
  #geom_text(aes(label = as.integer(Station)), size = 3) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16)) +
  theme_bw()
```

## Convert dDO to DIC & TA signals
```{r}
# calling the "other" component of DO negligible; therefore dDO is all aerobic

# dDO umol/kg * 106 (DIC) / 138 (O2) = prod/resp DIC signal
oct$prDIC <- oct$dDO * 106 / 138

# dDO umol/kg * 17 (TA) / 138 (O2) = prod/resp TA signal
oct$prTA <- oct$dDO * 17 / 138
```

## Calculate "other" components of DIC & TA
```{r}
oct$DIC.other <- NA
oct$TA.other <- NA

oct$DIC.other <- oct$DIC - oct$DICn - oct$prDIC
oct$TA.other = oct$TA - oct$TAn - oct$prTA
```

## Plot "other" components
```{r}
oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = DIC.other, y = TA.other)) +
  geom_point(aes(shape = Cast)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  theme_bw()

oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = DIC.other, y = TA.other)) +
  geom_point(aes(shape = Cast, col = AOU)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  scale_color_viridis(option = "magma") +
  theme_bw()

oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = DIC.other, y = dDO)) +
  geom_point(aes(shape = Cast)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16, 1),
                     guide = guide_legend(reverse = TRUE)) +
  theme_bw()
```

## Calculate air-sea CO2 flux
```{r}
# F = k*K0(pCO2w – pCO2a)       # F: mass/area*time
                                # k: length/time
                                # K0: mass/volume*pressure (solubility)

# Schmidt number: kinematic viscosity of the water divided by diffusion coefficient of the gas
  # gas- & temp-specific; also somewhat dependent on salinity

  # Sc = A + Bt + Ct^2 + Dt^3 + Et^4
    # t in °C
    # kinematic viscosity from Sharqawy et al. 2010
    # diffusion coefficient from Jähne et al. 1987

A = 2116.8
B = -136.25
C = 4.7353
D = -0.092307
E = 0.000755566

oct$Sc <- NA

# library(marelac)

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
    t = oct$Temp[i]
    oct$Sc[i] = A + B*t + C*t^2 + D*t^3 + E*t^4
    # Schmidt number check
    # oct$Sc2[i] <- gas_schmidt(t, species = "CO2") # calculated @ sal = 35
  }
}

# which(abs(oct$Sc - oct$Sc2) > 7) # all w/in 7 of each other

####################

# k (cm/hr) = 0.251 * U10^2 * (Sc/660)^-0.5   (Wanninkhof 2014)
  # U10 (m/s) = average of neutral stability winds at 10-m height
      # ****need data corr. to 10m****
      # average 30 days around cruise
# k (cm/hr) = 0.266 * U10^2 * (Sc/600)^-0.5   (Ho et al. 2006)

##### consider whether a nonlinearity correction is necessary (Jiang et al. 2008)

# NDBC buoys:
  # 44008: data for May & October 2021
  # 44011: data for October 2021
  # 44024: data for October 2021

# cruise dates = Oct 4-10, 2021; middle is Oct 7
# Oct 7 minus 15 = Sep 22
# Oct 7 plus 15 = Oct 22

octBuoy <- read.table("./data/winds/44008h2021.txt", header = TRUE) %>%
  filter(!row_number() %in% c(1)) %>%   # remove row containing units
  lapply(function(x) as.numeric(x)) %>%
  as.data.frame() %>%
  filter(MM == 09 & DD >= 22 | MM == 10 & DD <= 22)
  #%>%
  #mutate(WSPD10 = WSPD * (10/4.1)^1/7)   # buoy 44008 anemometer height 4.1m

U <- mean(octBuoy$WSPD)   # m/s
U10 <- U * log(10/0.0002) / log(4.1/0.0002)   # m/s
# 0.0002 is "roughness length" (z0) for water surface

oct$k <- NA   # gas transfer velocity (cm/hr)

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
    # Wanninkhof 2014
    oct$k[i] = 0.251 * U10^2 * (oct$Sc[i]/660)^-0.5
    # Ho et al. 2006
    #oct$k2[i] = 0.266 * U10^2 * (oct$Sc[i]/600)^-0.5
  }
}

# which(abs(oct$k - oct$k2) > 0.11) # all w/in 0.11 of each other

####################

# ln(beta) = Α1 + Α2(100/Τ) + A3ln(T/100) + S[(B1 + B2(T/100) + B3(T/100)^2]
  # beta = K' (mol/L*atm) from Weiss 1974
  # T in K
  # S in ppt (PSU)

A1 = -58.0931
A2 = 90.5069
A3 = 22.2940
B1 = 0.027766
B2 = -0.025888
B3 = 0.0050578

oct$K.prime <- NA
oct$pH2O <- NA   # seawater vapor pressure

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
    T = oct$Temp[i] + 273.15
    S = oct$Salinity[i]
    oct$K.prime[i] = exp(A1 + A2*(100/T) + A3*log(T/100) + S*(B1 + B2*(T/100) + B3*(T/100)^2))
    # partial pressure of H2O right above the sea surface
    oct$pH2O[i] = vapress(oct$Salinity[i], oct$Temp[i], form = "d2007")   # atm
  }
}

# K' ≈ K0 * f/(X(P – PH2O))
  # K' in mol/L*atm
  # f: fugacity
  # X: mole fraction (dry)
  # P: total pressure
  # pH2O: seawater vapor pressure

P <- mean(octBuoy$PRES) / 1013.25   # hPa to atm
oct$xCO2 <- NA
oct$K0 <- NA

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
    oct$xCO2[i] = p2xCO2(oct$Salinity[i], oct$Temp[i], Patm = P, oct$pCO2[i])   # ppm
    oct$K0[i] = oct$K.prime[i] * oct$xCO2[i] * (P - oct$pH2O[i]) / oct$fCO2[i]
  }
}

# F = k*K0(pCO2w – pCO2a)

oct$flux <- NA
pCO2a <- 420 # update w/ data from CCGG database

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
    k = oct$k[i] / 100 * 24         # cm/hr --> m/d
    K0 = oct$K0[i] * 10^6 * 10^3 / 10^6    # mol/(L*atm) --> umol/(m^3*uatm)
    d.pCO2 = oct$pCO2[i] - pCO2a    # uatm
    oct$flux[i] = k * K0 * d.pCO2   # umol/(m^2*d)
  }
}
```

## Flux & concentration prop-prop plots
```{r}
oct %>%
  filter(Cast == "Surface") %>%
  ggplot(aes(x = pCO2, y = flux)) +
  geom_point(aes(shape = Cast)) +
  geom_vline(xintercept = 420, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(16)) +
  theme_bw()
```

## Calculate deltaConcentration
```{r}
# umol/(m^2*d) * 1/[MLD]m * m^3/[rho]kg * [res.time]days = umol/kg

##### ***add MLDs
octResTime <- 60   # going with 60 across the board for now

for(i in 1:nrow(oct)) {
  if(oct$Cast[i] == "Surface") {
    oct$dC[i] = oct$flux[i] / oct$MLD[i] / oct$Density[i] * octResTime
  }
}

```











## Convert AOU to DIC & TA signals --- NOT USING; FOUND BETTER METHOD
```{r}
# AOU umol/kg * 106 (DIC) / 138 (O2) = prod/resp DIC signal
oct$prDIC <- oct$AOU * 106 / 138

# AOU umol/kg * 17 (TA) / 138 (O2) = prod/resp TA signal
oct$prTA <- oct$AOU * 17 / 138
```

## Calculate "other" components of DIC & TA
```{r}
# DIC = DICn + prDIC + fDIC + other
# other = DIC - DICn - prDIC - fDIC
# other = DIC - DICn - prDIC (leaving out flux for bottom for now)

oct$DIC.other <- oct$DIC - oct$DICn - oct$prDIC

# TA = TAn + prTA + other
# other = TA - TAn - prTA

oct$TA.other = oct$TA - oct$TAn - oct$prTA

oct %>%
  filter(Cast == "Bottom") %>%
  ggplot(aes(x = DIC.other, y = TA.other)) +
  geom_point(aes(shape = Cast)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_abline(intercept = 0, slope = 2) +
  geom_abline(intercept = 0, slope = -17/106) +
  scale_shape_manual(values = c(16, 1)) +
  theme_bw()
```




## Solve system to find mixing-normalized coefficients
```{r}
i = 1

### SURFACE

### a1*S1 + a2*S2 + a3*S3 = oct$Salinity[i]
# a1 = (oct$Salinity[i] - (a2*S2 + a3*S3)) / S1
# 1 - (a2 + a3) = (oct$Salinity[i] - (a2*S2 + a3*S3)) / S1
# S1 - a2*S1 - a3*S1 = oct$Salinity[i] - a2*S2 - a3*S3
# a2*(S2-S1) + a3*(S3-S1) = oct$Salinity[i] - S1
# (oct$Temp[i] - T1 - a3*(T3-T1)) / (T2-T1) * (S2-S1) + a3*(S3-S1) = oct$Salinity[i] - S1
# a3*(S3-S1) - a3*(T3-T1)*(S2-S1)/(T2-T1) = oct$Salinity[i] - S1 - oct$Temp[i]*(S2-S1)/(T2-T1) + T1*(S2-S1)/(T2-T1)
a3 = (oct$Salinity[i] - S1 - oct$Temp[i]*(S2-S1)/(T2-T1) + T1*(S2-S1)/(T2-T1)) / ((S3-S1) - (T3-T1)*(S2-S1)/(T2-T1))

### a1*T1 + a2*T2 + a3*T3 = oct$Temp[i]
# a1 = (oct$Temp[i] - (a2*T2 + a3*T3)) / T1
# 1 - (a2 + a3) = (oct$Temp[i] - (a2*T2 + a3*T3)) / T1
# T1 - a2*T1 - a3*T1 = oct$Temp[i] - a2*T2 - a3*T3
# a2*(T2-T1) + a3*(T3-T1) = oct$Temp[i] - T1
a2 = (oct$Temp[i] - T1 - a3*(T3-T1)) / (T2-T1)

### a1 + a2 + a3 = 1
a1 = 1 - (a2 + a3)

### BOTTOM

a6 = (oct$Salinity[i] - S4 - oct$Temp[i]*(S5-S4)/(T5-T4) + T4*(S5-S4)/(T5-T4)) / ((S6-S4) - (T6-T4)*(S5-S4)/(T5-T4))

a5 = (oct$Temp[i] - T4 - a6*(T6-T4)) / (T5-T4)

a4 = 1 - (a5 + a6)
```
